{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}Сводка метрик{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label='main' %}">Main</a>
&rsaquo; Сводка метрик
</div>
{% endblock %}

{% block content %}
<h1>Сводка метрик за последние {{ period.days }} дней</h1>

<div style="margin: 20px 0;">
    <form method="get" style="display: inline-block;">
        <label>Период: </label>
        <select name="days" onchange="this.form.submit()">
            <option value="1" {% if period.days == 1 %}selected{% endif %}>1 день</option>
            <option value="7" {% if period.days == 7 %}selected{% endif %}>7 дней</option>
            <option value="30" {% if period.days == 30 %}selected{% endif %}>30 дней</option>
            <option value="90" {% if period.days == 90 %}selected{% endif %}>90 дней</option>
        </select>
        <span style="margin-left: 10px; color: #666;">
            {{ period.start|date:"d.m.Y H:i" }} - {{ period.end|date:"d.m.Y H:i" }}
        </span>
    </form>
</div>

<!-- Общая статистика -->
<div style="background: #f5f5f5; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <h2 style="margin-top: 0;">Общая статистика</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="background: white; padding: 15px; border-radius: 5px;">
            <div style="font-size: 24px; font-weight: bold; color: #2196F3;">{{ statistics.total_requests }}</div>
            <div style="color: #666;">Всего запросов</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 5px;">
            <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">{{ statistics.completed_requests }}</div>
            <div style="color: #666;">Успешных</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 5px;">
            <div style="font-size: 24px; font-weight: bold; color: #F44336;">{{ statistics.failed_requests }}</div>
            <div style="color: #666;">Ошибок</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 5px;">
            <div style="font-size: 24px; font-weight: bold; color: #FF9800;">{{ statistics.success_rate|floatformat:1 }}%</div>
            <div style="color: #666;">Успешность</div>
        </div>
    </div>
</div>

<!-- Метрики по категориям -->
{% for category_code, category_data in summary.items %}
<div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 20px; margin-bottom: 20px;">
    <h2 style="margin-top: 0; color: #333;">{{ category_data.name }}</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f9f9f9;">
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Метрика</th>
                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">Значение</th>
                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">Цель</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Статус</th>
                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">Выборка</th>
            </tr>
        </thead>
        <tbody>
            {% for metric in category_data.metrics %}
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">{{ metric.name }}</td>
                <td style="padding: 10px; text-align: right; font-weight: bold;">
                    {% if metric.unit == 'percent' %}
                        {{ metric.value|floatformat:2 }}%
                    {% elif metric.unit == 'seconds' %}
                        {{ metric.value|floatformat:2 }} сек
                    {% elif metric.unit == 'requests_per_user' %}
                        {{ metric.value|floatformat:2 }}
                    {% else %}
                        {{ metric.value|floatformat:2 }} {{ metric.unit }}
                    {% endif %}
                </td>
                <td style="padding: 10px; text-align: right; color: #666;">
                    {% if metric.target_value %}
                        {% if metric.unit == 'percent' %}
                            {{ metric.target_value|floatformat:2 }}%
                        {% elif metric.unit == 'seconds' %}
                            {{ metric.target_value|floatformat:2 }} сек
                        {% else %}
                            {{ metric.target_value|floatformat:2 }}
                        {% endif %}
                    {% else %}
                        <span style="color: #999;">—</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; text-align: center;">
                    {% if metric.is_target_met == True %}
                        <span style="background: #4CAF50; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px;">✓ ДА</span>
                    {% elif metric.is_target_met == False %}
                        <span style="background: #F44336; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px;">✗ НЕТ</span>
                    {% else %}
                        <span style="color: #999;">—</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; text-align: right; color: #666;">{{ metric.sample_size }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% empty %}
<div style="background: #fff3cd; padding: 20px; border-radius: 5px; border: 1px solid #ffc107;">
    <p style="margin: 0;">Метрики за выбранный период не найдены. Попробуйте выбрать другой период или <a href="{% url 'admin:main_metrics_summary' %}?days=7&calculate=1">рассчитать метрики</a>.</p>
</div>
{% endfor %}

<div style="margin-top: 30px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
    <p style="margin: 0;">
        <strong>Примечание:</strong> Метрики автоматически рассчитываются при загрузке страницы, если их еще нет за выбранный период.
        Для ручного расчета используйте API: <code>/api/metrics/calculate/</code>
    </p>
</div>
{% endblock %}

