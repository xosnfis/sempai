{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è - –ê–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ cache_version }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="cabinet-page">
    <!-- Header -->
    <header class="cabinet-header">
        <div class="cabinet-header-top">
            <div class="cabinet-logo-section">
                <h1 class="cabinet-logo">
                    <span class="cabinet-logo-red">–ê</span>–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
                </h1>
                <p class="cabinet-subtitle">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="cabinet-main">
        <div class="cabinet-container">
            <div class="inventory-container">
                <div class="inventory-header">
                    <a href="{% url 'cabinet' %}" class="inventory-back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                </div>

                <!-- Add Item Section -->
                <div class="inventory-add-section">
                    <h2 class="inventory-section-title">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
                    <form class="inventory-add-form" id="addItemForm">
                        <div class="inventory-form-row">
                            <div class="inventory-form-group">
                                <label for="itemName" class="inventory-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                <input type="text" id="itemName" class="inventory-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
                            </div>
                            <div class="inventory-form-group">
                                <label for="itemQuantity" class="inventory-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                <input type="number" id="itemQuantity" class="inventory-input" placeholder="0" min="0" step="1" required>
                            </div>
                            <div class="inventory-form-group">
                                <label for="itemPrice" class="inventory-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
                                <input type="number" id="itemPrice" class="inventory-input" placeholder="0.00" min="0" step="0.01" required>
                            </div>
                            <div class="inventory-form-group">
                                <label for="itemFolder" class="inventory-label">–ü–∞–ø–∫–∞</label>
                                <select id="itemFolder" class="inventory-select">
                                    <option value="">–ë–µ–∑ –ø–∞–ø–∫–∏</option>
                                </select>
                            </div>
                        </div>
                        <div class="inventory-form-actions">
                            <button type="submit" class="inventory-add-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </form>
                </div>

                <!-- Folders and Items Section -->
                <div class="inventory-list-section">
                    <div class="inventory-list-header">
                        <h2 class="inventory-section-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
                        <button class="inventory-add-folder-btn" onclick="openFolderModal()">+ –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
                    </div>
                    <div class="inventory-list" id="inventoryList">
                        <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    <div class="inventory-empty" id="inventoryEmpty" style="display: none;">
                        <p>–ù–µ—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Folder Modal -->
    <div class="inventory-folder-modal" id="folderModal" style="display: none;">
        <div class="inventory-folder-modal-content">
            <div class="inventory-folder-modal-header">
                <h3 class="inventory-folder-modal-title">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</h3>
                <button class="inventory-folder-modal-close" onclick="closeFolderModal()">√ó</button>
            </div>
            <form class="inventory-folder-modal-form" id="folderForm">
                <div class="inventory-folder-form-group">
                    <label for="folderName" class="inventory-folder-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏</label>
                    <input type="text" id="folderName" class="inventory-folder-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏" required>
                </div>
                <div class="inventory-folder-form-actions">
                    <button type="button" class="inventory-folder-btn inventory-folder-btn-cancel" onclick="closeFolderModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="inventory-folder-btn inventory-folder-btn-save">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div class="inventory-edit-modal" id="editItemModal" style="display: none;">
        <div class="inventory-edit-modal-content">
            <div class="inventory-edit-modal-header">
                <h3 class="inventory-edit-modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
                <button class="inventory-edit-modal-close" onclick="closeEditItemModal()">√ó</button>
            </div>
            <form class="inventory-edit-modal-form" id="editItemForm">
                <div class="inventory-edit-form-group">
                    <label for="editItemName" class="inventory-edit-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="editItemName" class="inventory-edit-input" required>
                </div>
                <div class="inventory-edit-form-group">
                    <label for="editItemQuantity" class="inventory-edit-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="editItemQuantity" class="inventory-edit-input" min="0" step="1" required>
                </div>
                <div class="inventory-edit-form-group">
                    <label for="editItemPrice" class="inventory-edit-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
                    <input type="number" id="editItemPrice" class="inventory-edit-input" min="0" step="0.01" required>
                </div>
                <div class="inventory-edit-form-group">
                    <label for="editItemFolder" class="inventory-edit-label">–ü–∞–ø–∫–∞</label>
                    <select id="editItemFolder" class="inventory-edit-select">
                        <option value="">–ë–µ–∑ –ø–∞–ø–∫–∏</option>
                    </select>
                </div>
                <div class="inventory-edit-form-actions">
                    <button type="button" class="inventory-edit-btn inventory-edit-btn-cancel" onclick="closeEditItemModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="inventory-edit-btn inventory-edit-btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // –ü—É—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
        const INVENTORY_IMAGE_PATHS = {
            red: "{% static 'images/red.svg' %}",
            udalit: "{% static 'images/udalit.png' %}"
        };
        
        let inventory = [];
        let folders = [];
        let editingItemId = null;

        // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserInventory() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `inventory_${email}`;
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : [];
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserInventory(inventoryArray) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `inventory_${email}`;
            localStorage.setItem(key, JSON.stringify(inventoryArray));
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å –ø–∞–ø–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserInventoryFolders() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `inventoryFolders_${email}`;
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : [];
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–ø–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserInventoryFolders(foldersArray) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `inventoryFolders_${email}`;
            localStorage.setItem(key, JSON.stringify(foldersArray));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadData() {
            inventory = getUserInventory();
            folders = getUserInventoryFolders();
            updateFolderSelects();
            renderInventory();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveData() {
            saveUserInventory(inventory);
            saveUserInventoryFolders(folders);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø–∞–ø–æ–∫ –≤ select
        function updateFolderSelects() {
            const selects = document.querySelectorAll('#itemFolder, #editItemFolder');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">–ë–µ–∑ –ø–∞–ø–∫–∏</option>';
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞
        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        function calculateTotalCost(items) {
            return items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function renderInventory() {
            const list = document.getElementById('inventoryList');
            const empty = document.getElementById('inventoryEmpty');
            list.innerHTML = '';

            // –†–∞–∑–¥–µ–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ –ø–∞–ø–∫–∞–º
            const itemsByFolder = {};
            const itemsWithoutFolder = [];

            inventory.forEach(item => {
                if (item.folderId) {
                    if (!itemsByFolder[item.folderId]) {
                        itemsByFolder[item.folderId] = [];
                    }
                    itemsByFolder[item.folderId].push(item);
                } else {
                    itemsWithoutFolder.push(item);
                }
            });

            if (inventory.length === 0 && folders.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
            } else {
                list.style.display = 'block';
                empty.style.display = 'none';

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–∞–ø–∫–∏
                folders.forEach(folder => {
                    const folderItems = itemsByFolder[folder.id] || [];
                    const folderElement = createFolderElement(folder, folderItems);
                    list.appendChild(folderElement);
                });

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ –ø–∞–ø–∫–∏
                if (itemsWithoutFolder.length > 0) {
                    itemsWithoutFolder.forEach(item => {
                        const itemElement = createItemElement(item);
                        list.appendChild(itemElement);
                    });
                }
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–∞–ø–∫–∏
        function createFolderElement(folder, items) {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'inventory-folder';
            folderDiv.dataset.folderId = folder.id;

            const totalCost = calculateTotalCost(items);
            const totalQuantity = items.reduce((sum, item) => sum + item.quantity, 0);
            const itemsCount = items.length;

            folderDiv.innerHTML = `
                <div class="inventory-folder-header">
                    <div class="inventory-folder-header-left" onclick="toggleFolder('${folder.id}')">
                        <div class="inventory-folder-info">
                            <span class="inventory-folder-icon">üìÅ</span>
                            <span class="inventory-folder-name">${folder.name}</span>
                            <span class="inventory-folder-count">(${itemsCount} ${itemsCount === 1 ? '—ç–ª–µ–º–µ–Ω—Ç' : itemsCount === 0 ? '–ø—É—Å—Ç–æ' : '—ç–ª–µ–º–µ–Ω—Ç–æ–≤'})</span>
                        </div>
                        <div class="inventory-folder-stats">
                            ${itemsCount > 0 ? `
                                <span class="inventory-folder-total">–í—Å–µ–≥–æ: ${formatNumber(totalCost)} ‚ÇΩ</span>
                                <span class="inventory-folder-quantity">–ö–æ–ª-–≤–æ: ${totalQuantity}</span>
                            ` : '<span class="inventory-folder-empty">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</span>'}
                            <span class="inventory-folder-toggle">‚ñº</span>
                        </div>
                    </div>
                    <button class="inventory-folder-delete-btn" onclick="event.stopPropagation(); deleteFolder('${folder.id}')" title="–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É">√ó</button>
                </div>
                <div class="inventory-folder-content" id="folderContent-${folder.id}" style="display: ${itemsCount > 0 ? 'none' : 'block'};">
                    ${itemsCount > 0 ? items.map(item => createItemHTML(item)).join('') : '<div class="inventory-folder-empty-message">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</div>'}
                </div>
            `;

            return folderDiv;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ HTML —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function createItemHTML(item) {
            const totalCost = item.quantity * item.price;
            return `
                <div class="inventory-item" data-item-id="${item.id}">
                    <div class="inventory-item-content">
                        <div class="inventory-item-name">${item.name}</div>
                        <div class="inventory-item-details">
                            <span class="inventory-item-quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}</span>
                            <span class="inventory-item-price">–¶–µ–Ω–∞: ${formatNumber(item.price)} ‚ÇΩ</span>
                            <span class="inventory-item-total">–ò—Ç–æ–≥–æ: ${formatNumber(totalCost)} ‚ÇΩ</span>
                        </div>
                    </div>
                    <div class="inventory-item-actions">
                        <select class="inventory-item-move-select" onchange="moveItem('${item.id}', this.value)">
                            <option value="">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤...</option>
                            ${folders.map(folder => `<option value="${folder.id}" ${item.folderId === folder.id ? 'selected' : ''}>${folder.name}</option>`).join('')}
                            <option value="remove">–£–±—Ä–∞—Ç—å –∏–∑ –ø–∞–ø–∫–∏</option>
                        </select>
                        <button class="inventory-item-edit-btn" onclick="openEditItemModal('${item.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </button>
                        <button class="inventory-item-delete-btn" onclick="deleteItem('${item.id}')" title="–£–¥–∞–ª–∏—Ç—å">
                            ‚ùå
                        </button>
                    </div>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è (–¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–µ–∑ –ø–∞–ø–∫–∏)
        function createItemElement(item) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'inventory-item';
            itemDiv.dataset.itemId = item.id;
            itemDiv.innerHTML = createItemHTML(item);
            return itemDiv;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–ø–∫–∏ (—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ)
        function toggleFolder(folderId) {
            const content = document.getElementById(`folderContent-${folderId}`);
            const folderElement = document.querySelector(`[data-folder-id="${folderId}"]`);
            const toggle = folderElement.querySelector('.inventory-folder-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –ø–∞–ø–∫—É
        function moveItem(itemId, folderId) {
            const item = inventory.find(i => i.id.toString() === itemId);
            if (item) {
                if (folderId === 'remove') {
                    item.folderId = null;
                } else if (folderId) {
                    item.folderId = folderId;
                }
                saveData();
                renderInventory();
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏
        function openFolderModal() {
            document.getElementById('folderModal').style.display = 'flex';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏
        function closeFolderModal() {
            document.getElementById('folderModal').style.display = 'none';
            document.getElementById('folderForm').reset();
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function openEditItemModal(itemId) {
            editingItemId = itemId;
            const item = inventory.find(i => i.id.toString() === itemId);
            if (item) {
                document.getElementById('editItemName').value = item.name;
                document.getElementById('editItemQuantity').value = item.quantity;
                document.getElementById('editItemPrice').value = item.price;
                document.getElementById('editItemFolder').value = item.folderId || '';
                document.getElementById('editItemModal').style.display = 'flex';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function closeEditItemModal() {
            document.getElementById('editItemModal').style.display = 'none';
            editingItemId = null;
            document.getElementById('editItemForm').reset();
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            messageEl.textContent = message;
            modal.style.display = 'flex';
            
            document.getElementById('confirmYes').onclick = function() {
                modal.style.display = 'none';
                onConfirm();
            };
            
            document.getElementById('confirmNo').onclick = function() {
                modal.style.display = 'none';
            };
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
        function deleteItem(itemId) {
            showConfirmModal('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?', function() {
                inventory = inventory.filter(i => i.id.toString() !== itemId);
                saveData();
                renderInventory();
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏
        function deleteFolder(folderId) {
            const folder = folders.find(f => f.id.toString() === folderId);
            if (!folder) return;

            const folderItems = inventory.filter(i => i.folderId && i.folderId.toString() === folderId);
            let message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "${folder.name}"?`;
            if (folderItems.length > 0) {
                message += `\n\n–í –ø–∞–ø–∫–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è ${folderItems.length} ${folderItems.length === 1 ? '—ç–ª–µ–º–µ–Ω—Ç' : '—ç–ª–µ–º–µ–Ω—Ç–æ–≤'}. –û–Ω–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ "–ë–µ–∑ –ø–∞–ø–∫–∏".`;
            }

            showConfirmModal(message, function() {
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –ø–∞–ø–∫–∏ –≤ "–±–µ–∑ –ø–∞–ø–∫–∏"
                inventory.forEach(item => {
                    if (item.folderId && item.folderId.toString() === folderId) {
                        item.folderId = null;
                    }
                });
                // –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É
                folders = folders.filter(f => f.id.toString() !== folderId);
                saveData();
                updateFolderSelects();
                renderInventory();
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('addItemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseFloat(document.getElementById('itemQuantity').value);
            const price = parseFloat(document.getElementById('itemPrice').value);
            const folderId = document.getElementById('itemFolder').value || null;

            if (name && quantity >= 0 && price >= 0) {
                inventory.push({
                    id: Date.now() + Math.random(),
                    name: name,
                    quantity: quantity,
                    price: price,
                    folderId: folderId
                });
                saveData();
                renderInventory();
                this.reset();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏
        document.getElementById('folderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('folderName').value.trim();
            if (name) {
                folders.push({
                    id: Date.now() + Math.random(),
                    name: name
                });
                saveData();
                updateFolderSelects();
                renderInventory();
                closeFolderModal();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('editItemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (editingItemId) {
                const item = inventory.find(i => i.id.toString() === editingItemId);
                if (item) {
                    item.name = document.getElementById('editItemName').value.trim();
                    item.quantity = parseFloat(document.getElementById('editItemQuantity').value);
                    item.price = parseFloat(document.getElementById('editItemPrice').value);
                    const folderId = document.getElementById('editItemFolder').value;
                    item.folderId = folderId || null;
                    saveData();
                    renderInventory();
                    closeEditItemModal();
                }
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadData();
    </script>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal" style="display: none;">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 class="confirm-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            </div>
            <div class="confirm-modal-body">
                <p class="confirm-message" id="confirmMessage"></p>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-btn-cancel" id="confirmNo">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirmYes">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.documentElement.classList.add('dark-theme');
            }
        })();
    </script>
</body>
</html>

