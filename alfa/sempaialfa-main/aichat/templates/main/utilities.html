{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Коммунальные услуги - Альфа-Ассистент</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ cache_version }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Система модальных окон -->
    <script src="{% static 'js/modal.js' %}?v={{ cache_version }}"></script>
</head>
<body class="cabinet-page">
    <!-- Header -->
    <header class="cabinet-header">
        <div class="cabinet-header-top">
            <div class="cabinet-logo-section">
                <h1 class="cabinet-logo">
                    <span class="cabinet-logo-red">А</span>льфа-Ассистент
                </h1>
                <p class="cabinet-subtitle">Коммунальные услуги</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="cabinet-main">
        <div class="cabinet-container">
            <div class="utilities-container">
                <div class="utilities-header">
                    <a href="{% url 'cabinet' %}" class="utilities-back-link">← Назад в личный кабинет</a>
                </div>

                <!-- Total Debt Display -->
                <div class="utilities-total-debt">
                    <div class="utilities-total-label">Общая задолженность</div>
                    <div class="utilities-total-amount" id="totalDebt">0 ₽</div>
                    <div class="utilities-penalty-info" id="penaltyInfo" style="display: none;">
                        <span class="utilities-penalty-text">+ штраф за просрочку: <span id="penaltyAmount">0 ₽</span></span>
                    </div>
                </div>

                <!-- Utilities List -->
                <div class="utilities-list" id="utilitiesList">
                    <!-- Utilities will be added via JavaScript -->
                </div>

                <!-- Pay All Button -->
                <div class="utilities-actions">
                    <button class="utilities-pay-all-btn" id="payAllBtn" onclick="payAll()" disabled>Оплатить все</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const utilities = [
            { id: 'electricity', name: 'Электричество', basePrice: 5000 },
            { id: 'water', name: 'Водоснабжение', basePrice: 3000 },
            { id: 'heating', name: 'Отопление', basePrice: 8000 },
            { id: 'waste', name: 'Вывоз ТКО', basePrice: 2000 },
            { id: 'security', name: 'Охранные услуги и видеонаблюдение', basePrice: 6000 },
            { id: 'internet', name: 'Интернет', basePrice: 1500 }
        ];

        const PENALTY_RATE = 0.15; // 15% за просрочку

        function getUtilitiesData() {
            const saved = localStorage.getItem('utilitiesData');
            if (saved) {
                return JSON.parse(saved);
            }
            // Инициализация с текущей датой
            const data = {};
            utilities.forEach(util => {
                data[util.id] = {
                    debt: util.basePrice,
                    lastUpdate: Date.now(),
                    lastPayment: null
                };
            });
            localStorage.setItem('utilitiesData', JSON.stringify(data));
            return data;
        }

        function saveUtilitiesData(data) {
            localStorage.setItem('utilitiesData', JSON.stringify(data));
        }

        function calculateDailyIncrease() {
            // Случайное увеличение от 10 до 30 рублей
            return Math.floor(Math.random() * 21) + 10;
        }

        function updateUtilities() {
            const data = getUtilitiesData();
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;

            utilities.forEach(util => {
                const utilData = data[util.id];
                const daysSinceUpdate = Math.floor((now - utilData.lastUpdate) / oneDay);

                if (daysSinceUpdate > 0) {
                    // Увеличиваем долг на случайную сумму за каждый день
                    for (let i = 0; i < daysSinceUpdate; i++) {
                        utilData.debt += calculateDailyIncrease();
                    }
                    utilData.lastUpdate = now;
                }
            });

            saveUtilitiesData(data);
            return data;
        }

        function calculatePenalty(debt, daysOverdue) {
            if (daysOverdue <= 0) return 0;
            return debt * PENALTY_RATE * daysOverdue;
        }

        function formatAmount(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(amount));
        }

        function getTimeUntilNextCharge(lastUpdate) {
            const now = new Date();
            const nextDay = new Date(now);
            nextDay.setDate(nextDay.getDate() + 1);
            nextDay.setHours(0, 0, 0, 0); // Следующий день в 00:00
            
            const timeLeft = nextDay.getTime() - now.getTime();
            return Math.max(0, timeLeft);
        }

        function formatTime(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderUtilities() {
            const data = updateUtilities();
            const list = document.getElementById('utilitiesList');
            list.innerHTML = '';

            let totalDebt = 0;
            let totalPenalty = 0;
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            const paymentDeadline = 30 * oneDay; // 30 дней на оплату

            utilities.forEach(util => {
                const utilData = data[util.id];
                const daysSincePayment = utilData.lastPayment ? 
                    Math.floor((now - utilData.lastPayment) / oneDay) : 
                    Math.floor((now - utilData.lastUpdate) / oneDay);
                const daysOverdue = Math.max(0, daysSincePayment - 30);
                const penalty = calculatePenalty(utilData.debt, daysOverdue);
                const timeUntilNext = getTimeUntilNextCharge(utilData.lastUpdate);

                totalDebt += utilData.debt;
                totalPenalty += penalty;

                const item = document.createElement('div');
                item.className = 'utility-item';
                item.id = `utility-${util.id}`;
                item.innerHTML = `
                    <div class="utility-item-content">
                        <div class="utility-item-name">${util.name}</div>
                        <div class="utility-item-debt">
                            <span class="utility-debt-label">Долг:</span>
                            <span class="utility-debt-amount">${formatAmount(utilData.debt)} ₽</span>
                        </div>
                        <div class="utility-item-timer">
                            <span class="utility-timer-label">До следующего начисления:</span>
                            <span class="utility-timer-value" id="timer-${util.id}">${formatTime(timeUntilNext)}</span>
                        </div>
                        ${daysOverdue > 0 ? `
                            <div class="utility-item-penalty">
                                <span class="utility-penalty-label">Штраф (${daysOverdue} дн. просрочки):</span>
                                <span class="utility-penalty-amount">+${formatAmount(penalty)} ₽</span>
                            </div>
                        ` : ''}
                        <div class="utility-item-actions">
                            <button class="utility-pay-btn" onclick="payUtility('${util.id}')">Оплатить</button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });

            // Обновляем общую сумму
            document.getElementById('totalDebt').textContent = formatAmount(totalDebt) + ' ₽';
            
            if (totalPenalty > 0) {
                document.getElementById('penaltyInfo').style.display = 'block';
                document.getElementById('penaltyAmount').textContent = formatAmount(totalPenalty) + ' ₽';
            } else {
                document.getElementById('penaltyInfo').style.display = 'none';
            }

            // Активируем кнопку "Оплатить все"
            document.getElementById('payAllBtn').disabled = totalDebt === 0;
        }

        function payUtility(utilId) {
            const data = getUtilitiesData();
            const utilData = data[utilId];
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            const daysSincePayment = utilData.lastPayment ? 
                Math.floor((now - utilData.lastPayment) / oneDay) : 
                Math.floor((now - utilData.lastUpdate) / oneDay);
            const daysOverdue = Math.max(0, daysSincePayment - 30);
            const penalty = calculatePenalty(utilData.debt, daysOverdue);
            const totalAmount = utilData.debt + penalty;

            // Показ модального окна подтверждения
            showConfirmModal(`Вы уверены, что хотите оплатить ${utilities.find(u => u.id === utilId).name}?\nСумма: ${formatAmount(totalAmount)} ₽`, function() {
                // Получаем текущий выбранный счет
                const accountNum = parseInt(localStorage.getItem('currentAccount') || '1');
                const key = accountNum === 1 ? 'accountBalance' : 'accountBalance2';
                const balance = parseFloat(localStorage.getItem(key) || (accountNum === 1 ? 237000 : 50000));
                
                if (balance < totalAmount) {
                    showWarning('Недостаточно средств на счете');
                    return;
                }

                // Списываем с баланса
                const newBalance = balance - totalAmount;
                localStorage.setItem(key, newBalance.toString());

                // Обнуляем долг
                utilData.debt = 0;
                utilData.lastPayment = now;
                utilData.lastUpdate = now;

                saveUtilitiesData(data);

                // Добавляем в чеки текущего пользователя
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                if (email) {
                    const key = `receipts_${email}`;
                    let receipts = JSON.parse(localStorage.getItem(key) || '[]');
                    receipts.push({
                        id: Date.now(),
                        accountNumber: 'Коммунальные услуги',
                        bank: 'Альфа',
                        operationType: 'Перевод',
                        amount: totalAmount,
                        balance: newBalance,
                        date: new Date().toLocaleString('ru-RU'),
                        description: utilities.find(u => u.id === utilId).name
                    });
                    localStorage.setItem(key, JSON.stringify(receipts));
                }

                // Обновляем балансы и задолженность в кабинете, если он открыт
                if (window.opener) {
                    window.opener.updateBalances();
                    window.opener.updateTotalDebt();
                }

                showSuccess('Оплата выполнена успешно!');
                renderUtilities();
            });
        }

        // Показ модального окна подтверждения
        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            messageEl.textContent = message;
            modal.style.display = 'flex';
            
            document.getElementById('confirmYes').onclick = function() {
                modal.style.display = 'none';
                onConfirm();
            };
            
            document.getElementById('confirmNo').onclick = function() {
                modal.style.display = 'none';
            };
        }

        function payAll() {
            const data = getUtilitiesData();
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            let totalAmount = 0;

            utilities.forEach(util => {
                const utilData = data[util.id];
                const daysSincePayment = utilData.lastPayment ? 
                    Math.floor((now - utilData.lastPayment) / oneDay) : 
                    Math.floor((now - utilData.lastUpdate) / oneDay);
                const daysOverdue = Math.max(0, daysSincePayment - 30);
                const penalty = calculatePenalty(utilData.debt, daysOverdue);
                totalAmount += utilData.debt + penalty;
            });

            if (totalAmount === 0) {
                showInfo('Нет задолженности');
                return;
            }

            showConfirmModal(`Вы уверены, что хотите оплатить все коммунальные услуги?\nОбщая сумма: ${formatAmount(totalAmount)} ₽`, function() {
                // Получаем текущий выбранный счет
                const accountNum = parseInt(localStorage.getItem('currentAccount') || '1');
                const key = accountNum === 1 ? 'accountBalance' : 'accountBalance2';
                const balance = parseFloat(localStorage.getItem(key) || (accountNum === 1 ? 237000 : 50000));
                
                if (balance < totalAmount) {
                    showWarning('Недостаточно средств на счете');
                    return;
                }

                const newBalance = balance - totalAmount;
                localStorage.setItem(key, newBalance.toString());

                // Обнуляем все долги
                utilities.forEach(util => {
                    data[util.id].debt = 0;
                    data[util.id].lastPayment = now;
                    data[util.id].lastUpdate = now;
                });

                saveUtilitiesData(data);

                // Добавляем в чеки текущего пользователя
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                if (email) {
                    const key = `receipts_${email}`;
                    let receipts = JSON.parse(localStorage.getItem(key) || '[]');
                    receipts.push({
                        id: Date.now(),
                        accountNumber: 'Коммунальные услуги',
                        bank: 'Альфа',
                        operationType: 'Перевод',
                        amount: totalAmount,
                        balance: newBalance,
                        date: new Date().toLocaleString('ru-RU'),
                        description: 'Оплата всех коммунальных услуг'
                    });
                    localStorage.setItem(key, JSON.stringify(receipts));
                }

                // Обновляем балансы и задолженность в кабинете, если он открыт
                if (window.opener) {
                    window.opener.updateBalances();
                    window.opener.updateTotalDebt();
                }

                showSuccess('Все услуги оплачены успешно!');
                renderUtilities();
            });
        }

        // Обновляем таймеры каждую секунду
        function updateTimers() {
            const data = getUtilitiesData();
            utilities.forEach(util => {
                const utilData = data[util.id];
                const timeUntilNext = getTimeUntilNextCharge(utilData.lastUpdate);
                const timerElement = document.getElementById(`timer-${util.id}`);
                if (timerElement) {
                    timerElement.textContent = formatTime(timeUntilNext);
                }
            });
        }

        // Обновляем каждую минуту
        renderUtilities();
        setInterval(renderUtilities, 60000);
        
        // Обновляем таймеры каждую секунду
        setInterval(updateTimers, 1000);
    </script>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal" style="display: none;">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 class="confirm-modal-title">Подтверждение</h3>
            </div>
            <div class="confirm-modal-body">
                <p class="confirm-message" id="confirmMessage"></p>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-btn-cancel" id="confirmNo">Отмена</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirmYes">Подтвердить</button>
            </div>
        </div>
    </div>
    
    <script>
        // Применение темы при загрузке страницы
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.documentElement.classList.add('dark-theme');
            }
        })();
    </script>
</body>
</html>

