# Инструкция по настройке системы метрик

## Шаг 1: Применение миграций

Выполните миграцию базы данных для создания новых таблиц:

```bash
cd sempaialfa-main/aichat
python manage.py migrate
```

Это создаст таблицы:
- `main_metric` - для хранения агрегированных метрик
- `main_chatrequestmetrics` - для хранения метрик конкретных запросов

## Шаг 2: Проверка работы

### Тест 1: Проверка API endpoints

1. Запустите сервер:
```bash
python manage.py runserver
```

2. Проверьте получение метрик:
```bash
# Получение сводки метрик
curl http://localhost:8000/api/metrics/summary/?days=7

# Получение всех метрик
curl http://localhost:8000/api/metrics/?days=7

# Расчет метрик
curl -X POST http://localhost:8000/api/metrics/calculate/ \
  -H "Content-Type: application/json" \
  -d '{"days": 7}'
```

### Тест 2: Создание тестового запроса

1. Откройте чат в браузере: `http://localhost:8000/chat/`
2. Отправьте несколько сообщений
3. Проверьте, что метрики создаются:
   - В админ-панели: `http://localhost:8000/admin/main/chatrequestmetrics/`
   - Через API: `http://localhost:8000/api/metrics/summary/?days=1`

## Шаг 3: Автоматический расчет метрик

Метрики автоматически рассчитываются при вызове `/api/metrics/summary/`, если их еще нет.

Для периодического расчета можно настроить cron или использовать Celery:

```python
# Пример для cron (каждый день в 00:00)
0 0 * * * cd /path/to/project/sempaialfa-main/aichat && python manage.py shell -c "from main.metrics_calculator import MetricsCalculator; from django.utils import timezone; from datetime import timedelta; period_end = timezone.now(); period_start = period_end - timedelta(days=7); MetricsCalculator.calculate_all_metrics(period_start, period_end)"
```

## Шаг 4: Просмотр метрик в админ-панели

1. Создайте суперпользователя (если еще не создан):
```bash
python manage.py createsuperuser
```

2. Войдите в админ-панель: `http://localhost:8000/admin/`

3. Просмотрите метрики:
   - Метрики: `/admin/main/metric/`
   - Метрики запросов: `/admin/main/chatrequestmetrics/`

## Что отслеживается автоматически

При каждом запросе к AI автоматически собираются:

1. **Временные метрики:**
   - Время обработки запроса
   - Время обработки LLM

2. **Метрики качества:**
   - Наличие действий в ответе
   - Успешность выполнения действий
   - Использование контекста пользователя
   - Длина ответа

3. **Метрики безопасности:**
   - Блокировка входящих сообщений
   - Блокировка ответов AI

4. **Метрики обработки файлов:**
   - Количество обработанных файлов
   - Количество неудачных обработок

5. **Метрики активности пользователей:**
   - Среднее количество запросов на пользователя
   - Процент пользователей, вернувшихся через 7 дней
   - Процент пользователей, вернувшихся через 30 дней

## Структура данных

### ChatRequestMetrics
Создается автоматически для каждого `ChatRequest` и содержит:
- Временные метрики обработки
- Информацию о действиях
- Статистику файлов
- Флаги модерации

### Metric
Создается при вызове `MetricsCalculator.calculate_all_metrics()` и содержит:
- Агрегированные значения за период
- Целевые значения
- Размер выборки
- Метаданные

## Устранение неполадок

### Проблема: Метрики не создаются

**Решение:**
1. Проверьте, что миграции применены: `python manage.py showmigrations`
2. Проверьте логи на наличие ошибок
3. Убедитесь, что запросы успешно обрабатываются

### Проблема: API возвращает пустые метрики

**Решение:**
1. Убедитесь, что есть обработанные запросы за указанный период
2. Вызовите `/api/metrics/calculate/` для расчета метрик
3. Проверьте, что запросы имеют статус `completed`

### Проблема: Ошибки при расчете метрик

**Решение:**
1. Проверьте логи Django
2. Убедитесь, что в базе есть данные за указанный период
3. Проверьте, что все зависимости установлены

## Метрики активности пользователей

### User Activity Rate
Показывает среднее количество запросов на одного пользователя за период.

**Пример использования:**
```bash
# Получить метрику активности пользователей
curl "http://localhost:8000/api/metrics/?days=30&metric=user_activity_rate"
```

**Интерпретация:**
- Высокое значение (> 10) - пользователи активно используют систему
- Низкое значение (< 3) - пользователи используют систему редко

### User Retention Rate
Показывает процент пользователей, которые вернулись к использованию системы через определенный период.

**Retention Rate 7 дней:**
- Рассчитывается для периодов ≥ 7 дней
- Показывает краткосрочное удержание пользователей
- Целевое значение: ≥ 60%

**Retention Rate 30 дней:**
- Рассчитывается для периодов ≥ 30 дней
- Показывает долгосрочное удержание пользователей
- Целевое значение: ≥ 40%

**Пример использования:**
```bash
# Получить метрики удержания за 30 дней
curl "http://localhost:8000/api/metrics/?days=30&category=user_engagement"
```

**Интерпретация:**
- Высокое значение (> 60% для 7 дней) - хорошее удержание пользователей
- Низкое значение (< 40% для 7 дней) - пользователи не возвращаются

## Дополнительная информация

Подробная документация по API и метрикам: см. `METRICS.md`

