# Альфа-Ассистент (Alfa Finansi)

ИИ-помощник для бизнеса на базе Django и Ollama. Веб-приложение предоставляет интеллектуального ассистента, который помогает управлять бизнесом, анализировать данные и выполнять различные задачи.

## Целевая аудитория

Альфа-Ассистент разработан для владельцев малого бизнеса, которые хотят оптимизировать управление своей компанией с помощью искусственного интеллекта. Приложение подходит для:

- **Предприниматели** - владельцы малого и среднего бизнеса, которые хотят автоматизировать рутинные задачи
- **Менеджеры** - руководители отделов, которым необходимо эффективно управлять сотрудниками, финансами и документами
- **Стартапы** - начинающие компании, нуждающиеся в комплексном решении для управления бизнес-процессами
- **Фрилансеры и самозанятые** - индивидуальные предприниматели, которые ведут собственный бизнес

Приложение особенно полезно для тех, кто:
- Хочет иметь единую платформу для управления всеми аспектами бизнеса
- Нуждается в быстром доступе к информации о финансах, сотрудниках и документах
- Ценит удобство и простоту использования
- Хочет использовать AI для анализа данных и принятия решений

## Возможности

### Основной функционал

- **AI-Чат** - интеллектуальный помощник с поддержкой анализа файлов и изображений
- **Документы** - безопасное хранение и управление документами
- **Календарь** - планирование встреч и событий с возможностью создания через AI
- **Перевод средств** - управление переводами между счетами
- **Чеки** - просмотр и анализ операций, расходов и доходов
- **Коммунальные услуги** - отслеживание задолженностей
- **Налоги** - контроль налоговых выплат
- **Инвентаризация** - управление товарами и складскими остатками
- **Сотрудники** - управление персоналом и фондом оплаты труда
- **Почта** - управление электронной почтой
- **Обратная связь** - система обратной связи
- **Поддержка** - раздел поддержки с FAQ
- **Система метрик** - отслеживание качества работы AI, производительности и активности пользователей
- **Админ-панель** - расширенная панель управления с кастомным дизайном и метриками

### Возможности AI-помощника

AI может:
- Анализировать чеки - просматривать операции, суммы, анализировать расходы
- Работать с инвентаризацией - просматривать товары, категории, количество
- Просматривать сотрудников - список, зарплаты, фонд оплаты труда
- Планировать встречи - создавать события в календаре по запросу
- Проверять задолженности - по налогам и коммунальным услугам
- Анализировать файлы - текстовые файлы, изображения, документы (PDF, DOCX, XLSX) из чата
- Знать балансы счетов - балансы обоих счетов пользователя
- Редактировать события - изменять название, дату и описание встреч

### Система метрик

Проект включает комплексную систему метрик для оценки качества работы AI:

- **Метрики качества** - точность ответов, релевантность, полнота
- **Метрики производительности** - время обработки, время ответа LLM, пропускная способность
- **Метрики надежности** - успешность запросов, частота ошибок, доступность
- **Метрики безопасности** - обнаружение вредоносного контента, блокировка нежелательных запросов
- **Метрики пользовательского опыта** - удовлетворенность, частота использования, вовлеченность
- **Метрики активности пользователей** - активность пользователей, удержание пользователей

Все метрики доступны через:
- Django админ-панель (`/admin/main/metric/`)
- API endpoints (`/api/metrics/`, `/api/metrics/summary/`)
- Автоматический расчет при обработке запросов

Подробнее см. [METRICS_SETUP.md](METRICS_SETUP.md)

### Админ-панель

Расширенная админ-панель Django с кастомным дизайном:

- **Кастомный дизайн** - темная тема с красными акцентами
- **Управление пользователями** - регистрация и управление пользователями через Django User модель
- **Просмотр метрик** - детальный просмотр всех метрик в удобном интерфейсе
- **Управление запросами** - просмотр и управление всеми запросами к AI
- **История чатов** - полная история всех чатов пользователей
- **Активность пользователей** - отслеживание действий пользователей
- **Вход через сайт** - администраторы могут входить в админ-панель через `/login/`

Доступ: `http://localhost:8000/admin/`

## Технологический стек

- **Backend**: Django 4.2.26
- **AI**: Ollama с моделью deepseek-r1
- **База данных**: PostgreSQL (в Docker) / SQLite (локально)
- **Обработка файлов**: PyPDF2, python-docx, openpyxl, pdfplumber, Pillow
- **Frontend**: HTML, CSS, JavaScript
- **Метрики**: Встроенная система расчета и агрегации метрик

## Требования

- Python 3.13+ (или 3.11+)
- Ollama (для работы AI-помощника)
- Docker и Docker Compose (опционально, для запуска через Docker)

## Быстрый старт

### 1. Установка Ollama

1. Скачайте и установите Ollama с официального сайта: https://ollama.ai/
2. Загрузите модель deepseek-r1:
   ```bash
   ollama pull deepseek-r1
   ```
3. Запустите Ollama сервер:
   ```bash
   ollama serve
   ```
   Сервер будет доступен на `http://localhost:11434` (по умолчанию)

### 2. Настройка виртуального окружения

```powershell
# Windows PowerShell
cd sempaialfa-main\aichat
python -m venv venv
.\venv\Scripts\Activate.ps1

# Если возникает ошибка Execution Policy:
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
.\venv\Scripts\Activate.ps1
```

### 3. Установка зависимостей

```powershell
# Из корня проекта sempaialfa-main
pip install -r requirements.txt
```

### 4. Настройка базы данных

```powershell
cd sempaialfa-main\aichat
python manage.py migrate
```

Это создаст все необходимые таблицы, включая:
- `main_metric` - агрегированные метрики
- `main_chatrequestmetrics` - метрики конкретных запросов
- `main_useractivity` - активность пользователей
- `main_chatrequest` - запросы к AI
- `main_chathistory` - история чатов

### 5. Создание суперпользователя

```powershell
python manage.py createsuperuser
```

**Важно**: Укажите email при создании суперпользователя, так как вход в админ-панель через сайт использует email для авторизации.

### 6. Сборка статических файлов

```powershell
python manage.py collectstatic --noinput
```

### 7. Запуск сервера разработки

```powershell
python manage.py runserver
```

Приложение будет доступно по адресу: `http://localhost:8000`

## Настройка Ollama для AI-помощника

### 1. Проверка подключения

URL для Ollama настроен в `aichat/aichat/settings.py`:

```python
OLLAMA_URL = 'http://host.docker.internal:9117/v1/chat/completions'
```

**Для локальной разработки** (без Docker) измените на:

```python
OLLAMA_URL = 'http://localhost:11434/v1/chat/completions'
```

### 2. Проверка подключения к Ollama

В проекте есть скрипт для проверки:

```powershell
cd sempaialfa-main\aichat
python check_lm_studio.py
```

Или через API:

```powershell
# Откройте в браузере или используйте curl
curl http://localhost:8000/api/check-lm-studio/
```

### 3. Настройка порта Ollama

Если Ollama работает на другом порту, измените настройку в `settings.py`:

```python
OLLAMA_URL = 'http://localhost:ВАШ_ПОРТ/v1/chat/completions'
```

## Запуск через Docker

### 1. Настройка переменных окружения (опционально)

Создайте файл `.env` в корне проекта (можно скопировать из `env.example`):

```bash
cp env.example .env
```

Отредактируйте `.env` и установите свои значения для базы данных и других настроек.

### 2. Сборка и запуск контейнеров

```bash
cd sempaialfa-main
docker-compose up --build
```

Или в фоновом режиме:

```bash
docker-compose up -d --build
```

Приложение будет доступно по адресу: `http://localhost:8000`

**Что происходит при запуске:**
- Создается контейнер PostgreSQL с базой данных
- Применяются миграции Django автоматически
- Запускается веб-сервер Django

### 3. Создание суперпользователя

```bash
docker-compose exec web python manage.py createsuperuser
```

### 4. Просмотр логов

```bash
# Логи веб-сервера
docker-compose logs -f web

# Логи базы данных
docker-compose logs -f db

# Все логи
docker-compose logs -f
```

### 5. Остановка контейнеров

```bash
docker-compose down
```

Для удаления volumes (включая данные БД):

```bash
docker-compose down -v
```

### 6. Подключение к базе данных

```bash
# Через Django shell
docker-compose exec web python manage.py dbshell

# Через PostgreSQL клиент
docker-compose exec db psql -U alfa_user -d alfa_db
```

**Подробная документация:** см. `DOCKER_DATABASE.md`

## Авторизация и вход

### Вход пользователей

Пользователи могут регистрироваться и входить через страницу `/login/`:

- **Регистрация**: Создает пользователя в Django User модели
- **Вход**: Авторизация через Django сессии
- **Администраторы**: Автоматически перенаправляются в админ-панель (`/admin/`)
- **Обычные пользователи**: Перенаправляются в личный кабинет (`/cabinet/`)

### Вход администраторов в админ-панель

Администраторы могут входить в админ-панель двумя способами:

1. **Через сайт** (`/login/`):
   - Введите email и пароль суперпользователя 
   - Автоматическое перенаправление в `/admin/`

2. **Напрямую** (`/admin/`):
   - Стандартный вход Django админ-панели

**Важно**: Email суперпользователя должен быть указан в Django User модели для входа через сайт.

## Система метрик

### Автоматический расчет

Метрики автоматически рассчитываются:
- При обработке каждого запроса к AI
- При вызове API `/api/metrics/summary/` (если метрики еще не рассчитаны)
- Периодически (каждые 10 запросов или каждый час)

### Просмотр метрик

1. **Через админ-панель**:
   - `http://localhost:8000/admin/main/metric/` - все метрики
   - `http://localhost:8000/admin/main/chatrequestmetrics/` - метрики запросов
   - `http://localhost:8000/admin/main/metrics/summary/` - сводка метрик

2. **Через API**:
   ```bash
   # Сводка метрик за последние 7 дней
   curl http://localhost:8000/api/metrics/summary/?days=7
   
   # Все метрики за период
   curl http://localhost:8000/api/metrics/?days=7
   
   # Принудительный расчет метрик
   curl -X POST http://localhost:8000/api/metrics/calculate/ \
     -H "Content-Type: application/json" \
     -d '{"days": 7}'
   ```

### Категории метрик

- **Качество** - точность, релевантность, полнота ответов
- **Производительность** - время обработки, пропускная способность
- **Надежность** - успешность запросов, частота ошибок
- **Безопасность** - обнаружение вредоносного контента
- **Пользовательский опыт** - удовлетворенность, вовлеченность
- **Активность пользователей** - активность, удержание

Подробнее см. [METRICS_SETUP.md](METRICS_SETUP.md)

## Примеры использования AI-помощника

- "Сколько у меня задолженности по налогам?"
- "Покажи последние 5 чеков"
- "Сколько сотрудников у меня работает и каков общий фонд зарплат?"
- "Запланируй встречу с клиентом на завтра в 15:00"
- "Проанализируй текст в прикрепленном файле"
- "Какие товары есть в инвентаризации?"
- "Сколько задолженности по коммунальным услугам?"
- "Перенеси встречу 'Встреча с клиентом' на завтра в 16:00"
- "Измени описание встречи 'Совещание' на 'Обсуждение проекта'"

## Структура проекта

```
alfa-finansi/
├── sempaialfa-main/
│   ├── aichat/                    # Основное Django приложение
│   │   ├── aichat/                # Настройки проекта
│   │   │   ├── settings.py        # Настройки Django
│   │   │   ├── urls.py            # Главный URL-конфигуратор
│   │   │   └── wsgi.py            # WSGI конфигурация
│   │   ├── main/                  # Основное приложение
│   │   │   ├── views.py           # Представления (views)
│   │   │   ├── urls.py            # URL-маршруты
│   │   │   ├── models.py          # Модели данных
│   │   │   ├── admin.py           # Настройки админ-панели
│   │   │   ├── metrics_calculator.py  # Расчет метрик
│   │   │   ├── content_moderator.py  # Модерация контента
│   │   │   └── file_processor.py  # Обработка файлов
│   │   ├── templates/             # HTML шаблоны
│   │   │   ├── main/              # Шаблоны приложения
│   │   │   └── admin/             # Шаблоны админ-панели
│   │   ├── static/                # Статические файлы (CSS, JS, изображения)
│   │   │   ├── admin/css/         # Стили админ-панели
│   │   │   ├── css/               # Основные стили
│   │   │   └── js/                # JavaScript файлы
│   │   ├── media/                 # Медиа файлы (загруженные пользователями)
│   │   └── manage.py              # Django утилита управления
│   ├── Dockerfile                 # Конфигурация Docker образа
│   ├── docker-compose.yml         # Конфигурация Docker Compose
│   ├── requirements.txt           # Python зависимости
│   ├── README.md                  # Документация
│   ├── METRICS_SETUP.md           # Настройка метрик
│   ├── ADMIN_PANEL.md             # Документация админ-панели
│   └── DOCKER_DATABASE.md         # Настройка базы данных
└── README.md                       # Документация корневого уровня
```

## API Endpoints

### Основные страницы

- `GET /` - Главная страница
- `GET /cabinet/` - Личный кабинет
- `GET /chat/` - Страница чата
- `GET /transfer/` - Перевод средств
- `GET /receipts/` - Чеки
- `GET /utilities/` - Коммунальные услуги
- `GET /taxes/` - Налоги
- `GET /calendar/` - Календарь
- `GET /documents/` - Документы
- `GET /inventory/` - Инвентаризация
- `GET /employees/` - Сотрудники
- `GET /support/` - Поддержка
- `GET /mail/` - Почта
- `GET /login/` - Вход и регистрация
- `GET /feedback/` - Обратная связь
- `GET /scenarios/` - Сценарии
- `GET /admin/` - Админ-панель Django

### API Endpoints

#### Чат и AI

- `POST /api/chat/` - API для отправки сообщений в чат (асинхронная обработка)
- `GET /api/chat-status/<uuid:request_id>/` - Проверка статуса запроса к AI
- `GET /api/check-lm-studio/` - Проверка подключения к Ollama

#### Пользователи и авторизация

- `POST /api/register/` - Регистрация нового пользователя
- `POST /api/login/` - Авторизация пользователя (возвращает информацию об админ-правах)
- `GET /api/user-data/` - Получение данных пользователя
- `POST /api/user-data/` - Сохранение данных пользователя

#### Календарь

- `POST /api/create-event/` - Создание события в календаре
- `POST /api/manage-calendar/` - Управление событиями календаря (создание/обновление/удаление)

#### История чатов

- `GET /api/chat-history/` - Получение списка истории чатов
- `GET /api/chat-history/<chat_id>/` - Получение детальной истории чата
- `GET /api/chat-history/<chat_id>/export/<format>/` - Экспорт истории чата (JSON/TXT/DOCX)
- `POST /api/chat-history/<chat_id>/edit/` - Редактирование сообщения в истории
- `POST /api/export-chat-docx/` - Прямой экспорт чата в DOCX

#### Метрики

- `GET /api/metrics/` - Получение всех метрик за период (параметр `days`)
- `GET /api/metrics/summary/` - Получение сводки метрик за период (параметр `days`)
- `POST /api/metrics/calculate/` - Принудительный расчет метрик за период

#### Прочее

- `POST /api/error-log/` - Логирование ошибок

## Тестирование

Проект включает полный набор тестов (81 тест), покрывающий:
- Модели данных (ChatRequest, ChatHistory, Metric, ChatRequestMetrics, UserActivity)
- API endpoints
- Обработку файлов (PDF, DOCX, XLSX, TXT, изображения)
- Модерацию контента
- Расчет метрик
- Утилитарные функции
- Интеграционные тесты
- Тесты безопасности и производительности

Подробные инструкции по запуску тестов см. в файле [TESTING.md](TESTING.md).

## Настройка модели AI

В файле `aichat/main/views.py` можно изменить параметры модели:

- `temperature`: 0.7 (креативность ответов, от 0 до 1)
- `max_tokens`: 1000 (максимальная длина ответа)
- `model`: "deepseek-r1" (имя модели в Ollama)

## Переменные окружения

Для production рекомендуется использовать переменные окружения. Создайте файл `.env`:

```env
SECRET_KEY=your-secret-key-here
DEBUG=False
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com
OLLAMA_URL=http://localhost:11434/v1/chat/completions

# PostgreSQL (для Docker)
DB_NAME=alfa_db
DB_USER=alfa_user
DB_PASSWORD=your-password
DB_HOST=db
DB_PORT=5432
```

## Решение проблем

### Ошибка подключения к Ollama

- Убедитесь, что Ollama запущен (`ollama serve`)
- Проверьте, что модель загружена (`ollama list` должна показывать `deepseek-r1`)
- Проверьте URL в настройках Django (по умолчанию `http://localhost:11434`)
- При использовании Docker используйте `host.docker.internal` вместо `localhost`
- Убедитесь, что порт не занят другим приложением
- Используйте скрипт проверки: `python check_lm_studio.py`

### Медленные ответы AI

- Модель deepseek-r1 может работать медленно на слабых компьютерах
- Увеличьте таймаут в `views.py` (сейчас 90 секунд)
- Рассмотрите использование более легкой модели

### Ошибка "Model not found"

- Убедитесь, что модель загружена: `ollama pull deepseek-r1`
- Проверьте, что модель активна: `ollama list`
- Убедитесь, что имя модели в `views.py` совпадает с именем в Ollama

### Проблемы с миграциями

```bash
# Удалить базу данных и применить миграции заново
cd sempaialfa-main\aichat
Remove-Item db.sqlite3 -ErrorAction SilentlyContinue
python manage.py migrate
```

### Проблемы со статическими файлами

```bash
python manage.py collectstatic --noinput
```

### Проблемы с виртуальным окружением в PowerShell

```powershell
# Разрешить выполнение скриптов
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# Активировать виртуальное окружение
.\venv\Scripts\Activate.ps1
```

### Проблемы с входом в админ-панель через сайт

- Убедитесь, что у суперпользователя указан email в Django User модели
- Проверьте, что пользователь имеет права `is_staff` или `is_superuser`
- Проверьте консоль браузера (F12) на наличие ошибок JavaScript
- Убедитесь, что сервер запущен и доступен

### Проблемы с метриками

- Убедитесь, что миграции применены: `python manage.py migrate`
- Проверьте, что есть запросы к AI (метрики рассчитываются автоматически)
- Используйте API для принудительного расчета: `POST /api/metrics/calculate/`
- Проверьте логи Django на наличие ошибок

## Разработка

### Запуск в режиме разработки

```powershell
cd sempaialfa-main\aichat
.\venv\Scripts\Activate.ps1
python manage.py runserver
```

### Особенности интерфейса

В приложении используются эмодзи вместо иконок для улучшения читаемости и универсальности:

- **Календарь**: редактирование, удаление
- **Документы**: переименование, скачать, удаление, избранное
- **Инвентаризация**: редактирование, удаление
- **Сотрудники**: выплата зарплаты, редактирование, удаление
- **Профиль**: только текст без иконок
- **Чат**: переключатель темы без иконки, только текст

### Изменение системного промпта

Системный промпт настраивается в функции `process_chat_request_async` в `aichat/main/views.py`. Вы можете изменить этот промпт для изменения поведения AI.

### Кастомизация админ-панели

Стили админ-панели находятся в `static/admin/css/custom_admin.css`. Можно изменить:
- Цвета акцентов
- Размеры и отступы
- Шрифты
- Анимации

## Деплой в production

### Рекомендации для production

1. Установите `DEBUG = False` в `settings.py`
2. Настройте `ALLOWED_HOSTS`
3. Используйте переменные окружения для секретных ключей
4. Настройте PostgreSQL вместо SQLite
5. Используйте Nginx как reverse proxy
6. Настройте SSL/TLS сертификаты
7. Используйте Gunicorn или uWSGI вместо встроенного сервера Django
8. Настройте автоматический расчет метрик через cron или Celery

### Пример Dockerfile для production

```dockerfile
FROM python:3.13-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt gunicorn

COPY aichat/ /app/aichat/
WORKDIR /app/aichat

RUN python manage.py collectstatic --noinput

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "aichat.wsgi:application"]
```

## Дополнительная документация

- [METRICS_SETUP.md](METRICS_SETUP.md) - Подробная инструкция по настройке системы метрик
- [ADMIN_PANEL.md](ADMIN_PANEL.md) - Документация по админ-панели
- [ADMIN_QUICKSTART.md](ADMIN_QUICKSTART.md) - Быстрый старт для админ-панели
- [DOCKER_DATABASE.md](DOCKER_DATABASE.md) - Настройка базы данных в Docker
- [TESTING.md](TESTING.md) - Инструкции по тестированию
- [OPENAPI.md](OPENAPI.md) - OpenAPI спецификация и документация API
- [VALUE_DEMO_PROMPT.md](VALUE_DEMO_PROMPT.md) - Демосценарии для презентации продукта

## Авторы/роли

- Тасуев Абдуллах (Продуктовый аналитик)
- Скоринов Антон (UX/UI-дизайнер)
- Николаева Анастасия (Fullstack разработчик)

## Поддержка

Если у Вас возникли вопросы или проблемы, пишите на почту или телеграм (nestee_nn@mail.ru, @nestee_nn).
