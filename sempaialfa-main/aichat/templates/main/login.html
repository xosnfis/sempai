{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ - –ê–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ cache_version }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Lazy Loading –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <script src="{% static 'js/lazy-loading.js' %}?v={{ cache_version }}"></script>
    <!-- –°–∏—Å—Ç–µ–º–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω -->
    <script src="{% static 'js/modal.js' %}?v={{ cache_version }}"></script>
</head>
<body class="login-page">
    <!-- Theme Toggle Button -->
    <button class="login-theme-toggle" id="loginThemeToggle" onclick="toggleLoginTheme()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" 
            data-light-icon="{% static 'images/sv_tema.svg' %}" 
            data-dark-icon="{% static 'images/tem_tema.svg' %}">
        <img src="{% static 'images/sv_tema.svg' %}" alt="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" class="login-theme-icon" id="loginThemeIcon">
    </button>
    
    <div class="login-container">
        <!-- Fixed Tabs at Top -->
        <div class="login-tabs-fixed">
            <button class="login-tab-fixed active" id="loginTabFixed" onclick="flipToLogin()">–í—Ö–æ–¥</button>
            <button class="login-tab-fixed" id="registerTabFixed" onclick="flipToRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
        <div class="login-card-wrapper" id="loginCardWrapper">
            <div class="login-card-inner">
                <!-- Front Side - Login Form -->
                <div class="login-card-face login-card-front">
                    <div class="login-form-container">
                        <h2 class="login-title">–í—Ö–æ–¥</h2>
                        <form class="login-form" id="loginFormElement" onsubmit="handleLogin(event)">
                            <div class="login-form-group">
                                <input type="email" class="login-input" id="loginEmail" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" required>
                            </div>
                            <div class="login-form-group">
                                <input type="password" class="login-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
                            </div>
                            <div class="login-checkbox-container">
                                <input type="checkbox" id="loginRobot" class="login-checkbox" required>
                                <label for="loginRobot" class="login-checkbox-label">–Ø —Ç–æ—á–Ω–æ –Ω–µ —Ä–æ–±–æ—Ç</label>
                            </div>
                            <div class="login-security-message">
                                <span class="login-security-icon">üõ°Ô∏è</span>
                                <span class="login-security-text">–ú—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</span>
                            </div>
                            <button type="submit" class="login-submit-btn">–í–æ–π—Ç–∏</button>
                        </form>
                    </div>
                </div>

                <!-- Back Side - Register Form -->
                <div class="login-card-face login-card-back">
                    <div class="login-form-container">
                        <h2 class="login-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                        <form class="login-form" id="registerFormElement" onsubmit="handleRegister(event)">
                            <div class="login-form-group">
                                <input type="text" class="login-input" id="registerOrganization" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" required>
                            </div>
                            <div class="login-form-group">
                                <input type="email" class="login-input" id="registerEmail" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" required>
                            </div>
                            <div class="login-form-group">
                                <input type="password" class="login-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
                            </div>
                            <div class="login-form-group">
                                <input type="password" class="login-input" id="registerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                            </div>
                            <div class="login-checkbox-container">
                                <input type="checkbox" id="registerRobot" class="login-checkbox" required>
                                <label for="registerRobot" class="login-checkbox-label">–Ø —Ç–æ—á–Ω–æ –Ω–µ —Ä–æ–±–æ—Ç</label>
                            </div>
                            <div class="login-security-message">
                                <span class="login-security-icon">üõ°Ô∏è</span>
                                <span class="login-security-text">–ú—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</span>
                            </div>
                            <button type="submit" class="login-submit-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Flip card to register form
        function flipToRegister() {
            const cardWrapper = document.getElementById('loginCardWrapper');
            const loginTab = document.getElementById('loginTabFixed');
            const registerTab = document.getElementById('registerTabFixed');
            cardWrapper.classList.add('flipped');
            loginTab.classList.remove('active');
            registerTab.classList.add('active');
        }

        // Flip card to login form
        function flipToLogin() {
            const cardWrapper = document.getElementById('loginCardWrapper');
            const loginTab = document.getElementById('loginTabFixed');
            const registerTab = document.getElementById('registerTabFixed');
            cardWrapper.classList.remove('flipped');
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const robotCheck = document.getElementById('loginRobot').checked;

            if (!robotCheck) {
                showWarning('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç');
                return;
            }

            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = '–í—Ö–æ–¥...';

            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Django API
                const response = await fetch("{% url 'login_api' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    }),
                    credentials: 'same-origin' // –í–∞–∂–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è Django —Å–µ—Å—Å–∏–∏
                });

                const data = await response.json();

                if (data.success) {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                    if (data.is_admin) {
                        window.location.href = '/admin/';
                    } else {
                        // –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø—Ä–æ–≤–µ—Ä—è–µ–º localStorage –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                        const users = JSON.parse(localStorage.getItem('users') || '[]');
                        const user = users.find(u => u.email === email);
                        
                        if (user) {
                            localStorage.setItem('currentUser', JSON.stringify({
                                organization: user.organization,
                                email: user.email
                            }));
                        }
                        
                        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–±–∏–Ω–µ—Ç
                        window.location.href = "{% url 'cabinet' %}";
                    }
                } else {
                    // –ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª use_localstorage, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
                    if (data.use_localstorage) {
                        const users = JSON.parse(localStorage.getItem('users') || '[]');
                        const user = users.find(u => u.email === email && u.password === password);

                        if (user) {
                            localStorage.setItem('currentUser', JSON.stringify({
                                organization: user.organization,
                                email: user.email
                            }));
                            window.location.href = "{% url 'cabinet' %}";
                        } else {
                            showError('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                            submitButton.disabled = false;
                            submitButton.textContent = originalButtonText;
                        }
                    } else {
                        showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ');
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ:', error);
                // Fallback –Ω–∞ localStorage –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.email === email && u.password === password);

                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify({
                        organization: user.organization,
                        email: user.email
                    }));
                    window.location.href = "{% url 'cabinet' %}";
                } else {
                    showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            
            const organization = document.getElementById('registerOrganization').value.trim();
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const robotCheck = document.getElementById('registerRobot').checked;

            if (!robotCheck) {
                showWarning('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç');
                return;
            }

            if (password !== confirmPassword) {
                showWarning('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }

            if (password.length < 6) {
                showWarning('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';

            try {
                // –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ë–î
                const response = await fetch("{% url 'register_user' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        organization: organization,
                        email: email,
                        password: password,
                        confirmPassword: confirmPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
                    if (!users.find(u => u.email === email)) {
                        users.push({
                            organization: organization,
                            email: email,
                            password: password
                        });
                        localStorage.setItem('users', JSON.stringify(users));
                    }

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    localStorage.setItem('currentUser', JSON.stringify({
                        organization: organization,
                        email: email
                    }));

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    initializeNewUserData();

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    await showSuccess('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');

                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–±–∏–Ω–µ—Ç
                    window.location.href = "{% url 'cabinet' %}";
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                    showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        }

        // Initialize data for new user
        function initializeNewUserData() {
            // Set account balances: first account 300,000, second account 50,000
            localStorage.setItem('accountBalance', '300000');
            localStorage.setItem('accountBalance2', '50000');
            localStorage.setItem('currentAccount', '1');

            // Initialize taxes data
            const taxes = [
                { id: 'profit', basePrice: 50000 },
                { id: 'vat', basePrice: 35000 },
                { id: 'property', basePrice: 25000 },
                { id: 'insurance', basePrice: 40000 }
            ];
            const taxesData = {};
            taxes.forEach(tax => {
                taxesData[tax.id] = {
                    debt: tax.basePrice,
                    lastUpdate: Date.now(),
                    lastPayment: null
                };
            });
            localStorage.setItem('taxesData', JSON.stringify(taxesData));

            // Initialize utilities data
            const utilities = [
                { id: 'electricity', basePrice: 5000 },
                { id: 'water', basePrice: 3000 },
                { id: 'heating', basePrice: 8000 },
                { id: 'waste', basePrice: 2000 },
                { id: 'security', basePrice: 6000 },
                { id: 'internet', basePrice: 1500 }
            ];
            const utilitiesData = {};
            utilities.forEach(util => {
                utilitiesData[util.id] = {
                    debt: util.basePrice,
                    lastUpdate: Date.now(),
                    lastPayment: null
                };
            });
            localStorage.setItem('utilitiesData', JSON.stringify(utilitiesData));
        }

        // Theme toggle functions
        function toggleLoginTheme() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            localStorage.setItem('theme', newTheme);
            applyLoginTheme(newTheme);
        }

        function applyLoginTheme(theme) {
            const themeIcon = document.getElementById('loginThemeIcon');
            const themeToggle = document.getElementById('loginThemeToggle');
            const lightIcon = themeToggle.getAttribute('data-light-icon');
            const darkIcon = themeToggle.getAttribute('data-dark-icon');
            
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.documentElement.classList.add('dark-theme');
                themeIcon.src = darkIcon;
            } else {
                document.body.classList.remove('dark-theme');
                document.documentElement.classList.remove('dark-theme');
                themeIcon.src = lightIcon;
            }
        }

        // Check if user is already logged in and apply theme
        window.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                window.location.href = "{% url 'cabinet' %}";
            }
            
            // Apply saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyLoginTheme(savedTheme);
        });
    </script>
</body>
</html>

