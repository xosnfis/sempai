{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ - –ê–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ cache_version }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="login-page">
    <!-- Theme Toggle Button -->
    <button class="login-theme-toggle" id="loginThemeToggle" onclick="toggleLoginTheme()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" 
            data-light-icon="{% static 'images/sv_tema.svg' %}" 
            data-dark-icon="{% static 'images/tem_tema.svg' %}">
        <img src="{% static 'images/sv_tema.svg' %}" alt="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" class="login-theme-icon" id="loginThemeIcon">
    </button>
    
    <div class="login-container">
        <div class="login-card">
            <!-- Tabs -->
            <div class="login-tabs">
                <button class="login-tab" id="loginTab" onclick="switchTab('login')">–í—Ö–æ–¥</button>
                <button class="login-tab" id="registerTab" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>

            <!-- Login Form -->
            <div class="login-form-container" id="loginForm">
                <h2 class="login-title">–í—Ö–æ–¥</h2>
                <form class="login-form" id="loginFormElement" onsubmit="handleLogin(event)">
                    <div class="login-form-group">
                        <input type="email" class="login-input" id="loginEmail" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" required>
                    </div>
                    <div class="login-form-group">
                        <input type="password" class="login-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
                    </div>
                    <div class="login-checkbox-container">
                        <input type="checkbox" id="loginRobot" class="login-checkbox" required>
                        <label for="loginRobot" class="login-checkbox-label">–Ø —Ç–æ—á–Ω–æ –Ω–µ —Ä–æ–±–æ—Ç</label>
                    </div>
                    <div class="login-security-message">
                        <span class="login-security-icon">üõ°Ô∏è</span>
                        <span class="login-security-text">–ú—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</span>
                    </div>
                    <button type="submit" class="login-submit-btn">–í–æ–π—Ç–∏</button>
                </form>
            </div>

            <!-- Register Form -->
            <div class="login-form-container" id="registerForm" style="display: none;">
                <h2 class="login-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <form class="login-form" id="registerFormElement" onsubmit="handleRegister(event)">
                    <div class="login-form-group">
                        <input type="text" class="login-input" id="registerOrganization" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" required>
                    </div>
                    <div class="login-form-group">
                        <input type="email" class="login-input" id="registerEmail" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" required>
                    </div>
                    <div class="login-form-group">
                        <input type="password" class="login-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
                    </div>
                    <div class="login-form-group">
                        <input type="password" class="login-input" id="registerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                    </div>
                    <div class="login-checkbox-container">
                        <input type="checkbox" id="registerRobot" class="login-checkbox" required>
                        <label for="registerRobot" class="login-checkbox-label">–Ø —Ç–æ—á–Ω–æ –Ω–µ —Ä–æ–±–æ—Ç</label>
                    </div>
                    <div class="login-security-message">
                        <span class="login-security-icon">üõ°Ô∏è</span>
                        <span class="login-security-text">–ú—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</span>
                    </div>
                    <button type="submit" class="login-submit-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Switch between login and register tabs
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
            }
        }

        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const robotCheck = document.getElementById('loginRobot').checked;

            if (!robotCheck) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç');
                return;
            }

            // Check if user exists in localStorage
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                // Save current user to localStorage
                localStorage.setItem('currentUser', JSON.stringify({
                    organization: user.organization,
                    email: user.email
                }));
                
                // Redirect to cabinet
                window.location.href = "{% url 'cabinet' %}";
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        }

        // Handle registration
        function handleRegister(event) {
            event.preventDefault();
            
            const organization = document.getElementById('registerOrganization').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const robotCheck = document.getElementById('registerRobot').checked;

            if (!robotCheck) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç');
                return;
            }

            if (password !== confirmPassword) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }

            // Get existing users
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Check if user already exists
            if (users.find(u => u.email === email)) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                return;
            }

            // Add new user
            users.push({
                organization: organization,
                email: email,
                password: password
            });

            localStorage.setItem('users', JSON.stringify(users));

            // Save current user to localStorage
            localStorage.setItem('currentUser', JSON.stringify({
                organization: organization,
                email: email
            }));

            // Initialize data for new user
            initializeNewUserData();

            // Redirect to cabinet
            window.location.href = "{% url 'cabinet' %}";
        }

        // Initialize data for new user
        function initializeNewUserData() {
            // Set account balances: first account 300,000, second account 50,000
            localStorage.setItem('accountBalance', '300000');
            localStorage.setItem('accountBalance2', '50000');
            localStorage.setItem('currentAccount', '1');

            // Initialize taxes data
            const taxes = [
                { id: 'profit', basePrice: 50000 },
                { id: 'vat', basePrice: 35000 },
                { id: 'property', basePrice: 25000 },
                { id: 'insurance', basePrice: 40000 }
            ];
            const taxesData = {};
            taxes.forEach(tax => {
                taxesData[tax.id] = {
                    debt: tax.basePrice,
                    lastUpdate: Date.now(),
                    lastPayment: null
                };
            });
            localStorage.setItem('taxesData', JSON.stringify(taxesData));

            // Initialize utilities data
            const utilities = [
                { id: 'electricity', basePrice: 5000 },
                { id: 'water', basePrice: 3000 },
                { id: 'heating', basePrice: 8000 },
                { id: 'waste', basePrice: 2000 },
                { id: 'security', basePrice: 6000 },
                { id: 'internet', basePrice: 1500 }
            ];
            const utilitiesData = {};
            utilities.forEach(util => {
                utilitiesData[util.id] = {
                    debt: util.basePrice,
                    lastUpdate: Date.now(),
                    lastPayment: null
                };
            });
            localStorage.setItem('utilitiesData', JSON.stringify(utilitiesData));
        }

        // Theme toggle functions
        function toggleLoginTheme() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            localStorage.setItem('theme', newTheme);
            applyLoginTheme(newTheme);
        }

        function applyLoginTheme(theme) {
            const themeIcon = document.getElementById('loginThemeIcon');
            const themeToggle = document.getElementById('loginThemeToggle');
            const lightIcon = themeToggle.getAttribute('data-light-icon');
            const darkIcon = themeToggle.getAttribute('data-dark-icon');
            
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.documentElement.classList.add('dark-theme');
                themeIcon.src = darkIcon;
            } else {
                document.body.classList.remove('dark-theme');
                document.documentElement.classList.remove('dark-theme');
                themeIcon.src = lightIcon;
            }
        }

        // Check if user is already logged in and apply theme
        window.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                window.location.href = "{% url 'cabinet' %}";
            }
            
            // Apply saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyLoginTheme(savedTheme);
        });
    </script>
</body>
</html>

