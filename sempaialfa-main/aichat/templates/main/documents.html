{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–∫—É–º–µ–Ω—Ç—ã - –ê–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ cache_version }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="cabinet-page">
    <!-- Header -->
    <header class="cabinet-header">
        <div class="cabinet-header-top">
            <div class="cabinet-logo-section">
                <h1 class="cabinet-logo">
                    <span class="cabinet-logo-red">–ê</span>–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
                </h1>
                <p class="cabinet-subtitle">–î–æ–∫—É–º–µ–Ω—Ç—ã</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="cabinet-main">
        <div class="cabinet-container">
            <div class="documents-container">
                <div class="documents-header">
                    <a href="{% url 'cabinet' %}" class="documents-back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                </div>

                <!-- Upload Section -->
                <div class="documents-upload-section">
                    <h2 class="documents-section-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h2>
                    <div class="documents-upload-area" id="uploadArea">
                        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif" style="display: none;">
                        <div class="documents-upload-content">
                            <div class="documents-upload-icon">üìÑ</div>
                            <p class="documents-upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏</p>
                            <button class="documents-upload-btn" onclick="document.getElementById('fileInput').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
                            <p class="documents-upload-hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOC, DOCX, XLS, XLSX, TXT, JPG, PNG, GIF</p>
                        </div>
                    </div>
                </div>

                <!-- Documents List -->
                <div class="documents-list-section">
                    <div class="documents-list-header">
                        <h2 class="documents-section-title">–ú–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>
                        <div class="documents-filter">
                            <button class="documents-filter-btn active" onclick="filterDocuments('all')">–í—Å–µ</button>
                            <button class="documents-filter-btn" onclick="filterDocuments('favorite')">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                        </div>
                    </div>
                    <div class="documents-list" id="documentsList">
                        <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    <div class="documents-empty" id="documentsEmpty" style="display: none;">
                        <p>–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Rename Modal -->
    <div class="document-rename-modal" id="renameModal" style="display: none;">
        <div class="document-rename-modal-content">
            <div class="document-rename-modal-header">
                <h3 class="document-rename-modal-title">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h3>
                <button class="document-rename-modal-close" onclick="closeRenameModal()">√ó</button>
            </div>
            <form class="document-rename-modal-form" id="renameForm">
                <div class="document-rename-form-group">
                    <label for="newFileName" class="document-rename-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="newFileName" class="document-rename-input" required>
                </div>
                <div class="document-rename-form-actions">
                    <button type="button" class="document-rename-btn document-rename-btn-cancel" onclick="closeRenameModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="document-rename-btn document-rename-btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // –ü—É—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        const DOCUMENTS_IMAGE_PATHS = {
            red: "{% static 'images/red.svg' %}",
            skachat: "{% static 'images/skachat.svg' %}",
            udalit: "{% static 'images/udalit.png' %}"
        };
        
        let documents = [];
        let currentFilter = 'all';
        let renamingDocumentId = null;

        // –ü–æ–ª—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserDocuments() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `documents_${email}`;
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : [];
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserDocuments(documentsArray) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `documents_${email}`;
            localStorage.setItem(key, JSON.stringify(documentsArray));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ localStorage –∏ IndexedDB
        async function loadDocuments() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–ª–µ–Ω—å–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑ localStorage
                let smallDocs = getUserDocuments();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –∏–∑ IndexedDB
                let largeDocs = [];
                try {
                    if (email) {
                        largeDocs = await loadLargeFilesFromIndexedDB(email);
                    }
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ IndexedDB:', e);
                }
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
                documents = [...smallDocs, ...largeDocs];
                
                if (documents.length > 0) {
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${documents.length} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞`);
                } else {
                    console.log('–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—É—Å—Ç–æ');
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:', e);
                documents = [];
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –•—Ä–∞–Ω–∏–ª–∏—â–µ –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–æ.');
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                if (email) {
                    localStorage.removeItem(`documents_${email}`);
                }
            }
            renderDocuments();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ localStorage —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º IndexedDB –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
        async function saveDocuments() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                if (!email) return;
                
                // –†–∞–∑–¥–µ–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ (–¥–ª—è localStorage) –∏ –±–æ–ª—å—à–∏–µ (–¥–ª—è IndexedDB)
                const smallDocs = [];
                const largeDocs = [];
                const largeFileThreshold = 5 * 1024 * 1024; // 5MB - –ø–æ—Ä–æ–≥ –¥–ª—è IndexedDB
                
                for (const doc of documents) {
                    if (doc.size > largeFileThreshold) {
                        largeDocs.push(doc);
                    } else {
                        smallDocs.push(doc);
                    }
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–ª–µ–Ω—å–∫–∏–µ —Ñ–∞–π–ª—ã –≤ localStorage (—Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
                saveUserDocuments(smallDocs);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –≤ IndexedDB
                if (largeDocs.length > 0) {
                    await saveLargeFilesToIndexedDB(email, largeDocs);
                }
                
                console.log('–î–æ–∫—É–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–¥–∞–ª–∏—Ç–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.');
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:', e);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                }
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ IndexedDB
        async function saveLargeFilesToIndexedDB(email, docs) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('AlfaAIDocuments', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    const db = request.result;
                    const transaction = db.transaction(['documents'], 'readwrite');
                    const store = transaction.objectStore('documents');
                    
                    docs.forEach(doc => {
                        store.put({
                            id: doc.id,
                            email: email,
                            name: doc.name,
                            size: doc.size,
                            type: doc.type,
                            extension: doc.extension,
                            data: doc.data,
                            favorite: doc.favorite,
                            uploadDate: doc.uploadDate
                        });
                    });
                    
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('documents')) {
                        const objectStore = db.createObjectStore('documents', { keyPath: ['email', 'id'] });
                        objectStore.createIndex('email', 'email', { unique: false });
                    }
                };
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ IndexedDB
        async function loadLargeFilesFromIndexedDB(email) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('AlfaAIDocuments', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('documents')) {
                        resolve([]);
                        return;
                    }
                    
                    const transaction = db.transaction(['documents'], 'readonly');
                    const store = transaction.objectStore('documents');
                    const index = store.index('email');
                    const requestGet = index.getAll(email);
                    
                    requestGet.onsuccess = () => {
                        const docs = requestGet.result.map(doc => ({
                            id: doc.id,
                            name: doc.name,
                            size: doc.size,
                            type: doc.type,
                            extension: doc.extension,
                            data: doc.data,
                            favorite: doc.favorite,
                            uploadDate: doc.uploadDate
                        }));
                        resolve(docs);
                    };
                    
                    requestGet.onerror = () => reject(requestGet.error);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('documents')) {
                        const objectStore = db.createObjectStore('documents', { keyPath: ['email', 'id'] });
                        objectStore.createIndex('email', 'email', { unique: false });
                    }
                };
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        function getFileIcon(extension) {
            const icons = {
                'pdf': 'üìï',
                'doc': 'üìò', 'docx': 'üìò',
                'xls': 'üìó', 'xlsx': 'üìó',
                'txt': 'üìÑ',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è'
            };
            return icons[extension] || 'üìÑ';
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 100MB)
                const maxSize = 100 * 1024 * 1024; // 100MB
                if (file.size > maxSize) {
                    alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${formatFileSize(file.size)}). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100MB`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const document = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        extension: getFileExtension(file.name),
                        data: event.target.result,
                        favorite: false,
                        uploadDate: new Date().toISOString()
                    };
                    documents.push(document);
                    saveDocuments();
                    renderDocuments();
                };
                reader.onerror = function() {
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ "${file.name}"`);
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        });

        // Drag and Drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('documents-upload-area-drag');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('documents-upload-area-drag');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('documents-upload-area-drag');
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 100MB)
                const maxSize = 100 * 1024 * 1024; // 100MB
                if (file.size > maxSize) {
                    alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${formatFileSize(file.size)}). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100MB`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const document = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        extension: getFileExtension(file.name),
                        data: event.target.result,
                        favorite: false,
                        uploadDate: new Date().toISOString()
                    };
                    documents.push(document);
                    saveDocuments();
                    renderDocuments();
                };
                reader.onerror = function() {
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ "${file.name}"`);
                };
                reader.readAsDataURL(file);
            });
        });

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        function renderDocuments() {
            const list = document.getElementById('documentsList');
            const empty = document.getElementById('documentsEmpty');
            list.innerHTML = '';

            let filteredDocuments = documents;
            if (currentFilter === 'favorite') {
                filteredDocuments = documents.filter(doc => doc.favorite);
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º –ø–æ –¥–∞—Ç–µ
            filteredDocuments.sort((a, b) => {
                if (a.favorite && !b.favorite) return -1;
                if (!a.favorite && b.favorite) return 1;
                return new Date(b.uploadDate) - new Date(a.uploadDate);
            });

            if (filteredDocuments.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
            } else {
                list.style.display = 'grid';
                empty.style.display = 'none';

                filteredDocuments.forEach(doc => {
                    const docItem = document.createElement('div');
                    docItem.className = `document-item ${doc.favorite ? 'document-item-favorite' : ''}`;
                    docItem.innerHTML = `
                        <div class="document-item-icon">${getFileIcon(doc.extension)}</div>
                        <div class="document-item-content">
                            <div class="document-item-name">${doc.name}</div>
                            <div class="document-item-info">
                                <span class="document-item-size">${formatFileSize(doc.size)}</span>
                                <span class="document-item-date">${new Date(doc.uploadDate).toLocaleDateString('ru-RU')}</span>
                            </div>
                        </div>
                        <div class="document-item-actions">
                            <button class="document-item-favorite-btn ${doc.favorite ? 'document-item-favorite-active' : ''}" 
                                    onclick="toggleFavorite('${doc.id}')" title="${doc.favorite ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">
                                ${doc.favorite ? '‚≠ê' : '‚òÜ'}
                            </button>
                            <button class="document-item-rename-btn" onclick="openRenameModal('${doc.id}')" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">
                                ‚úèÔ∏è
                            </button>
                            <button class="document-item-download-btn" onclick="downloadDocument('${doc.id}')" title="–°–∫–∞—á–∞—Ç—å">
                                ‚¨áÔ∏è
                            </button>
                            <button class="document-item-delete-btn" onclick="deleteDocument('${doc.id}')" title="–£–¥–∞–ª–∏—Ç—å">
                                ‚ùå
                            </button>
                        </div>
                    `;
                    list.appendChild(docItem);
                });
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        function filterDocuments(filter) {
            currentFilter = filter;
            document.querySelectorAll('.documents-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === (filter === 'all' ? '–í—Å–µ' : '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ')) {
                    btn.classList.add('active');
                }
            });
            renderDocuments();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        function toggleFavorite(id) {
            const doc = documents.find(d => d.id.toString() === id);
            if (doc) {
                doc.favorite = !doc.favorite;
                saveDocuments();
                renderDocuments();
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
        function openRenameModal(id) {
            renamingDocumentId = id;
            const doc = documents.find(d => d.id.toString() === id);
            if (doc) {
                document.getElementById('newFileName').value = doc.name.replace(/\.[^/.]+$/, '');
                document.getElementById('renameModal').style.display = 'flex';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
        function closeRenameModal() {
            document.getElementById('renameModal').style.display = 'none';
            renamingDocumentId = null;
            document.getElementById('renameForm').reset();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
        document.getElementById('renameForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (renamingDocumentId) {
                const doc = documents.find(d => d.id.toString() === renamingDocumentId);
                if (doc) {
                    const newName = document.getElementById('newFileName').value.trim();
                    if (newName) {
                        doc.name = newName + '.' + doc.extension;
                        saveDocuments();
                        renderDocuments();
                        closeRenameModal();
                    }
                }
            }
        });

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        function downloadDocument(id) {
            const doc = documents.find(d => d.id.toString() === id);
            if (doc) {
                const link = document.createElement('a');
                link.href = doc.data;
                link.download = doc.name;
                link.click();
            }
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            messageEl.textContent = message;
            modal.style.display = 'flex';
            
            document.getElementById('confirmYes').onclick = function() {
                modal.style.display = 'none';
                onConfirm();
            };
            
            document.getElementById('confirmNo').onclick = function() {
                modal.style.display = 'none';
            };
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function deleteDocument(id) {
            showConfirmModal('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç?', async function() {
                const doc = documents.find(d => d.id.toString() === id);
                if (doc) {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    const email = currentUser.email || '';
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª, —É–¥–∞–ª—è–µ–º –∏–∑ IndexedDB
                    const largeFileThreshold = 5 * 1024 * 1024; // 5MB
                    if (doc.size > largeFileThreshold && email) {
                        try {
                            await deleteLargeFileFromIndexedDB(email, id);
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∏–∑ IndexedDB:', e);
                        }
                    }
                }
                
                documents = documents.filter(d => d.id.toString() !== id);
                await saveDocuments();
                renderDocuments();
            });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–∑ IndexedDB
        async function deleteLargeFileFromIndexedDB(email, docId) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('AlfaAIDocuments', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('documents')) {
                        resolve();
                        return;
                    }
                    
                    const transaction = db.transaction(['documents'], 'readwrite');
                    const store = transaction.objectStore('documents');
                    store.delete([email, docId]);
                    
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('documents')) {
                        const objectStore = db.createObjectStore('documents', { keyPath: ['email', 'id'] });
                        objectStore.createIndex('email', 'email', { unique: false });
                    }
                };
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        (async function() {
            await loadDocuments();
        })();
    </script>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal" style="display: none;">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 class="confirm-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            </div>
            <div class="confirm-modal-body">
                <p class="confirm-message" id="confirmMessage"></p>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-btn-cancel" id="confirmNo">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirmYes">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.documentElement.classList.add('dark-theme');
            }
        })();
    </script>
</body>
</html>

