{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ - –ê–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ cache_version }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="cabinet-page">
    <!-- Header -->
    <header class="cabinet-header">
        <div class="cabinet-header-top">
            <div class="cabinet-logo-section">
                <h1 class="cabinet-logo">
                    <span class="cabinet-logo-red">–ê</span>–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
                </h1>
                <p class="cabinet-subtitle">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="cabinet-main">
        <div class="cabinet-container">
            <div class="employees-container">
                <div class="employees-header">
                    <a href="{% url 'cabinet' %}" class="employees-back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                </div>

                <!-- Add Employee Section -->
                <div class="employees-add-section">
                    <h2 class="employees-section-title">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                    <form class="employees-add-form" id="addEmployeeForm">
                        <div class="employees-form-row">
                            <div class="employees-form-group">
                                <label for="employeeFIO" class="employees-label">–§–ò–û</label>
                                <input type="text" id="employeeFIO" class="employees-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û" required>
                            </div>
                            <div class="employees-form-group">
                                <label for="employeePhone" class="employees-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" id="employeePhone" class="employees-input" placeholder="+7 (999) 999-99-99" required>
                            </div>
                            <div class="employees-form-group">
                                <label for="employeeEmail" class="employees-label">–ü–æ—á—Ç–∞</label>
                                <input type="email" id="employeeEmail" class="employees-input" placeholder="email@example.com" required>
                            </div>
                            <div class="employees-form-group">
                                <label for="employeeSalary" class="employees-label">–ó–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                                <input type="number" id="employeeSalary" class="employees-input" placeholder="0.00" min="0" step="0.01" required>
                            </div>
                            <div class="employees-form-group">
                                <label for="employeeFolder" class="employees-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                                <select id="employeeFolder" class="employees-select">
                                    <option value="">–ë–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</option>
                                </select>
                            </div>
                        </div>
                        <div class="employees-form-actions">
                            <button type="submit" class="employees-add-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </form>
                </div>

                <!-- Employees List Section -->
                <div class="employees-list-section">
                    <div class="employees-list-header">
                        <h2 class="employees-section-title">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
                        <button class="employees-add-folder-btn" onclick="openFolderModal()">+ –°–æ–∑–¥–∞—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</button>
                    </div>
                    <div class="employees-list" id="employeesList">
                        <!-- –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    <div class="employees-empty" id="employeesEmpty" style="display: none;">
                        <p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Folder Modal -->
    <div class="employees-folder-modal" id="folderModal" style="display: none;">
        <div class="employees-folder-modal-content">
            <div class="employees-folder-modal-header">
                <h3 class="employees-folder-modal-title">–°–æ–∑–¥–∞—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</h3>
                <button class="employees-folder-modal-close" onclick="closeFolderModal()">√ó</button>
            </div>
            <form class="employees-folder-modal-form" id="folderForm">
                <div class="employees-folder-form-group">
                    <label for="folderName" class="employees-folder-label">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</label>
                    <input type="text" id="folderName" class="employees-folder-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏" required>
                </div>
                <div class="employees-folder-form-actions">
                    <button type="button" class="employees-folder-btn employees-folder-btn-cancel" onclick="closeFolderModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="employees-folder-btn employees-folder-btn-save">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div class="employees-edit-modal" id="editEmployeeModal" style="display: none;">
        <div class="employees-edit-modal-content">
            <div class="employees-edit-modal-header">
                <h3 class="employees-edit-modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
                <button class="employees-edit-modal-close" onclick="closeEditEmployeeModal()">√ó</button>
            </div>
            <form class="employees-edit-modal-form" id="editEmployeeForm">
                <div class="employees-edit-form-group">
                    <label for="editEmployeeFIO" class="employees-edit-label">–§–ò–û</label>
                    <input type="text" id="editEmployeeFIO" class="employees-edit-input" required>
                </div>
                <div class="employees-edit-form-group">
                    <label for="editEmployeePhone" class="employees-edit-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="editEmployeePhone" class="employees-edit-input" required>
                </div>
                <div class="employees-edit-form-group">
                    <label for="editEmployeeEmail" class="employees-edit-label">–ü–æ—á—Ç–∞</label>
                    <input type="email" id="editEmployeeEmail" class="employees-edit-input" required>
                </div>
                <div class="employees-edit-form-group">
                    <label for="editEmployeeSalary" class="employees-edit-label">–ó–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                    <input type="number" id="editEmployeeSalary" class="employees-edit-input" min="0" step="0.01" required>
                </div>
                <div class="employees-edit-form-group">
                    <label for="editEmployeeFolder" class="employees-edit-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <select id="editEmployeeFolder" class="employees-edit-select">
                        <option value="">–ë–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</option>
                    </select>
                </div>
                <div class="employees-edit-form-actions">
                    <button type="button" class="employees-edit-btn employees-edit-btn-cancel" onclick="closeEditEmployeeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="employees-edit-btn employees-edit-btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pay Salary Modal -->
    <div class="employees-pay-modal" id="paySalaryModal" style="display: none;">
        <div class="employees-pay-modal-content">
            <div class="employees-pay-modal-header">
                <h3 class="employees-pay-modal-title">–í—ã–ø–ª–∞—Ç–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É</h3>
                <button class="employees-pay-modal-close" onclick="closePaySalaryModal()">√ó</button>
            </div>
            <div class="employees-pay-modal-body">
                <p class="employees-pay-employee-name" id="payEmployeeName"></p>
                <p class="employees-pay-amount">–°—É–º–º–∞: <span id="payAmount"></span> ‚ÇΩ</p>
                <p class="employees-pay-warning">–°—É–º–º–∞ –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—á–µ—Ç–∞</p>
            </div>
            <div class="employees-pay-modal-actions">
                <button type="button" class="employees-pay-btn employees-pay-btn-cancel" onclick="closePaySalaryModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="employees-pay-btn employees-pay-btn-confirm" onclick="confirmPaySalary()">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ü—É—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        const EMPLOYEES_IMAGE_PATHS = {
            zp: "{% static 'images/zp.png' %}",
            red: "{% static 'images/red.svg' %}",
            udalit: "{% static 'images/udalit.png' %}"
        };
        
        let employees = [];
        let folders = [];
        let editingEmployeeId = null;
        let payingEmployeeId = null;

        // –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserEmployees() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `employees_${email}`;
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : [];
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserEmployees(employeesArray) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `employees_${email}`;
            localStorage.setItem(key, JSON.stringify(employeesArray));
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å –ø–∞–ø–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserEmployeeFolders() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `employeeFolders_${email}`;
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : [];
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–ø–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserEmployeeFolders(foldersArray) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `employeeFolders_${email}`;
            localStorage.setItem(key, JSON.stringify(foldersArray));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadData() {
            employees = getUserEmployees();
            folders = getUserEmployeeFolders();
            updateFolderSelects();
            renderEmployees();
            checkSalaryNotifications();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveData() {
            saveUserEmployees(employees);
            saveUserEmployeeFolders(folders);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø–∞–ø–æ–∫ –≤ select
        function updateFolderSelects() {
            const selects = document.querySelectorAll('#employeeFolder, #editEmployeeFolder');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">–ë–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</option>';
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞
        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—á–µ—Ç–∞
        function getCurrentAccount() {
            return parseInt(localStorage.getItem('currentAccount') || '1');
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Å—á–µ—Ç–∞
        function getAccountBalance(accountNum) {
            const key = accountNum === 1 ? 'accountBalance' : 'accountBalance2';
            const savedBalance = localStorage.getItem(key);
            if (savedBalance) {
                return parseFloat(savedBalance);
            }
            return accountNum === 1 ? 237000 : 50000;
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–ª–∞–Ω—Å–∞ —Å—á–µ—Ç–∞
        function setAccountBalance(accountNum, balance) {
            const key = accountNum === 1 ? 'accountBalance' : 'accountBalance2';
            localStorage.setItem(key, balance.toString());
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        function renderEmployees() {
            const list = document.getElementById('employeesList');
            const empty = document.getElementById('employeesEmpty');
            list.innerHTML = '';

            // –†–∞–∑–¥–µ–ª—è–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º
            const employeesByFolder = {};
            const employeesWithoutFolder = [];

            employees.forEach(employee => {
                if (employee.folderId) {
                    if (!employeesByFolder[employee.folderId]) {
                        employeesByFolder[employee.folderId] = [];
                    }
                    employeesByFolder[employee.folderId].push(employee);
                } else {
                    employeesWithoutFolder.push(employee);
                }
            });

            if (employees.length === 0 && folders.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
            } else {
                list.style.display = 'block';
                empty.style.display = 'none';

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
                folders.forEach(folder => {
                    const folderEmployees = employeesByFolder[folder.id] || [];
                    const folderElement = createFolderElement(folder, folderEmployees);
                    list.appendChild(folderElement);
                });

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –±–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
                employeesWithoutFolder.forEach(employee => {
                    const employeeElement = createEmployeeElement(employee);
                    list.appendChild(employeeElement);
                });
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        function createFolderElement(folder, folderEmployees) {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'employees-folder';
            folderDiv.dataset.folderId = folder.id;

            const totalSalary = folderEmployees.reduce((sum, emp) => sum + (emp.salary || 0), 0);
            const employeesCount = folderEmployees.length;

            folderDiv.innerHTML = `
                <div class="employees-folder-header">
                    <div class="employees-folder-header-left" onclick="toggleFolder('${folder.id}')">
                        <div class="employees-folder-info">
                            <span class="employees-folder-icon">üíº</span>
                            <span class="employees-folder-name">${folder.name}</span>
                            <span class="employees-folder-count">(${employeesCount} ${employeesCount === 1 ? '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫' : employeesCount === 0 ? '–ø—É—Å—Ç–æ' : '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'})</span>
                        </div>
                        <div class="employees-folder-stats">
                            ${employeesCount > 0 ? `
                                <span class="employees-folder-total">–í—Å–µ–≥–æ –∑–∞—Ä–ø–ª–∞—Ç: ${formatNumber(totalSalary)} ‚ÇΩ</span>
                            ` : '<span class="employees-folder-empty">–î–æ–ª–∂–Ω–æ—Å—Ç—å –ø—É—Å—Ç–∞</span>'}
                            <span class="employees-folder-toggle">‚ñº</span>
                        </div>
                    </div>
                    <button class="employees-folder-delete-btn" onclick="event.stopPropagation(); deleteFolder('${folder.id}')" title="–£–¥–∞–ª–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å">√ó</button>
                </div>
                <div class="employees-folder-content" id="folderContent-${folder.id}" style="display: ${employeesCount > 0 ? 'none' : 'block'};">
                    ${employeesCount > 0 ? folderEmployees.map(emp => createEmployeeHTML(emp)).join('') : '<div class="employees-folder-empty-message">–î–æ–ª–∂–Ω–æ—Å—Ç—å –ø—É—Å—Ç–∞</div>'}
                </div>
            `;

            return folderDiv;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ HTML —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function createEmployeeHTML(employee) {
            const lastPaymentDate = employee.lastPaymentDate ? new Date(employee.lastPaymentDate) : null;
            const nextPaymentDate = lastPaymentDate ? new Date(lastPaymentDate.getTime() + 30 * 24 * 60 * 60 * 1000) : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
            const now = new Date();
            const daysUntilPayment = Math.ceil((nextPaymentDate - now) / (1000 * 60 * 60 * 24));
            const needsPayment = daysUntilPayment <= 0;
            const paymentStatus = needsPayment ? 'payment-due' : daysUntilPayment <= 7 ? 'payment-soon' : 'payment-ok';

            return `
                <div class="employees-item ${paymentStatus}" data-employee-id="${employee.id}">
                    <div class="employees-item-content">
                        <div class="employees-item-name">${employee.fio}</div>
                        <div class="employees-item-details">
                            <span class="employees-item-phone">üìû ${employee.phone}</span>
                            <span class="employees-item-email">‚úâÔ∏è ${employee.email}</span>
                            <span class="employees-item-salary">üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞: ${formatNumber(employee.salary)} ‚ÇΩ</span>
                        </div>
                        ${lastPaymentDate ? `
                            <div class="employees-item-payment-info">
                                <span>–ü–æ—Å–ª–µ–¥–Ω—è—è –≤—ã–ø–ª–∞—Ç–∞: ${lastPaymentDate.toLocaleDateString('ru-RU')}</span>
                                <span class="employees-item-next-payment ${paymentStatus}">
                                    ${needsPayment ? '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–ª–∞—Ç–∞' : `–°–ª–µ–¥—É—é—â–∞—è –≤—ã–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ ${daysUntilPayment} ${daysUntilPayment === 1 ? '–¥–µ–Ω—å' : daysUntilPayment < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}`}
                                </span>
                            </div>
                        ` : '<div class="employees-item-payment-info"><span class="employees-item-next-payment payment-due">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–ª–∞—Ç–∞</span></div>'}
                    </div>
                    <div class="employees-item-actions">
                        <select class="employees-item-move-select" onchange="moveEmployee('${employee.id}', this.value)">
                            <option value="">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤...</option>
                            ${folders.map(folder => `<option value="${folder.id}" ${employee.folderId === folder.id ? 'selected' : ''}>${folder.name}</option>`).join('')}
                            <option value="remove">–£–±—Ä–∞—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</option>
                        </select>
                        <button class="employees-item-pay-btn" onclick="openPaySalaryModal('${employee.id}')" title="–í—ã–ø–ª–∞—Ç–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É">
                            üí∞
                        </button>
                        <button class="employees-item-edit-btn" onclick="openEditEmployeeModal('${employee.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </button>
                        <button class="employees-item-delete-btn" onclick="deleteEmployee('${employee.id}')" title="–£–¥–∞–ª–∏—Ç—å">
                            ‚ùå
                        </button>
                    </div>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –±–µ–∑ –ø–∞–ø–∫–∏)
        function createEmployeeElement(employee) {
            const employeeDiv = document.createElement('div');
            employeeDiv.className = 'employees-item';
            employeeDiv.dataset.employeeId = employee.id;
            employeeDiv.innerHTML = createEmployeeHTML(employee);
            return employeeDiv;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ (—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ)
        function toggleFolder(folderId) {
            const content = document.getElementById(`folderContent-${folderId}`);
            const folderElement = document.querySelector(`[data-folder-id="${folderId}"]`);
            const toggle = folderElement.querySelector('.employees-folder-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ –¥–æ–ª–∂–Ω–æ—Å—Ç—å
        function moveEmployee(employeeId, folderId) {
            const employee = employees.find(e => e.id.toString() === employeeId);
            if (employee) {
                if (folderId === 'remove') {
                    employee.folderId = null;
                } else if (folderId) {
                    employee.folderId = folderId;
                }
                saveData();
                renderEmployees();
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        function openFolderModal() {
            document.getElementById('folderModal').style.display = 'flex';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        function closeFolderModal() {
            document.getElementById('folderModal').style.display = 'none';
            document.getElementById('folderForm').reset();
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function openEditEmployeeModal(employeeId) {
            editingEmployeeId = employeeId;
            const employee = employees.find(e => e.id.toString() === employeeId);
            if (employee) {
                document.getElementById('editEmployeeFIO').value = employee.fio;
                document.getElementById('editEmployeePhone').value = employee.phone;
                document.getElementById('editEmployeeEmail').value = employee.email;
                document.getElementById('editEmployeeSalary').value = employee.salary;
                document.getElementById('editEmployeeFolder').value = employee.folderId || '';
                document.getElementById('editEmployeeModal').style.display = 'flex';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function closeEditEmployeeModal() {
            document.getElementById('editEmployeeModal').style.display = 'none';
            editingEmployeeId = null;
            document.getElementById('editEmployeeForm').reset();
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–ø–ª–∞—Ç—ã –∑–∞—Ä–ø–ª–∞—Ç—ã
        function openPaySalaryModal(employeeId) {
            payingEmployeeId = employeeId;
            const employee = employees.find(e => e.id.toString() === employeeId);
            if (employee) {
                document.getElementById('payEmployeeName').textContent = employee.fio;
                document.getElementById('payAmount').textContent = formatNumber(employee.salary);
                document.getElementById('paySalaryModal').style.display = 'flex';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–ø–ª–∞—Ç—ã –∑–∞—Ä–ø–ª–∞—Ç—ã
        function closePaySalaryModal() {
            document.getElementById('paySalaryModal').style.display = 'none';
            payingEmployeeId = null;
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            messageEl.textContent = message;
            modal.style.display = 'flex';
            
            document.getElementById('confirmYes').onclick = function() {
                modal.style.display = 'none';
                onConfirm();
            };
            
            document.getElementById('confirmNo').onclick = function() {
                modal.style.display = 'none';
            };
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã –∑–∞—Ä–ø–ª–∞—Ç—ã
        function confirmPaySalary() {
            if (!payingEmployeeId) return;

            const employee = employees.find(e => e.id.toString() === payingEmployeeId);
            if (!employee) return;

            const currentAccount = getCurrentAccount();
            const balance = getAccountBalance(currentAccount);

            if (balance < employee.salary) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç–µ –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã –∑–∞—Ä–ø–ª–∞—Ç—ã');
                return;
            }

            const message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–ª–∞—Ç–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É ${employee.fio} –≤ —Ä–∞–∑–º–µ—Ä–µ ${formatNumber(employee.salary)} ‚ÇΩ?`;
            
            showConfirmModal(message, function() {
                // –°–ø–∏—Å—ã–≤–∞–µ–º —Å –±–∞–ª–∞–Ω—Å–∞
                const newBalance = balance - employee.salary;
                setAccountBalance(currentAccount, newBalance);

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–ø–ª–∞—Ç—ã
                employee.lastPaymentDate = new Date().toISOString();

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ —á–µ–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                if (email) {
                    const key = `receipts_${email}`;
                    const receipts = JSON.parse(localStorage.getItem(key) || '[]');
                    receipts.push({
                        id: Date.now().toString(),
                        type: 'salary',
                        description: `–í—ã–ø–ª–∞—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã: ${employee.fio}`,
                        amount: employee.salary,
                        date: new Date().toISOString(),
                        account: currentAccount,
                        pinned: false
                    });
                    localStorage.setItem(key, JSON.stringify(receipts));
                }

                saveData();
                renderEmployees();
                checkSalaryNotifications();

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                if (window.opener && typeof window.opener.updateBalances === 'function') {
                    window.opener.updateBalances();
                }

                alert(`–ó–∞—Ä–ø–ª–∞—Ç–∞ ${formatNumber(employee.salary)} ‚ÇΩ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–ª–∞—á–µ–Ω–∞ ${employee.fio}`);
                closePaySalaryModal();
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function deleteEmployee(employeeId) {
            showConfirmModal('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?', function() {
                employees = employees.filter(e => e.id.toString() !== employeeId);
                saveData();
                renderEmployees();
                checkSalaryNotifications();
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        function deleteFolder(folderId) {
            const folder = folders.find(f => f.id.toString() === folderId);
            if (!folder) return;

            const folderEmployees = employees.filter(e => e.folderId && e.folderId.toString() === folderId);
            let message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å "${folder.name}"?`;
            if (folderEmployees.length > 0) {
                message += `\n\n–í –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è ${folderEmployees.length} ${folderEmployees.length === 1 ? '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫' : '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'}. –û–Ω–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ "–ë–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏".`;
            }

            showConfirmModal(message, function() {
                employees.forEach(employee => {
                    if (employee.folderId && employee.folderId.toString() === folderId) {
                        employee.folderId = null;
                    }
                });
                folders = folders.filter(f => f.id.toString() !== folderId);
                saveData();
                updateFolderSelects();
                renderEmployees();
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞—Ä–ø–ª–∞—Ç–µ
        function checkSalaryNotifications() {
            const now = new Date();
            let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞—Ä–ø–ª–∞—Ç–µ
            notifications = notifications.filter(n => n.type !== 'salary');

            employees.forEach(employee => {
                const lastPaymentDate = employee.lastPaymentDate ? new Date(employee.lastPaymentDate) : null;
                const nextPaymentDate = lastPaymentDate ? new Date(lastPaymentDate.getTime() + 30 * 24 * 60 * 60 * 1000) : new Date(Date.now());
                const daysUntilPayment = Math.ceil((nextPaymentDate - now) / (1000 * 60 * 60 * 24));

                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 3 –¥–Ω—è –¥–æ –≤—ã–ø–ª–∞—Ç—ã –∏–ª–∏ –µ—Å–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                if (daysUntilPayment <= 3) {
                    notifications.push({
                        id: 'salary-' + employee.id + '-' + Date.now(),
                        type: 'salary',
                        title: '–í—ã–ø–ª–∞—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã',
                        message: `${employee.fio} - —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–ª–∞—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã ${formatNumber(employee.salary)} ‚ÇΩ${daysUntilPayment <= 0 ? ' (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ)' : ` (—á–µ—Ä–µ–∑ ${daysUntilPayment} ${daysUntilPayment === 1 ? '–¥–µ–Ω—å' : '–¥–Ω—è'})`}`,
                        date: new Date().toLocaleString('ru-RU'),
                        read: false,
                        employeeId: employee.id
                    });
                }
            });

            localStorage.setItem('notifications', JSON.stringify(notifications));

            // –û–±–Ω–æ–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
            if (window.opener && typeof window.opener.loadNotifications === 'function') {
                window.opener.loadNotifications();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const fio = document.getElementById('employeeFIO').value.trim();
            const phone = document.getElementById('employeePhone').value.trim();
            const email = document.getElementById('employeeEmail').value.trim();
            const salary = parseFloat(document.getElementById('employeeSalary').value);
            const folderId = document.getElementById('employeeFolder').value || null;

            if (fio && phone && email && salary >= 0) {
                employees.push({
                    id: Date.now() + Math.random(),
                    fio: fio,
                    phone: phone,
                    email: email,
                    salary: salary,
                    folderId: folderId,
                    lastPaymentDate: null
                });
                saveData();
                renderEmployees();
                checkSalaryNotifications();
                this.reset();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        document.getElementById('folderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('folderName').value.trim();
            if (name) {
                folders.push({
                    id: Date.now() + Math.random(),
                    name: name
                });
                saveData();
                updateFolderSelects();
                renderEmployees();
                closeFolderModal();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('editEmployeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (editingEmployeeId) {
                const employee = employees.find(e => e.id.toString() === editingEmployeeId);
                if (employee) {
                    employee.fio = document.getElementById('editEmployeeFIO').value.trim();
                    employee.phone = document.getElementById('editEmployeePhone').value.trim();
                    employee.email = document.getElementById('editEmployeeEmail').value.trim();
                    employee.salary = parseFloat(document.getElementById('editEmployeeSalary').value);
                    const folderId = document.getElementById('editEmployeeFolder').value;
                    employee.folderId = folderId || null;
                    saveData();
                    renderEmployees();
                    checkSalaryNotifications();
                    closeEditEmployeeModal();
                }
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadData();
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
        setInterval(checkSalaryNotifications, 6 * 60 * 60 * 1000);
    </script>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal" style="display: none;">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 class="confirm-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            </div>
            <div class="confirm-modal-body">
                <p class="confirm-message" id="confirmMessage"></p>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-btn-cancel" id="confirmNo">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirmYes">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.documentElement.classList.add('dark-theme');
            }
        })();
    </script>
</body>
</html>

