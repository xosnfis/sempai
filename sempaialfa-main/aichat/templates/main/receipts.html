{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–µ–∫–∏ - –ê–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ cache_version }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="cabinet-page">
    <!-- Header -->
    <header class="cabinet-header">
        <div class="cabinet-header-top">
            <div class="cabinet-logo-section">
                <h1 class="cabinet-logo">
                    <span class="cabinet-logo-red">–ê</span>–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
                </h1>
                <p class="cabinet-subtitle">–ß–µ–∫–∏</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="cabinet-main">
        <div class="cabinet-container">
            <div class="receipts-container">
                <div class="receipts-header">
                    <a href="{% url 'cabinet' %}" class="receipts-back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                </div>

                <div class="cabinet-feature-buttons" id="receiptsList">
                    <!-- –ß–µ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>

                <div class="receipts-empty" id="receiptsEmpty" style="display: none;">
                    <p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const receiptIconPath = "{% static 'images/ch.png' %}";
        
        // –ü–æ–ª—É—á–∏—Ç—å —á–µ–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserReceipts() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `receipts_${email}`;
            return JSON.parse(localStorage.getItem(key) || '[]');
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserReceipts(receipts) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `receipts_${email}`;
            localStorage.setItem(key, JSON.stringify(receipts));
        }
        
        function loadReceipts() {
            const receipts = getUserReceipts();
            const receiptsList = document.getElementById('receiptsList');
            const receiptsEmpty = document.getElementById('receiptsEmpty');

            if (receipts.length === 0) {
                receiptsList.style.display = 'none';
                receiptsEmpty.style.display = 'block';
                return;
            }

            receiptsList.style.display = 'flex';
            receiptsEmpty.style.display = 'none';
            receiptsList.innerHTML = '';

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ, –ø–æ—Ç–æ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            receipts.sort((a, b) => {
                const aPinned = a.pinned || false;
                const bPinned = b.pinned || false;
                if (aPinned && !bPinned) return -1;
                if (!aPinned && bPinned) return 1;
                return b.id - a.id;
            });

            receipts.forEach(receipt => {
                const receiptItem = document.createElement('div');
                const isPinned = receipt.pinned || false;
                receiptItem.className = `cabinet-feature-btn cabinet-feature-btn-dark receipt-item-block ${isPinned ? 'receipt-pinned' : ''}`;
                const description = receipt.description ? `<br>${receipt.description}` : '';
                const pinIcon = isPinned ? 'üìå' : 'üìç';
                receiptItem.innerHTML = `
                    <span class="cabinet-feature-icon">
                        <img src="${receiptIconPath}" alt="–ß–µ–∫">
                    </span>
                    <div class="cabinet-feature-content">
                        <div class="cabinet-feature-title">
                            ${isPinned ? '<span style="color: #ffaa00; margin-right: 5px;">üìå</span>' : ''}
                            ${receipt.operationType === '–ü–µ—Ä–µ–≤–æ–¥' ? '–ü–µ—Ä–µ–≤–æ–¥' : '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ'} - ${formatAmount(receipt.amount)} ‚ÇΩ
                        </div>
                        <div class="cabinet-feature-subtitle">
                            –ë–∞–Ω–∫: ${receipt.bank} | –°—á–µ—Ç: ${receipt.accountNumber}${description}<br>
                            –ë–∞–ª–∞–Ω—Å: ${formatAmount(receipt.balance)} ‚ÇΩ | ${receipt.date}
                        </div>
                    </div>
                    <div class="receipt-item-actions">
                        <button class="receipt-item-pin" onclick="togglePin(${receipt.id})" title="${isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å'}">
                            ${pinIcon}
                        </button>
                        <button class="receipt-item-delete" onclick="deleteReceipt(${receipt.id})">√ó</button>
                    </div>
                `;
                receiptsList.appendChild(receiptItem);
            });
        }

        function formatAmount(amount) {
            return new Intl.NumberFormat('ru-RU').format(amount);
        }

        function togglePin(id) {
            let receipts = getUserReceipts();
            const receipt = receipts.find(r => r.id === id);
            if (receipt) {
                receipt.pinned = !receipt.pinned;
                saveUserReceipts(receipts);
                loadReceipts();
            }
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const messageEl = document.getElementById('confirmMessage');
            messageEl.textContent = message;
            modal.style.display = 'flex';
            
            document.getElementById('confirmYes').onclick = function() {
                modal.style.display = 'none';
                onConfirm();
            };
            
            document.getElementById('confirmNo').onclick = function() {
                modal.style.display = 'none';
            };
        }

        function deleteReceipt(id) {
            showConfirmModal('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é?', function() {
                let receipts = getUserReceipts();
                receipts = receipts.filter(r => r.id !== id);
                saveUserReceipts(receipts);
                loadReceipts();
            });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadReceipts();
    </script>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal" style="display: none;">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 class="confirm-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            </div>
            <div class="confirm-modal-body">
                <p class="confirm-message" id="confirmMessage"></p>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-btn-cancel" id="confirmNo">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirmYes">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.documentElement.classList.add('dark-theme');
            }
        })();
    </script>
</body>
</html>

