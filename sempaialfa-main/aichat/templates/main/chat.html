{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>–ß–∞—Ç - –ê–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ cache_version }}">
    <link rel="stylesheet" href="{% static 'css/charts.css' %}?v={{ cache_version }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PNG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- –°–∏—Å—Ç–µ–º–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <script src="{% static 'js/loading-indicators.js' %}?v={{ cache_version }}"></script>
    <!-- Lazy Loading –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <script src="{% static 'js/lazy-loading.js' %}?v={{ cache_version }}"></script>
    <!-- –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ -->
    <script src="{% static 'js/error-handler.js' %}?v={{ cache_version }}"></script>
    <!-- –°–∏—Å—Ç–µ–º–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω -->
    <script src="{% static 'js/modal.js' %}?v={{ cache_version }}"></script>
    <!-- –°–∏—Å—Ç–µ–º–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–≥—Ä–∞—Ñ–∏–∫–∏) -->
    <script src="{% static 'js/charts.js' %}?v={{ cache_version }}"></script>
    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
    <script src="{% static 'js/mobile-menu.js' %}?v={{ cache_version }}"></script>
</head>
<body class="chat-page">
    <div class="chat-container">
        <!-- Sidebar Overlay (Mobile) -->
        <div class="chat-sidebar-overlay" id="chatSidebarOverlay"></div>
        
        <!-- Left Sidebar -->
        <aside class="chat-sidebar" id="chatSidebar">
            <div class="chat-sidebar-header">
                <div class="chat-logo-header-wrapper">
                <div class="chat-logo">
                        <a href="{% url 'cabinet' %}" class="chat-logo-link" onclick="if (window.innerWidth > 768 && document.getElementById('chatSidebar')?.classList.contains('chat-sidebar-collapsed')) { event.preventDefault(); toggleSidebarCollapse(); }">
                            <div class="chat-logo-box">
                                <span class="chat-logo-text">Alfa-AI</span>
                            </div>
                    </a>
                    </div>
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è -->
                    <button class="chat-sidebar-toggle-btn" id="chatSidebarToggleBtn" onclick="toggleSidebarCollapse();" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å">
                        <svg class="chat-sidebar-toggle-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
                    <button class="chat-sidebar-close-btn" id="chatSidebarCloseBtn" onclick="closeChatSidebar(event)" title="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é">
                        <svg class="chat-sidebar-close-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="chat-sidebar-content">
                <button class="chat-new-chat-btn" data-i18n="new-chat">–ù–æ–≤—ã–π —á–∞—Ç</button>
                <button class="chat-favorites-btn" id="favoritesBtn" data-i18n="favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                <input type="text" class="chat-search-input" id="chatSearchInput" data-i18n-placeholder="search-chats" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º">
                
                <div id="chatHistorySection"></div>
            </div>
            
            <div class="chat-sidebar-footer">
                <button class="chat-profile-btn chat-theme-btn" id="chatThemeBtn" onclick="toggleChatTheme()">
                    <img src="{% static 'images/sv_tema.svg' %}" alt="–¢–µ–º–∞" class="chat-profile-icon chat-theme-icon-light" id="chatThemeIconLight" loading="lazy" style="display: none;">
                    <img src="{% static 'images/tem_tema.svg' %}" alt="–¢–µ–º–∞" class="chat-profile-icon chat-theme-icon-dark" id="chatThemeIconDark" loading="lazy">
                    <span class="chat-profile-text" id="chatThemeBtnText">–¢–µ–º–∞</span>
                </button>
                <button class="chat-profile-btn chat-export-btn" id="chatExportBtn" onclick="showExportChatModal()" style="display: none;">
                    <img src="{% static 'images/skachat.svg' %}" alt="–≠–∫—Å–ø–æ—Ä—Ç" class="chat-profile-icon" loading="lazy">
                    <span class="chat-profile-text">–≠–∫—Å–ø–æ—Ä—Ç</span>
                </button>
                <button class="chat-profile-btn chat-suggestions-sidebar-btn" id="chatSuggestionsSidebarBtn" onclick="toggleSuggestionsModal()" title="–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤">
                    <img src="{% static 'images/light.png' %}" alt="–ü–æ–¥—Å–∫–∞–∑–∫–∏" class="chat-profile-icon" loading="lazy">
                    <span class="chat-profile-text">–ü–æ–¥—Å–∫–∞–∑–∫–∏</span>
                </button>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div class="chat-main-header">
                <button class="chat-burger-btn" id="chatBurgerBtn" onclick="toggleChatSidebar()">
                    <span class="chat-burger-line"></span>
                    <span class="chat-burger-line"></span>
                    <span class="chat-burger-line"></span>
                </button>
                <a href="{% url 'cabinet' %}" class="chat-home-btn">
                    <img src="{% static 'images/na_glavn.png' %}" alt="–ù–∞ –≥–ª–∞–≤–Ω—É—é" class="chat-home-icon" loading="lazy">
                </a>
            </div>
            
            <div class="chat-content">
                <div class="chat-messages-area" id="chatMessages">
                    <div class="chat-ai-widget-main" id="chatWelcome">
                        <div class="chat-ai-icon-main">
                            <span class="chat-ai-icon-text-main">AI</span>
                        </div>
                        <div class="chat-ai-prompt">–° —á–µ–≥–æ –Ω–∞—á–Ω—ë–º, –ë–æ—Å—Å?</div>
                    </div>
                    <div class="chat-capability-messages" id="chatCapabilityMessages">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ–≥–æ —á–∞—Ç–∞ -->
                <div class="chat-export-all-button" id="chatExportAllButton" style="display: none;">
                    <button onclick="showExportChatModal()" title="–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–≥–æ —á–∞—Ç–∞" class="chat-export-all-btn">
                        <img src="{% static 'images/skachat.svg' %}" alt="–≠–∫—Å–ø–æ—Ä—Ç" style="width: 24px; height: 24px;" loading="lazy">
                    </button>
                </div>
                
                <div class="chat-input-wrapper">
                    <div id="attachedFiles" class="attached-files-list" style="display: none;"></div>
                    <div class="chat-input-container">
                        <input type="file" id="fileInput" style="display: none;" multiple>
                        <input type="text" class="chat-input" id="chatInput" data-i18n-placeholder="ask-me-something" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —É –º–µ–Ω—è —á—Ç–æ-–Ω–∏–±—É–¥—å..">
                        <div class="chat-input-actions">
                            <button type="button" class="chat-attach-btn" id="attachBtn">
                                <img src="{% static 'images/prikrepit_file_svatl.png' %}" alt="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" loading="lazy">
                            </button>
                            <button class="chat-send-btn" id="chatSendBtn">
                                <img src="{% static 'images/otpravit.png' %}" alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" loading="lazy">
                            </button>
                            <button type="button" class="chat-suggestions-btn" id="chatSuggestionsBtn" onclick="toggleSuggestionsModal()" title="–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤">
                                <img src="{% static 'images/light.png' %}" alt="–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤" style="width: 20px; height: 20px;" loading="lazy">
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Suggestions Modal -->
    <div class="suggestions-modal" id="suggestionsModal" style="display: none;">
        <div class="suggestions-modal-content">
            <div class="suggestions-modal-header">
                <h3 class="suggestions-modal-title">–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤</h3>
                <button class="suggestions-modal-close" onclick="toggleSuggestionsModal()">√ó</button>
            </div>
            <div class="suggestions-modal-body" id="suggestionsModalBody">
                <!-- –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal" style="display: none;">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 class="confirm-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            </div>
            <div class="confirm-modal-body">
                <p class="confirm-message" id="confirmMessage"></p>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirmBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Edit Chat Title Modal -->
    <div class="confirm-modal" id="editChatModal" style="display: none;">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 class="confirm-modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞</h3>
            </div>
            <div class="confirm-modal-body">
                <input type="text" id="editChatTitleInput" class="chat-edit-title-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeEditChatModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn confirm-btn-confirm" id="saveEditChatBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Export Chat Modal -->
    <div class="confirm-modal" id="exportChatModal" style="display: none;">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 class="confirm-modal-title">–≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞</h3>
            </div>
            <div class="confirm-modal-body">
                <p style="margin-bottom: 20px; color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ–≥–æ —á–∞—Ç–∞:</p>
                <div class="export-options-grid">
                    <button class="export-option-btn" onclick="exportChatDOCX(); closeExportChatModal();" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Word –¥–æ–∫—É–º–µ–Ω—Ç">
                        <span class="export-option-icon"><img src="{% static 'images/txt.png' %}" alt="DOCX" loading="lazy"></span>
                        <span class="export-option-text">DOCX</span>
                        <span class="export-option-desc">Word –¥–æ–∫—É–º–µ–Ω—Ç</span>
                    </button>
                    <button class="export-option-btn" onclick="exportChatCSV(); closeExportChatModal();" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV">
                        <span class="export-option-icon"><img src="{% static 'images/csv.png' %}" alt="CSV"></span>
                        <span class="export-option-text">CSV</span>
                        <span class="export-option-desc">–¢–∞–±–ª–∏—Ü–∞ Excel</span>
                    </button>
                    <button class="export-option-btn" onclick="exportChatPNG(); closeExportChatModal();" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ PNG">
                        <span class="export-option-icon"><img src="{% static 'images/png.png' %}" alt="PNG"></span>
                        <span class="export-option-text">PNG</span>
                        <span class="export-option-desc">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
                    </button>
                </div>
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeExportChatModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // –ü—É—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
        const IMAGE_PATHS = {
            tem_tema: "{% static 'images/tem_tema.svg' %}",
            sv_tema: "{% static 'images/sv_tema.svg' %}",
            zakrep2: "{% static 'images/zakrep2.svg' %}",
            red: "{% static 'images/red.svg' %}",
            udalit: "{% static 'images/udalit.png' %}",
            iznr: "{% static 'images/iznr.png' %}",
            csv: "{% static 'images/csv.png' %}",
            txt: "{% static 'images/txt.png' %}",
            png: "{% static 'images/png.png' %}"
        };
        
        // –ü–æ–ª—É—á–∏—Ç—å —á–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserChats() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `chats_${email}`;
            return JSON.parse(localStorage.getItem(key) || '[]');
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserChats(chatsArray) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `chats_${email}`;
            localStorage.setItem(key, JSON.stringify(chatsArray));
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserFavorites() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `favorites_${email}`;
            return JSON.parse(localStorage.getItem(key) || '[]');
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserFavorites(favoritesArray) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `favorites_${email}`;
            localStorage.setItem(key, JSON.stringify(favoritesArray));
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —á–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserPinnedChats() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return [];
            const key = `pinnedChats_${email}`;
            return JSON.parse(localStorage.getItem(key) || '[]');
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —á–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserPinnedChats(pinnedChatsArray) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return;
            const key = `pinnedChats_${email}`;
            localStorage.setItem(key, JSON.stringify(pinnedChatsArray));
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏
        let currentChatId = null;
        let chats = getUserChats();
        let favorites = getUserFavorites();
        let pinnedChats = getUserPinnedChats();
        let showFavoritesOnly = false;
        let searchQuery = '';
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
        let attachedFiles = [];

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function restoreActiveRequests() {
            chats.forEach(chat => {
                chat.messages.forEach(msg => {
                    if (!msg.isUser && msg.requestId && msg.text === '–î—É–º–∞—é...') {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                        const startTime = msg.timestamp ? new Date(msg.timestamp).getTime() : Date.now();
                        activeRequests.set(msg.requestId, { chatId: chat.id, startTime: startTime });
                        statusCheckAttempts.set(msg.requestId, 0); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
                        console.log(`üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ ${msg.requestId}`);
                        checkRequestStatus(msg.requestId, chat.id);
                    }
                });
            });
        }
        
        // –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ localStorage)
        let editingMessageIndex = -1;
        
        function downloadFile(content, filename, mimeType) {
            try {
                const blob = new Blob([content], { type: `${mimeType};charset=utf-8` });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
            }
        }
        
        function exportChatJSON() {
            if (!currentChatId) {
                showWarning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) {
                showError('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `chat_${chat.title.replace(/[^a-z0-9]/gi, '_')}_${timestamp}.json`;
            
            const data = {
                title: chat.title,
                chat_id: chat.id,
                created_at: chat.createdAt,
                updated_at: new Date().toISOString(),
                total_messages: chat.messages.length,
                messages: chat.messages.map(msg => ({
                    text: msg.text,
                    isUser: msg.isUser,
                    timestamp: msg.timestamp,
                    files: msg.files || [],
                    edited: msg.edited || false,
                    edited_at: msg.edited_at || null
                }))
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            downloadFile(dataStr, filename, 'application/json');
        }
        
        async function exportChatDOCX() {
            if (!currentChatId) {
                showWarning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) {
                showError('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ DOCX
                const response = await fetch('/api/export-chat-docx/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: chat.title,
                        chat_id: chat.id,
                        messages: chat.messages
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ blob
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `chat_${chat.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.docx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ DOCX:', error);
                showError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${error.message}`);
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ CSV —ç–∫—Å–ø–æ—Ä—Ç–∞
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—É–º–º (–¥–ª—è CSV - –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤, —á—Ç–æ–±—ã Excel –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª)
        function formatCurrency(value, currency = '‚ÇΩ') {
            if (typeof value !== 'number' || isNaN(value)) return '';
            
            // –î–ª—è CSV –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–∫—É –∫–∞–∫ –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (Excel —Å–∞–º –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç)
            // –ò –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã –≤ –∫–æ–Ω–µ—Ü
            return value.toFixed(2) + ' ' + currency;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—É–º–º —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
        function formatCurrencyDisplay(value, currency = '‚ÇΩ') {
            if (typeof value !== 'number' || isNaN(value)) return '';
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á –∏ –∑–∞–ø—è—Ç–æ–π –¥–ª—è –∫–æ–ø–µ–µ–∫
            const formatted = value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            // –ó–∞–º–µ–Ω—è–µ–º —Ç–æ—á–∫—É –Ω–∞ –∑–∞–ø—è—Ç—É—é –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
            return formatted.replace('.', ',') + ' ' + currency;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª (–¥–ª—è CSV - –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤, —á—Ç–æ–±—ã Excel –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª)
        function formatNumber(value) {
            if (typeof value !== 'number' || isNaN(value)) return '';
            
            // –î–ª—è —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª - –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Excel
            if (Number.isInteger(value)) {
                return value.toString();
            }
            
            // –î–ª—è –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–∫—É –¥–ª—è Excel (Excel —Å–∞–º –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç)
            return value.toFixed(2);
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
        function formatNumberDisplay(value) {
            if (typeof value !== 'number' || isNaN(value)) return '';
            
            // –î–ª—è —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
            if (Number.isInteger(value)) {
                return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            }
            
            // –î–ª—è –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö
            return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ').replace('.', ',');
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç
        function formatDate(dateString, format = 'ru-RU') {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                return date.toLocaleString(format, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch {
                return dateString;
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–æ–ª–æ–Ω–∫–∏
        function detectColumnType(header, sampleValue) {
            const headerLower = header.toLowerCase();
            
            // –î–µ–Ω–µ–∂–Ω—ã–µ —Å—É–º–º—ã
            if (headerLower.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å') || headerLower.includes('—Å—É–º–º–∞') || headerLower.includes('—Ü–µ–Ω–∞')) {
                return 'currency';
            }
            
            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞
            if (headerLower.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') || headerLower.includes('–∫–æ–ª-–≤–æ')) {
                return 'quantity';
            }
            
            // –î–∞—Ç—ã
            if (headerLower.includes('–¥–∞—Ç–∞') || headerLower.includes('–≤—Ä–µ–º—è')) {
                return 'date';
            }
            
            // –ß–∏—Å–ª–∞
            if (!isNaN(sampleValue) && sampleValue !== '') {
                return 'number';
            }
            
            return 'text';
        }
        
        // –û—á–∏—Å—Ç–∫–∞ Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function cleanMarkdownFormatting(text) {
            if (!text) return '';
            return text
                .replace(/\*\*/g, '')      // –£–±–∏—Ä–∞–µ–º –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç **
                .replace(/\*/g, '')        // –£–±–∏—Ä–∞–µ–º –∫—É—Ä—Å–∏–≤ *
                .replace(/`/g, '')         // –£–±–∏—Ä–∞–µ–º –∫–æ–¥ `
                .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')  // –£–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫–∏ [—Ç–µ–∫—Å—Ç](url) -> —Ç–µ–∫—Å—Ç
                .replace(/^#+\s+/gm, '')   // –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ # ## ###
                .replace(/^!!\s*/g, '')    // –£–±–∏—Ä–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã !!
                .trim();
                }
                
        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ CSV –∑–Ω–∞—á–µ–Ω–∏–π (–¥–ª—è —Ç–æ—á–∫–∏ —Å –∑–∞–ø—è—Ç–æ–π –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è)
        function escapeCSV(value) {
            if (value === null || value === undefined) {
                return '';
            }
            
            const str = String(value).trim();
            
            // –£–±–∏—Ä–∞–µ–º Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            let cleaned = cleanMarkdownFormatting(str);
            
            // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
            cleaned = cleaned.replace(/\s+/g, ' ');
            
            // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã
            if (!cleaned || cleaned.trim() === '') {
                return '';
                }
                
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ (—É–¥–≤–∞–∏–≤–∞–µ–º –∏—Ö)
            const escaped = cleaned.replace(/"/g, '""');
            
            // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π, –∑–∞–ø—è—Ç—É—é, –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏, –∫–∞–≤—ã—á–∫—É –∏–ª–∏ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ - –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –∫–∞–≤—ã—á–∫–∏
            if (escaped.includes(';') || 
                escaped.includes(',') || 
                escaped.includes('\n') || 
                escaped.includes('\r') || 
                escaped.includes('"') ||
                escaped.trim() !== escaped) {
                return `"${escaped}"`;
            }
            
            return escaped;
        }
        
        function exportChatCSV() {
            if (!currentChatId) {
                showWarning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) {
                showError('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `chat_${chat.title.replace(/[^a-z0-9]/gi, '_')}_${timestamp}.csv`;
            
            let csv = '–í—Ä–µ–º—è;–†–æ–ª—å;–°–æ–æ–±—â–µ–Ω–∏–µ;–§–∞–π–ª—ã;–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ\n';
            
            chat.messages.forEach(msg => {
                const msgTimestamp = msg.timestamp ? new Date(msg.timestamp).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const role = msg.isUser ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" : "AI";
                const text = (msg.text || '').replace(/\n/g, ' ').replace(/\r/g, '');
                const files = (msg.files || []).map(f => typeof f === 'string' ? f : (f.name || f)).join('; ');
                const edited = msg.edited ? '–î–∞' : '–ù–µ—Ç';
                
                csv += `${escapeCSV(msgTimestamp)};${escapeCSV(role)};${escapeCSV(text)};${escapeCSV(files)};${escapeCSV(edited)}\n`;
            });
            
            // –°–æ–∑–¥–∞–µ–º CSV —Å UTF-8 BOM –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Excel
            const BOM = '\uFEFF';
            const csvWithBOM = BOM + csv;
            
            // –°–æ–∑–¥–∞–µ–º Blob —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
            const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ
        function getBackgroundColorForExport() {
            const isDarkTheme = document.body.classList.contains('dark-theme');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ–Ω –æ–±–ª–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messagesArea = document.getElementById('chatMessages');
            if (messagesArea) {
                const bgColor = window.getComputedStyle(messagesArea).backgroundColor;
                if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
                    return bgColor;
                }
            }
            
            // –§–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
            return isDarkTheme ? '#1a1a1a' : '#ffffff';
        }
        
        // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è/–æ—Å–≤–µ—Ç–ª–µ–Ω–∏—è
        function removeAllVisualEffects(element) {
            const allElements = element.querySelectorAll('*');
            const elementsToClean = [element, ...Array.from(allElements)];
            
            elementsToClean.forEach(el => {
                const computedStyle = window.getComputedStyle(el);
                const elStyle = el.style;
                
                // –ê–ì–†–ï–°–°–ò–í–ù–û —É–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–µ–Ω–∏ —á–µ—Ä–µ–∑ inline —Å—Ç–∏–ª–∏
                elStyle.setProperty('box-shadow', 'none', 'important');
                elStyle.setProperty('-webkit-box-shadow', 'none', 'important');
                elStyle.setProperty('-moz-box-shadow', 'none', 'important');
                elStyle.setProperty('text-shadow', 'none', 'important');
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
                elStyle.setProperty('filter', 'none', 'important');
                elStyle.setProperty('-webkit-filter', 'none', 'important');
                elStyle.setProperty('-moz-filter', 'none', 'important');
                elStyle.setProperty('backdrop-filter', 'none', 'important');
                elStyle.setProperty('-webkit-backdrop-filter', 'none', 'important');
                
                // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                elStyle.setProperty('opacity', '1', 'important');
                
                // –£–±–∏—Ä–∞–µ–º blur –∏–∑ transform, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
                if (computedStyle.transform && computedStyle.transform.includes('blur')) {
                    const newTransform = computedStyle.transform.replace(/blur\([^)]+\)/g, '').trim();
                    if (newTransform) {
                        elStyle.setProperty('transform', newTransform, 'important');
                    } else {
                        elStyle.removeProperty('transform');
                    }
                }
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ overlay —ç–ª–µ–º–µ–Ω—Ç—ã
            const overlayElements = element.querySelectorAll('.chat-sidebar-overlay, [class*="overlay"], [class*="Overlay"]');
            overlayElements.forEach(overlay => {
                overlay.style.display = 'none';
                overlay.style.opacity = '0';
                overlay.style.visibility = 'hidden';
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DOM –æ—Ç –≤—Å–µ—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        function cleanClonedDOM(clonedDoc) {
            const clonedBody = clonedDoc.body || clonedDoc.documentElement;
            if (!clonedBody) return;
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ overlay —ç–ª–µ–º–µ–Ω—Ç—ã
            const overlays = clonedBody.querySelectorAll('.chat-sidebar-overlay, [class*="overlay"], [class*="Overlay"]');
            overlays.forEach(overlay => overlay.remove());
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
            const allElements = clonedBody.querySelectorAll('*');
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                const elStyle = el.style;
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–µ–Ω–∏
                if (style.boxShadow && style.boxShadow !== 'none') {
                    elStyle.setProperty('box-shadow', 'none', 'important');
                }
                if (style.textShadow && style.textShadow !== 'none') {
                    elStyle.setProperty('text-shadow', 'none', 'important');
                }
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
                if (style.filter && style.filter !== 'none') {
                    elStyle.setProperty('filter', 'none', 'important');
                }
                if (style.backdropFilter && style.backdropFilter !== 'none') {
                    elStyle.setProperty('backdrop-filter', 'none', 'important');
                }
                
                // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                if (style.opacity !== '1') {
                    elStyle.setProperty('opacity', '1', 'important');
                }
                
                // –£–±–∏—Ä–∞–µ–º blur –∏–∑ transform
                if (style.transform && style.transform.includes('blur')) {
                    const newTransform = style.transform.replace(/blur\([^)]+\)/g, '');
                    elStyle.setProperty('transform', newTransform || 'none', 'important');
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π CSS –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
            const style = clonedDoc.createElement('style');
            style.textContent = `
                *,
                *::before,
                *::after {
                    box-shadow: none !important;
                    text-shadow: none !important;
                    filter: none !important;
                    backdrop-filter: none !important;
                    opacity: 1 !important;
                }
                
                *::before,
                *::after {
                    display: none !important;
                    content: none !important;
                }
                
                /* –£–±–∏—Ä–∞–µ–º –≤—Å–µ overlay —ç–ª–µ–º–µ–Ω—Ç—ã */
                [class*="overlay"],
                [class*="Overlay"],
                .chat-sidebar-overlay {
                    display: none !important;
                    visibility: hidden !important;
                    opacity: 0 !important;
                }
                
                /* –£–±–∏—Ä–∞–µ–º blur –∏–∑ transform, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
                * {
                    -webkit-filter: none !important;
                    -moz-filter: none !important;
                    -ms-filter: none !important;
                    -o-filter: none !important;
                }
            `;
            clonedDoc.head.appendChild(style);
        }
        
        async function exportChatPNG() {
            if (!currentChatId) {
                showWarning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) {
                showError('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                if (typeof html2canvas === 'undefined') {
                    showError('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ html2canvas –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                    return;
                }
                
                // –ù–∞—Ö–æ–¥–∏–º –æ–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π
                const messagesArea = document.getElementById('chatMessages');
                if (!messagesArea) {
                    showError('–û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º
                const exportButtons = document.getElementById('chatExportAllButtons');
                if (exportButtons) {
                    exportButtons.style.display = 'none';
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                const allActionButtons = messagesArea.querySelectorAll('.chat-message-actions');
                allActionButtons.forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ overlay —ç–ª–µ–º–µ–Ω—Ç—ã
                const overlays = document.querySelectorAll('.chat-sidebar-overlay, [class*="overlay"], [class*="Overlay"]');
                overlays.forEach(overlay => {
                    overlay.style.display = 'none';
                });
                
                // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞–ø—Ä—è–º—É—é
                removeAllVisualEffects(messagesArea);
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
                const backgroundColor = getBackgroundColorForExport();
                
                // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                const canvas = await html2canvas(messagesArea, {
                    backgroundColor: backgroundColor,
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    height: messagesArea.scrollHeight,
                    width: messagesArea.scrollWidth,
                    windowHeight: messagesArea.scrollHeight,
                    windowWidth: messagesArea.scrollWidth,
                    removeContainer: false,
                    imageTimeout: 15000,
                    foreignObjectRendering: false,  // –û—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º overlay —ç–ª–µ–º–µ–Ω—Ç—ã
                    ignoreElements: (element) => {
                        return element.classList.contains('chat-sidebar-overlay') ||
                               element.classList.contains('chat-message-actions') ||
                               element.classList.contains('chatExportAllButtons') ||
                               /overlay/i.test(element.className);
                    },
                    // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DOM
                    onclone: (clonedDoc) => {
                        cleanClonedDOM(clonedDoc);
                    }
                });
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º canvas –≤ PNG
                canvas.toBlob((blob) => {
                    if (!blob) {
                        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                        if (exportButtons) {
                            exportButtons.style.display = 'flex';
                        }
                        allActionButtons.forEach(btn => {
                            btn.style.display = 'flex';
                        });
                        return;
                    }
                    
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `chat_${chat.title.replace(/[^a-z0-9]/gi, '_')}_${timestamp}.png`;
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                    if (exportButtons) {
                        exportButtons.style.display = 'flex';
                    }
                    allActionButtons.forEach(btn => {
                        btn.style.display = 'flex';
                    });
                }, 'image/png', 1.0); // –ö–∞—á–µ—Å—Ç–≤–æ 1.0 (100%)
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —á–∞—Ç–∞ –≤ PNG:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —á–∞—Ç–∞ –≤ PNG: ' + error.message);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Ç–∞–±–ª–∏—Ü—ã –≤ —Ç–µ–∫—Å—Ç–µ
        function hasTable(text) {
            if (!text) return false;
            
            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –µ—Å—Ç—å HTML —Ç–∞–±–ª–∏—Ü–∞, —ç—Ç–æ —Ç–æ—á–Ω–æ —Ç–∞–±–ª–∏—Ü–∞
            if (text.includes('<table') || text.includes('</table>')) {
                return true;
            }
            
            const lines = text.split('\n');
            let inCodeBlock = false;
            let tableRows = [];
            let foundSeparator = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞
                if (line.startsWith('```')) {
                    inCodeBlock = !inCodeBlock;
                    if (inCodeBlock) {
                        tableRows = []; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –±–ª–æ–∫ –∫–æ–¥–∞
                        foundSeparator = false;
                    }
                    continue;
                }
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
                if (inCodeBlock) {
                    continue;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º —Ç–∞–±–ª–∏—Ü—ã
                if (line.match(/^[\|\s\-\:]+$/) && line.includes('|') && line.includes('-')) {
                    // –≠—Ç–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç–∞–±–ª–∏—Ü—ã (|---|---|)
                    foundSeparator = true;
                    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º –±—ã–ª–∞ —Å—Ç—Ä–æ–∫–∞ —Å |, —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞
                    if (i > 0 && tableRows.length > 0) {
                        return true;
                    }
                    continue;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ —á–∞—Å—Ç—å—é —Ç–∞–±–ª–∏—Ü—ã
                if (line.includes('|')) {
                    const cells = line.split('|').map(c => c.trim()).filter(c => c.length > 0);
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∏–Ω–∏–º—É–º 2 —è—á–µ–π–∫–∏ (–Ω–µ —Å—á–∏—Ç–∞—è –ø—É—Å—Ç—ã–µ –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ), —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∞–±–ª–∏—Ü–∞
                    if (cells.length >= 2) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É
                        if (i < lines.length - 1) {
                            const nextLine = lines[i + 1].trim();
                            
                            // –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ - —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, —ç—Ç–æ —Ç–æ—á–Ω–æ —Ç–∞–±–ª–∏—Ü–∞
                            if (nextLine.match(/^[\|\s\-\:]+$/) && nextLine.includes('|') && nextLine.includes('-')) {
                                return true;
                            }
                            
                            // –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–æ–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç | —Å —è—á–µ–π–∫–∞–º–∏, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∞–±–ª–∏—Ü–∞
                            const nextCells = nextLine.split('|').map(c => c.trim()).filter(c => c.length > 0);
                            if (nextCells.length >= 2 && nextLine.includes('|')) {
                                // –ï—Å–ª–∏ –æ–±–µ —Å—Ç—Ä–æ–∫–∏ –∏–º–µ—é—Ç –ø–æ—Ö–æ–∂–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—á–µ–µ–∫, —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞
                                if (Math.abs(cells.length - nextCells.length) <= 1) {
                                    return true;
                                }
                            }
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã
                        tableRows.push(line);
                    }
                } else if (tableRows.length > 0) {
                    // –ï—Å–ª–∏ –Ω–∞–∫–æ–ø–∏–ª–∏ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ –Ω–µ-—Ç–∞–±–ª–∏—á–Ω—É—é —Å—Ç—Ä–æ–∫—É
                    if (foundSeparator || tableRows.length >= 2) {
                        return true;
                    }
                    tableRows = [];
                    foundSeparator = false;
                } else {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏ –Ω–µ-—Ç–∞–±–ª–∏—á–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                    foundSeparator = false;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –∫–æ–Ω—Ü–µ
            if (foundSeparator && tableRows.length > 0) {
                return true;
            }
            if (tableRows.length >= 2) {
                return true;
            }
            
            return false;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function exportMessageJSON(messageIndex) {
            if (!currentChatId || messageIndex < 0) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat || messageIndex >= chat.messages.length) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            
            const msg = chat.messages[messageIndex];
            if (msg.isUser) {
                showWarning('–ù–µ–ª—å–∑—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `message_${messageIndex}_${timestamp}.json`;
            
            const data = {
                message_index: messageIndex,
                chat_id: chat.id,
                chat_title: chat.title,
                timestamp: msg.timestamp,
                role: msg.isUser ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" : "AI",
                text: msg.text,
                files: msg.files || [],
                edited: msg.edited || false,
                edited_at: msg.edited_at || null
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            downloadFile(dataStr, filename, 'application/json');
        }
        
        async function exportMessageDOCX(messageIndex) {
            if (!currentChatId || messageIndex < 0) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat || messageIndex >= chat.messages.length) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            
            const msg = chat.messages[messageIndex];
            if (msg.isUser) {
                showWarning('–ù–µ–ª—å–∑—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ DOCX
                const response = await fetch('/api/export-chat-docx/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: `–°–æ–æ–±—â–µ–Ω–∏–µ ${messageIndex + 1} –∏–∑ —á–∞—Ç–∞: ${chat.title}`,
                        chat_id: chat.id,
                        messages: [msg]  // –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    })
                });
            
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ blob
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                link.href = url;
                link.download = `message_${messageIndex}_${timestamp}.docx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ DOCX:', error);
                showError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${error.message}`);
            }
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ Markdown —Ç–∞–±–ª–∏—Ü—ã
        function parseMarkdownTable(text) {
            const lines = text.split('\n');
            const rows = [];
            let inTable = false;
            let inCodeBlock = false;
            
            for (const line of lines) {
                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞
                if (line.trim().startsWith('```')) {
                    inCodeBlock = !inCodeBlock;
                    if (inCodeBlock) {
                        inTable = false;
                    }
                    continue;
                }
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
                if (inCodeBlock) {
                    continue;
                }
                
                const trimmed = line.trim();
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã (|---|---|)
                if (trimmed.match(/^[\|\s\-\:]+$/)) {
                    continue;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ —á–∞—Å—Ç—å—é —Ç–∞–±–ª–∏—Ü—ã
                if (trimmed.includes('|') && trimmed.split('|').length >= 3) {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —è—á–µ–π–∫–∏
                    const allCells = trimmed.split('|');
                    let cells = allCells.map(cell => cell.trim());
                    
                    // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –Ω–∞ –∫—Ä–∞—è—Ö
                    while (cells.length > 0 && cells[0] === '') {
                        cells = cells.slice(1);
                    }
                    while (cells.length > 0 && cells[cells.length - 1] === '') {
                        cells = cells.slice(0, -1);
                    }
                    
                    if (cells.length > 0) {
                        // –£–±–∏—Ä–∞–µ–º Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ —è—á–µ–µ–∫
                        const cleanedCells = cells.map(cell => cleanMarkdownFormatting(cell));
                        rows.push(cleanedCells);
                        inTable = true;
                    }
                } else if (inTable && trimmed.length === 0) {
                    // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã - —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
                    break;
                } else if (inTable && trimmed.length > 0) {
                    // –ù–µ–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ | –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã - —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
                    break;
                }
            }
            
            return rows;
        }
        
        // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ CSV –∏–∑ —Ç–∞–±–ª–∏—Ü—ã —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ Excel
        const CSV_SEPARATOR = ';';
        
        function formatTableAsCSV(rows, options = {}) {
            if (rows.length === 0) return '';
            
            const {
                title = '',
                metadata = {},
                groupBy = null,  // –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
                sortBy = null,   // –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                formatNumbers = true,
                formatCurrency = false,
                includeMetadata = false  // –í–∫–ª—é—á–∞—Ç—å –ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ CSV
            } = options;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫
            const maxColumns = Math.max(...rows.map(row => row.length));
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –¥–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫
            let normalizedRows = rows.map(row => {
                const normalized = [...row];
                while (normalized.length < maxColumns) {
                    normalized.push('');
                }
                return normalized;
            });
            
            let csv = '';
            
            // 1. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã, –∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –º–µ—à–∞–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –∫–æ–ª–æ–Ω–æ–∫)
            if (includeMetadata) {
                if (title) {
                    csv += `"–ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${title}"\n`;
                }
                
                if (metadata.date) {
                    const date = formatDate(metadata.date);
                    csv += `"–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${date}"\n`;
                }
                
                if (metadata.source) {
                    csv += `"–ò—Å—Ç–æ—á–Ω–∏–∫: ${metadata.source}"\n`;
                }
                
                if (metadata.chatTitle) {
                    csv += `"–ß–∞—Ç: ${metadata.chatTitle}"\n`;
                }
                
                if (title || metadata.date || metadata.source || metadata.chatTitle) {
                    csv += '\n'; // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                }
            }
            
            // 2. –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
            const headerRow = normalizedRows[0];
            const formattedHeaders = headerRow.map(header => {
                // –û—á–∏—â–∞–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                let cleaned = cleanMarkdownFormatting(header);
                // –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∑–∞–≥–ª–∞–≤–Ω–æ–π
                if (cleaned.length > 0) {
                    cleaned = cleaned.charAt(0).toUpperCase() + cleaned.slice(1).toLowerCase();
                }
                return escapeCSV(cleaned);
            });
            csv += formattedHeaders.join(CSV_SEPARATOR) + '\n';
            
            // 3. –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            let dataRows = normalizedRows.slice(1);
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            if (sortBy !== null) {
                const sortIndex = headerRow.findIndex(h => 
                    cleanMarkdownFormatting(h).toLowerCase().includes(sortBy.toLowerCase())
                );
                if (sortIndex >= 0) {
                    dataRows.sort((a, b) => {
                        const aVal = a[sortIndex];
                        const bVal = b[sortIndex];
                        // –ß–∏—Å–ª–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                        const aNum = parseFloat(aVal);
                        const bNum = parseFloat(bVal);
                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            return aNum - bNum;
                        }
                        // –¢–µ–∫—Å—Ç–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                        return String(aVal).localeCompare(String(bVal), 'ru');
                    });
                }
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            dataRows.forEach((row, rowIndex) => {
                const formattedRow = row.map((cell, colIndex) => {
                    let value = cell;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
                    const header = cleanMarkdownFormatting(headerRow[colIndex] || '').toLowerCase();
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—É–º–º—ã (–¥–ª—è CSV - –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ, Excel —Å–∞–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç)
                    if (formatCurrency && (header.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å') || 
                        header.includes('—Å—É–º–º–∞') || header.includes('—Ü–µ–Ω–∞'))) {
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue)) {
                            // –î–ª—è CSV –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ, Excel —Å–∞–º —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç
                            return escapeCSV(numValue.toFixed(2));
                        }
                    }
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞ (–¥–ª—è CSV - –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                    if (formatNumbers && !isNaN(value) && value !== '' && !header.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ')) {
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue) && numValue !== 0) {
                            // –î–ª—è CSV –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ, Excel —Å–∞–º —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç
                            return escapeCSV(numValue.toString());
                        }
                    }
                    
                    return escapeCSV(value);
                });
                
                csv += formattedRow.join(CSV_SEPARATOR) + '\n';
                
                // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –∫–æ–ª–æ–Ω–æ–∫ –≤ Excel
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤–∏–¥–Ω–∞ –ø–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º –≤ –∫–æ–ª–æ–Ω–∫–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
            });
            
            return csv;
        }
        
        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ CSV —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º
        function extractChartDataForCSV(messageIndex, options = {}) {
            const messageDiv = document.querySelector(`[data-message-index="${messageIndex}"]`);
            if (!messageDiv) return null;
            
            // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞
            const chartContainer = messageDiv.querySelector('.chart-container');
            if (!chartContainer) return null;
            
            const canvas = chartContainer.querySelector('canvas');
            if (!canvas) return null;
            
            // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ Chart.js
            if (typeof Chart === 'undefined' || !Chart.getChart) {
                return null;
            }
            
            const chartInstance = Chart.getChart(canvas);
            if (!chartInstance) return null;
            
            const chartType = chartInstance.config.type;
            const chartData = chartInstance.data;
            
            const {
                title = '–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞',
                includeStatistics = true,  // –î–æ–±–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                sortData = false,           // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                formatNumbers = true,       // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–∞
                metadata = {}
            } = options;
            
            let csvRows = [];
            let csv = '';
            
            try {
                switch (chartType) {
                    case 'bar':
                    case 'line':
                        csvRows.push(['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ó–Ω–∞—á–µ–Ω–∏–µ']);
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        let data = [];
                        if (chartData.labels && chartData.datasets && chartData.datasets[0] && chartData.datasets[0].data) {
                            chartData.labels.forEach((label, index) => {
                                const value = chartData.datasets[0].data[index];
                                if (value !== undefined && value !== null) {
                                    data.push({ label, value });
                                }
                            });
                        }
                        
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é (—É–±—ã–≤–∞–Ω–∏–µ)
                        if (sortData && data.length > 0) {
                            data.sort((a, b) => b.value - a.value);
                        }
                        
                        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏
                        data.forEach(item => {
                            // –î–ª—è CSV –Ω–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏, —á—Ç–æ–±—ã Excel –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Ö —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª
                            const formattedValue = formatNumbers && typeof item.value === 'number' 
                                ? item.value.toString()  // –ü—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                                : item.value;
                            csvRows.push([item.label, formattedValue]);
                        });
                        
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                            if (includeStatistics && data.length > 0) {
                                const values = data.map(d => d.value);
                                const total = values.reduce((a, b) => a + b, 0);
                                const avg = total / values.length;
                                const max = Math.max(...values);
                                const min = Math.min(...values);
                                
                                // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –∫–æ–ª–æ–Ω–æ–∫
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–∞ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Excel
                                csvRows.push(['–ò–¢–û–ì–û', formatNumbers ? total.toString() : total]);
                                csvRows.push(['–°–†–ï–î–ù–ï–ï', formatNumbers ? avg.toFixed(2) : avg.toFixed(2)]);
                                csvRows.push(['–ú–ê–ö–°–ò–ú–£–ú', formatNumbers ? max.toString() : max]);
                                csvRows.push(['–ú–ò–ù–ò–ú–£–ú', formatNumbers ? min.toString() : min]);
                            }
                    break;
                        
                    case 'pie':
                    case 'doughnut':
                        csvRows.push(['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ó–Ω–∞—á–µ–Ω–∏–µ', '–ü—Ä–æ—Ü–µ–Ω—Ç', '–î–æ–ª—è']);
                        
                        let pieData = [];
                        if (chartData.labels && chartData.datasets && chartData.datasets[0] && chartData.datasets[0].data) {
                            const dataValues = chartData.datasets[0].data;
                            const total = dataValues.reduce((a, b) => (a || 0) + (b || 0), 0);
                            
                            chartData.labels.forEach((label, index) => {
                                const value = dataValues[index];
                                if (value !== undefined && value !== null) {
                                    const percent = total > 0 ? ((value / total) * 100) : 0;
                                    pieData.push({
                                        label,
                                        value,
                                        percent: percent.toFixed(2) + '%',
                                        share: (percent / 100).toFixed(4)
                                    });
                                }
                            });
                        }
                        
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é
                        if (sortData && pieData.length > 0) {
                            pieData.sort((a, b) => b.value - a.value);
                        }
                        
                        pieData.forEach(item => {
                            // –î–ª—è CSV –Ω–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏, —á—Ç–æ–±—ã Excel –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Ö —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª
                            const formattedValue = formatNumbers && typeof item.value === 'number'
                                ? item.value.toString()  // –ü—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                                : item.value;
                            csvRows.push([
                                item.label,
                                formattedValue,
                                item.percent,
                                item.share
                            ]);
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                        if (pieData.length > 0) {
                            const total = pieData.reduce((sum, item) => sum + item.value, 0);
                            // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –∫–æ–ª–æ–Ω–æ–∫
                            csvRows.push(['–ò–¢–û–ì–û', formatNumbers ? total.toString() : total, '100%', '1.0000']);
                        }
                        break;
                        
                    default:
                        return null;
                }
                
                if (csvRows.length > 1) {
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –±–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –∫–æ–ª–æ–Ω–æ–∫)
                    csv = formatTableAsCSV(csvRows, { 
                        formatNumbers: false, 
                        formatCurrency: false,
                        includeMetadata: false  // –ù–µ –≤–∫–ª—é—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ CSV
                    });
                    
                    return csv;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                return null;
            }
            
            return null;
        }
        
        function exportMessageCSV(messageIndex) {
            if (!currentChatId || messageIndex < 0) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
                    }
            
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat || messageIndex >= chat.messages.length) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
                }
                
            const msg = chat.messages[messageIndex];
            if (msg.isUser) {
                showWarning('–ù–µ–ª—å–∑—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            let filename = `message_${messageIndex}_${timestamp}.csv`;
            let csv = '';
            
            // –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            const metadata = {
                date: msg.timestamp || new Date().toISOString(),
                source: '–ê–ª—å—Ñ–∞-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç',
                chatTitle: chat.title
            };
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
            const chartData = extractChartDataForCSV(messageIndex, {
                title: `–ì—Ä–∞—Ñ–∏–∫ –∏–∑ —á–∞—Ç–∞: ${chat.title}`,
                includeStatistics: true,
                sortData: true,
                formatNumbers: true,
                metadata: metadata
            });
            
            if (chartData) {
                csv = chartData;
                filename = `chart_${messageIndex}_${timestamp}.csv`;
            } else {
                // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ —Ç–µ–∫—Å—Ç–µ
                const text = msg.text || '';
                const tableRows = parseMarkdownTable(text);
                
                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                console.log('–ü–∞—Ä—Å–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è CSV:', {
                    textLength: text.length,
                    tableRowsCount: tableRows.length,
                    firstRows: tableRows.slice(0, 3)
                });
                
                if (tableRows.length > 0) {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–µ–Ω–µ–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
                    const headers = tableRows[0].map(h => cleanMarkdownFormatting(h).toLowerCase());
                    const hasCurrency = headers.some(h => 
                        h.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å') || h.includes('—Å—É–º–º–∞') || h.includes('—Ü–µ–Ω–∞')
                    );
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å "–ü–∞–ø–∫–∞" –∏–ª–∏ "–ö–∞—Ç–µ–≥–æ—Ä–∏—è")
                    const groupByColumn = headers.find(h => 
                        h.includes('–ø–∞–ø–∫–∞') || h.includes('–∫–∞—Ç–µ–≥–æ—Ä–∏—è') || h.includes('–≥—Ä—É–ø–ø–∞')
                    );
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —Ç–æ–≤–∞—Ä)
                    const sortByColumn = headers.find(h => 
                        h.includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') || h.includes('—Ç–æ–≤–∞—Ä') || h.includes('–∏–º—è')
                    );
                    
                    csv = formatTableAsCSV(tableRows, {
                        title: `–¢–∞–±–ª–∏—Ü–∞ –∏–∑ —á–∞—Ç–∞: ${chat.title}`,
                        metadata: metadata,
                        groupBy: groupByColumn || null,
                        sortBy: sortByColumn || null,
                        formatNumbers: true,
                        formatCurrency: hasCurrency,
                        includeMetadata: false  // –ù–µ –≤–∫–ª—é—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –∫–æ–ª–æ–Ω–æ–∫
                    });
                } else {
                    // 3. –ï—Å–ª–∏ –Ω–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –∏ –≥—Ä–∞—Ñ–∏–∫–∞ - —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const msgTimestamp = formatDate(msg.timestamp || new Date().toISOString());
                    csv = '–í—Ä–µ–º—è;–†–æ–ª—å;–°–æ–æ–±—â–µ–Ω–∏–µ;–§–∞–π–ª—ã;–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ\n';
                    const files = (msg.files || []).map(f => typeof f === 'string' ? f : (f.name || f)).join('; ');
                    csv += `${escapeCSV(msgTimestamp)};${escapeCSV('AI')};${escapeCSV(msg.text || '')};${escapeCSV(files)};${escapeCSV(msg.edited ? '–î–∞' : '–ù–µ—Ç')}\n`;
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º UTF-8 BOM –¥–ª—è Excel
            const BOM = '\uFEFF';
            const csvWithBOM = BOM + csv;
            
            // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        async function exportMessagePNG(messageIndex) {
            if (!currentChatId || messageIndex < 0) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat || messageIndex >= chat.messages.length) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            
            const msg = chat.messages[messageIndex];
            if (msg.isUser) {
                showWarning('–ù–µ–ª—å–∑—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                if (typeof html2canvas === 'undefined') {
                    showError('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ html2canvas –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                    return;
                }
                
                // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ DOM
                const messagesArea = document.getElementById('chatMessages');
                if (!messagesArea) {
                    showError('–û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                const messageDivs = messagesArea.querySelectorAll('.chat-message');
                if (messageIndex >= messageDivs.length) {
                    showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DOM');
                    return;
                }
                
                const messageDiv = messageDivs[messageIndex];
                if (!messageDiv) {
                    showError('–≠–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º
                const actionsDiv = messageDiv.querySelector('.chat-message-actions');
                if (actionsDiv) {
                    actionsDiv.style.display = 'none';
                }
                
                // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞–ø—Ä—è–º—É—é
                removeAllVisualEffects(messageDiv);
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
                const backgroundColor = getBackgroundColorForExport();
                
                // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                const canvas = await html2canvas(messageDiv, {
                    backgroundColor: backgroundColor,
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    width: messageDiv.scrollWidth,
                    height: messageDiv.scrollHeight,
                    removeContainer: false,
                    imageTimeout: 15000,
                    foreignObjectRendering: false,  // –û—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                    ignoreElements: (element) => {
                        return element.classList.contains('chat-message-actions') ||
                               element.classList.contains('chat-sidebar-overlay') ||
                               /overlay/i.test(element.className);
                    },
                    // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DOM
                    onclone: (clonedDoc) => {
                        cleanClonedDOM(clonedDoc);
                    }
                });
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º canvas –≤ PNG
                canvas.toBlob((blob) => {
                    if (!blob) {
                        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                        if (actionsDiv) {
                            actionsDiv.style.display = 'flex';
                        }
                        return;
                    }
                    
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `message_${messageIndex}_${timestamp}.png`;
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                    if (actionsDiv) {
                        actionsDiv.style.display = 'flex';
                    }
                }, 'image/png', 1.0); // –ö–∞—á–µ—Å—Ç–≤–æ 1.0 (100%)
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ PNG:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ PNG: ' + error.message);
            }
        }
        
        function showEditMessageModal(messageIndex) {
            editingMessageIndex = messageIndex;
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat || messageIndex < 0 || messageIndex >= chat.messages.length) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            
            const message = chat.messages[messageIndex];
            if (!message.isUser) {
                showWarning('–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            const textarea = document.getElementById('editMessageText');
            if (textarea) {
                textarea.value = message.text || '';
            }
            
            const modal = document.getElementById('editMessageModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        function closeEditMessageModal() {
            editingMessageIndex = -1;
            const modal = document.getElementById('editMessageModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function saveEditedMessage() {
            if (editingMessageIndex < 0) {
                closeEditMessageModal();
                return;
            }
            
            const textarea = document.getElementById('editMessageText');
            const newText = textarea ? textarea.value.trim() : '';
            
            if (!newText) {
                showWarning('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat || editingMessageIndex >= chat.messages.length) {
                showError('–û—à–∏–±–∫–∞: —á–∞—Ç –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                closeEditMessageModal();
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            chat.messages[editingMessageIndex].text = newText;
            chat.messages[editingMessageIndex].edited = true;
            chat.messages[editingMessageIndex].edited_at = new Date().toISOString();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            saveChats();
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç
            loadChat(currentChatId, false);
            closeEditMessageModal();
            
            console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ');
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π AI –≤ localStorage
        function logAIAction(action, data) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                if (!email) return;
                
                const key = `ai_actions_${email}`;
                const actions = JSON.parse(localStorage.getItem(key) || '[]');
                
                actions.push({
                    action: action,
                    data: data,
                    timestamp: new Date().toISOString(),
                    chat_id: currentChatId
                });
                
                // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –¥–µ–π—Å—Ç–≤–∏–π
                if (actions.length > 1000) {
                    actions.shift();
                }
                
                localStorage.setItem(key, JSON.stringify(actions));
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è AI:', error);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ action –∏–∑ URL (–±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
        function handleQuickAction() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (!action) return;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ–π—Å—Ç–≤–∏—è
            let message = '';
            switch(action) {
                case 'analyze':
                    message = '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–∫–∞–∂–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏';
                    break;
                case 'report':
                    message = '–°–æ–∑–¥–∞–π –æ—Ç—á–µ—Ç –ø–æ –º–æ–µ–º—É –±–∏–∑–Ω–µ—Å—É';
                    break;
                case 'plan':
                    message = '–ü–æ–º–æ–≥–∏ –º–Ω–µ —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–ª–∞ –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è';
                    break;
                case 'question':
                    message = '';
                    // –î–ª—è –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –≤–≤–µ–¥–µ—Ç
                    return;
                default:
                    return;
            }
            
            // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (!message) return;
            
            // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞ –∏ –∑–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            setTimeout(() => {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!currentChatId || chats.length === 0) {
                    createNewChat();
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                const input = document.getElementById('chatInput');
                if (input) {
                    input.value = message;
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    setTimeout(() => {
                        sendMessage();
                    }, 300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
                }
                
                // –£–¥–∞–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL, —á—Ç–æ–±—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
                window.history.replaceState({}, document.title, window.location.pathname);
            }, 500);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function initChat() {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            chats = getUserChats();
            
            // –û—á–∏—â–∞–µ–º filesData –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ —Ç–∞–º –µ—Å—Ç—å)
            chats = chats.map(chat => ({
                ...chat,
                messages: chat.messages.map(msg => {
                    const { filesData, ...msgWithoutFilesData } = msg;
                    return msgWithoutFilesData;
                })
            }));
            
            favorites = getUserFavorites();
            pinnedChats = getUserPinnedChats();
            
            renderChatHistory();
            if (chats.length > 0) {
                loadChat(chats[0].id, true); // –í—Å–µ–≥–¥–∞ —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –µ—Å–ª–∏ –Ω–µ—Ç —á–∞—Ç–æ–≤
                renderCapabilityMessages();
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –µ—Å–ª–∏ –Ω–µ—Ç —á–∞—Ç–æ–≤
                toggleChatExportButtons();
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            restoreActiveRequests();
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ URL
            handleQuickAction();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
        function createNewChat() {
            const chatId = 'chat_' + Date.now();
            const newChat = {
                id: chatId,
                title: '–ù–æ–≤—ã–π —á–∞—Ç',
                messages: [],
                createdAt: new Date().toISOString()
            };
            chats.unshift(newChat);
            saveChats();
            loadChat(chatId);
            renderChatHistory();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Ç–æ–≤ (–±–µ–∑ –¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –≤ localStorage)
        function saveChats() {
            // –û—á–∏—â–∞–µ–º filesData –∏–∑ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            const chatsToSave = chats.map(chat => ({
                ...chat,
                messages: chat.messages.map(msg => {
                    const { filesData, ...msgWithoutFilesData } = msg;
                    return msgWithoutFilesData;
                })
            }));
            saveUserChats(chatsToSave);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ localStorage (–≤—ã–∑—ã–≤–∞—Ç—å –æ–¥–∏–Ω —Ä–∞–∑)
        function cleanupOldFileData() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                if (!email) return;
                
                const key = `chats_${email}`;
                const savedChats = JSON.parse(localStorage.getItem(key) || '[]');
                
                if (savedChats.length > 0) {
                    const cleanedChats = savedChats.map(chat => ({
                        ...chat,
                        messages: chat.messages.map(msg => {
                            const { filesData, ...msgWithoutFilesData } = msg;
                            return msgWithoutFilesData;
                        })
                    }));
                    
                    localStorage.setItem(key, JSON.stringify(cleanedChats));
                    console.log('–û—á–∏—â–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ localStorage');
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ–≥–æ —á–∞—Ç–∞
        function toggleChatExportButtons() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ
            const exportButton = document.getElementById('chatExportBtn');
            if (exportButton) {
                if (currentChatId && chats.find(c => c.id === currentChatId)) {
                    exportButton.style.display = 'flex';
                } else {
                    exportButton.style.display = 'none';
                }
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞
            const oldExportButton = document.getElementById('chatExportAllButton');
            if (oldExportButton) {
                oldExportButton.style.display = 'none';
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ —á–∞—Ç–∞
        function showExportChatModal() {
            const modal = document.getElementById('exportChatModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ —á–∞—Ç–∞
        function closeExportChatModal() {
            const modal = document.getElementById('exportChatModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            const exportModal = document.getElementById('exportChatModal');
            if (exportModal && event.target === exportModal) {
                closeExportChatModal();
            }
        });
        
        // –°–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ —á–∞—Ç–∞
        const capabilityMessages = [
            '–ü–æ–∫–∞–∂–∏ –±–∞–ª–∞–Ω—Å –º–æ–∏—Ö —Å—á–µ—Ç–æ–≤',
            '–ö–∞–∫–∏–µ —É –º–µ–Ω—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –Ω–∞–ª–æ–≥–∞–º?',
            '–°–∫–æ–ª—å–∫–æ —è –ø–æ—Ç—Ä–∞—Ç–∏–ª –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ?',
            '–ü–æ–∫–∞–∂–∏ —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤',
            '–ö–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –µ—Å—Ç—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏?',
            '–°–æ–∑–¥–∞–π –≤—Å—Ç—Ä–µ—á—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤ 15:00',
            '–ü–æ–∫–∞–∂–∏ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ',
            '–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —É –º–µ–Ω—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã?'
        ];
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏
        function renderCapabilityMessages() {
            const messagesArea = document.getElementById('chatMessages');
            if (!messagesArea) return;
            
            messagesArea.innerHTML = `
                <div class="chat-ai-widget-main" id="chatWelcome">
                    <div class="chat-ai-icon-main">
                        <span class="chat-ai-icon-text-main">AI</span>
                    </div>
                    <div class="chat-ai-prompt">–° —á–µ–≥–æ –Ω–∞—á–Ω—ë–º, –ë–æ—Å—Å?</div>
                </div>
                <div class="chat-capability-messages" id="chatCapabilityMessages">
                    ${capabilityMessages.map((message, index) => `
                        <div class="chat-capability-message" onclick="sendCapabilityMessage('${message.replace(/'/g, "\\'")}')">
                            ${message}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
        function sendCapabilityMessage(messageText) {
            const input = document.getElementById('chatInput');
            input.value = messageText;
            sendMessage();
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ onclick
        window.sendCapabilityMessage = sendCapabilityMessage;
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
        function toggleSuggestionsModal() {
            const modal = document.getElementById('suggestionsModal');
            const modalBody = document.getElementById('suggestionsModalBody');
            
            if (modal.style.display === 'none' || !modal.style.display) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.style.display = 'flex';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
                modalBody.innerHTML = capabilityMessages.map((message, index) => `
                    <div class="suggestion-modal-item" onclick="selectSuggestion('${message.replace(/'/g, "\\'")}')">
                        ${message}
                    </div>
                `).join('');
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.style.display = 'none';
            }
        }
        
        function selectSuggestion(messageText) {
            const input = document.getElementById('chatInput');
            input.value = messageText;
            toggleSuggestionsModal(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            input.focus(); // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ onclick
        window.toggleSuggestionsModal = toggleSuggestionsModal;
        window.selectSuggestion = selectSuggestion;
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('suggestionsModal');
            const modalContent = document.querySelector('.suggestions-modal-content');
            if (modal && event.target === modal) {
                toggleSuggestionsModal();
            }
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞
        function loadChat(chatId, scrollToBottom = true) {
            currentChatId = chatId;
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            const messagesArea = document.getElementById('chatMessages');
            const welcomeDiv = document.getElementById('chatWelcome');

            if (chat.messages.length === 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
                renderCapabilityMessages();
            } else {
                messagesArea.innerHTML = '';
                chat.messages.forEach((msg, index) => {
                    addMessageToUI(msg.text, msg.isUser, msg.files || null, msg.filesData || null, false, index);
                });
                
                // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (scrollToBottom) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            scrollToBottomMessages(true);
                        });
                    });
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                    setTimeout(() => {
                        scrollToBottomMessages(true);
                    }, 50);
                    setTimeout(() => {
                        scrollToBottomMessages(true);
                    }, 200);
                    setTimeout(() => {
                        scrollToBottomMessages(true);
                    }, 500);
                }
            }
            
            updateActiveChat();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
            toggleChatExportButtons();
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            loadChatHistoryFromServer();
        }
        
        async function loadChatHistoryFromServer() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const email = currentUser.email || '';
                if (!email || !currentChatId) return;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
                if (typeof showLoading === 'function') {
                    showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞...');
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è URL –±–µ–∑ credentials
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å credentials
                const apiPath = '/api/chat-history/';
                const queryString = 'email=' + encodeURIComponent(email);
                const fullUrl = apiPath + '?' + queryString;
                
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                const data = await response.json();
                if (data.success && data.history.length > 0) {
                    const historyItem = data.history.find(h => h.chat_id === currentChatId);
                    if (historyItem) {
                        currentChatHistoryId = historyItem.id;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                if (typeof hideLoading === 'function') {
                    hideLoading();
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–≥–æ —á–∞—Ç–∞
        function updateMessageText(messageIndex, newText, autoScroll = true) {
            const messagesArea = document.getElementById('chatMessages');
            if (!messagesArea) return;
            
            const messageDiv = messagesArea.querySelector(`[data-message-index="${messageIndex}"]`);
            if (messageDiv) {
                const messageTextDiv = messageDiv.querySelector('.chat-message-text');
                if (messageTextDiv) {
                    if (newText === '–î—É–º–∞—é...') {
                        // –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è "–î—É–º–∞—é..." –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ markdown
                        messageTextDiv.textContent = newText;
                    } else {
                        // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º markdown
                        messageTextDiv.innerHTML = markdownToHTML(newText);
                    }
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –∏ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ DOM
                    if (autoScroll) {
                        // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ requestAnimationFrame –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                scrollToBottomMessages(true);
                            });
                        });
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (50ms, 200ms)
                        setTimeout(() => {
                            scrollToBottomMessages(true);
                        }, 50);
                        setTimeout(() => {
                            scrollToBottomMessages(true);
                        }, 200);
                    }
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ –≤–Ω–∏–∑ –æ–±–ª–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        function scrollToBottomMessages(force = false) {
            const messagesArea = document.getElementById('chatMessages');
            if (!messagesArea) return;
            
            const scrollHeight = messagesArea.scrollHeight;
            const clientHeight = messagesArea.clientHeight;
            const scrollTop = messagesArea.scrollTop;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–∏–∑—É (—Å –Ω–µ–±–æ–ª—å—à–∏–º –¥–æ–ø—É—Å–∫–æ–º –≤ 100px)
            const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–Ω–∏–∑—É
            if (force || isNearBottom) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π scrollTop –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                // –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
                messagesArea.scrollTop = scrollHeight;
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            if (!message && (!attachedFiles || attachedFiles.length === 0)) {
                return;
            }

            if (!currentChatId) {
                createNewChat();
            }

            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) {
                console.error('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
            const filesToSend = attachedFiles ? [...attachedFiles] : [];
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB –Ω–∞ —Ñ–∞–π–ª
            const MAX_TOTAL_SIZE = 40 * 1024 * 1024; // 40 MB –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä
            
            let totalSize = 0;
            for (const file of filesToSend) {
                if (file.size > MAX_FILE_SIZE) {
                    showWarning(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${formatFileSize(file.size)}). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${formatFileSize(MAX_FILE_SIZE)}`);
                    return;
                }
                totalSize += file.size;
            }
            
            if (totalSize > MAX_TOTAL_SIZE) {
                showWarning(`–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ (${formatFileSize(totalSize)}) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∏–º–∏—Ç (${formatFileSize(MAX_TOTAL_SIZE)}). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤.`);
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            const sendButton = document.getElementById('chatSendBtn');
            if (sendButton && typeof showButtonLoading === 'function') {
                showButtonLoading(sendButton, '–û—Ç–ø—Ä–∞–≤–∏—Ç—å');
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userMessage = {
                text: message || (filesToSend.length > 0 ? '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã' : ''),
                isUser: true,
                timestamp: new Date().toISOString(),
                files: filesToSend.map(f => ({
                    name: f.name,
                    size: f.size,
                    type: f.type
                }))
            };
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º base64 –≤ localStorage!)
            if (filesToSend.length > 0) {
                Promise.all(filesToSend.map(fileObj => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            resolve({
                                name: fileObj.name,
                                size: fileObj.size,
                                type: fileObj.type,
                                data: e.target.result  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                            });
                        };
                        reader.onerror = function(e) {
                            reject(e);
                        };
                        reader.readAsDataURL(fileObj.file);
                    });
                })).then(filesData => {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ë–ï–ó filesData (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å localStorage)
                    // filesData –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    chat.messages.push(userMessage);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ (–ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
                    const displayText = message || (filesToSend.length > 0 ? filesToSend[0].name : '');
                    if (chat.title === '–ù–æ–≤—ã–π —á–∞—Ç' && displayText.length > 30) {
                        chat.title = displayText.substring(0, 30) + '...';
                    } else if (chat.title === '–ù–æ–≤—ã–π —á–∞—Ç') {
                        chat.title = displayText;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç AI (–ø–æ–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è)
                    const aiMessage = {
                        text: '–î—É–º–∞—é...',
                        isUser: false,
                        timestamp: new Date().toISOString()
                    };
                    chat.messages.push(aiMessage);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Ç –ë–ï–ó –¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                    saveChats();
                    loadChat(currentChatId, true); // –í—Å–µ–≥–¥–∞ —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ AI —Å —Ñ–∞–π–ª–∞–º–∏ (filesData –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage)
                    sendMessageToAI(message, chat.messages.slice(0, -1), currentChatId, filesData);
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    setTimeout(() => {
                        scrollToBottomMessages(true);
                    }, 200);
                    
                    input.value = '';
                    attachedFiles = [];
                    renderAttachedFiles();
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
                    if (sendButton && typeof hideButtonLoading === 'function') {
                        hideButtonLoading(sendButton);
                    }
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤:', error);
                    const errorMessage = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    showError(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤:\n\n${errorMessage}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ 10MB)\n- –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–æ–≤\n- –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π`);
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    if (sendButton && typeof hideButtonLoading === 'function') {
                        hideButtonLoading(sendButton);
                    }
                });
            } else {
                // –ù–µ—Ç —Ñ–∞–π–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                chat.messages.push(userMessage);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ (–ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
                if (chat.title === '–ù–æ–≤—ã–π —á–∞—Ç' && message.length > 30) {
                    chat.title = message.substring(0, 30) + '...';
                } else if (chat.title === '–ù–æ–≤—ã–π —á–∞—Ç') {
                    chat.title = message;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç AI (–ø–æ–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è)
                const aiMessage = {
                    text: '–î—É–º–∞—é...',
                    isUser: false,
                    timestamp: new Date().toISOString()
                };
                chat.messages.push(aiMessage);
                saveChats();
                loadChat(currentChatId, true); // –í—Å–µ–≥–¥–∞ —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ AI
                sendMessageToAI(message, chat.messages.slice(0, -1), currentChatId, []);
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(() => {
                    scrollToBottomMessages(true);
                }, 200);
                
                input.value = '';
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ (–±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞)
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ sendMessageToAI –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ AI
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏
        async function createInventoryFolderFromAI(folderData) {
            console.log('=== createInventoryFolderFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            console.log('–î–∞–Ω–Ω—ã–µ –ø–∞–ø–∫–∏:', folderData);
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `inventoryFolders_${email}`;
                const folders = JSON.parse(localStorage.getItem(key) || '[]');
                
                const newFolder = {
                    id: Date.now() + Math.random(),
                    name: folderData.name || '–ù–æ–≤–∞—è –ø–∞–ø–∫–∞'
                };
                
                folders.push(newFolder);
                localStorage.setItem(key, JSON.stringify(folders));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                window.dispatchEvent(new CustomEvent('inventoryUpdated'));
                
                console.log('‚úÖ –ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞:', newFolder);
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∞–ø–∫–∏:', error);
                return false;
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏
        async function deleteInventoryFolderFromAI(folderData) {
            console.log('=== deleteInventoryFolderFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `inventoryFolders_${email}`;
                const folders = JSON.parse(localStorage.getItem(key) || '[]');
                const folderIndex = folders.findIndex(f => String(f.id) === String(folderData.id));
                
                if (folderIndex === -1) {
                    console.error('–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', folderData.id);
                    return false;
                }
                
                // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ —ç—Ç–æ–π –ø–∞–ø–∫–∏
                const inventoryKey = `inventory_${email}`;
                const inventory = JSON.parse(localStorage.getItem(inventoryKey) || '[]');
                const updatedInventory = inventory.filter(item => String(item.folderId) !== String(folderData.id));
                localStorage.setItem(inventoryKey, JSON.stringify(updatedInventory));
                
                folders.splice(folderIndex, 1);
                localStorage.setItem(key, JSON.stringify(folders));
                
                window.dispatchEvent(new CustomEvent('inventoryUpdated'));
                
                console.log('‚úÖ –ü–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞–ø–∫–∏:', error);
                return false;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏
        async function updateInventoryFolderFromAI(folderData) {
            console.log('=== updateInventoryFolderFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `inventoryFolders_${email}`;
                const folders = JSON.parse(localStorage.getItem(key) || '[]');
                const folder = folders.find(f => String(f.id) === String(folderData.id));
                
                if (!folder) {
                    console.error('–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', folderData.id);
                    return false;
                }
                
                if (folderData.name !== undefined && folderData.name !== null) {
                    folder.name = folderData.name;
                }
                
                localStorage.setItem(key, JSON.stringify(folders));
                window.dispatchEvent(new CustomEvent('inventoryUpdated'));
                
                console.log('‚úÖ –ü–∞–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞–ø–∫–∏:', error);
                return false;
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function createInventoryItemFromAI(itemData) {
            console.log('=== createInventoryItemFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `inventory_${email}`;
                const inventory = JSON.parse(localStorage.getItem(key) || '[]');
                
                const newItem = {
                    id: Date.now() + Math.random(),
                    name: itemData.name || '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä',
                    quantity: itemData.quantity !== undefined ? parseFloat(itemData.quantity) : 0,
                    price: itemData.price !== undefined ? parseFloat(itemData.price) : 0,
                    folderId: itemData.folderId || null
                };
                
                inventory.push(newItem);
                localStorage.setItem(key, JSON.stringify(inventory));
                
                window.dispatchEvent(new CustomEvent('inventoryUpdated'));
                
                console.log('‚úÖ –¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω:', newItem);
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞:', error);
                return false;
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function deleteInventoryItemFromAI(itemData) {
            console.log('=== deleteInventoryItemFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `inventory_${email}`;
                const inventory = JSON.parse(localStorage.getItem(key) || '[]');
                const itemIndex = inventory.findIndex(i => String(i.id) === String(itemData.id));
                
                if (itemIndex === -1) {
                    console.error('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω:', itemData.id);
                    return false;
                }
                
                inventory.splice(itemIndex, 1);
                localStorage.setItem(key, JSON.stringify(inventory));
                
                window.dispatchEvent(new CustomEvent('inventoryUpdated'));
                
                console.log('‚úÖ –¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞:', error);
                return false;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function updateInventoryItemFromAI(itemData) {
            console.log('=== updateInventoryItemFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `inventory_${email}`;
                const inventory = JSON.parse(localStorage.getItem(key) || '[]');
                const item = inventory.find(i => String(i.id) === String(itemData.id));
                
                if (!item) {
                    console.error('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω:', itemData.id);
                    return false;
                }
                
                if (itemData.name !== undefined && itemData.name !== null) {
                    item.name = itemData.name;
                }
                if (itemData.quantity !== undefined && itemData.quantity !== null) {
                    item.quantity = parseFloat(itemData.quantity);
                }
                if (itemData.price !== undefined && itemData.price !== null) {
                    item.price = parseFloat(itemData.price);
                }
                if (itemData.folderId !== undefined) {
                    item.folderId = itemData.folderId || null;
                }
                
                localStorage.setItem(key, JSON.stringify(inventory));
                window.dispatchEvent(new CustomEvent('inventoryUpdated'));
                
                console.log('‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞:', error);
                return false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ —á–µ—Ä–µ–∑ AI
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        async function createEmployeeFolderFromAI(folderData) {
            console.log('=== createEmployeeFolderFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            console.log('–î–∞–Ω–Ω—ã–µ –ø–∞–ø–∫–∏:', folderData);
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `employeeFolders_${email}`;
                const folders = JSON.parse(localStorage.getItem(key) || '[]');
                
                const newFolder = {
                    id: Date.now() + Math.random(),
                    name: folderData.name || '–ù–æ–≤–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å'
                };
                
                folders.push(newFolder);
                localStorage.setItem(key, JSON.stringify(folders));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                window.dispatchEvent(new CustomEvent('employeesUpdated'));
                
                console.log('‚úÖ –ü–∞–ø–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∞:', newFolder);
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∞–ø–∫–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏:', error);
                return false;
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        async function deleteEmployeeFolderFromAI(folderData) {
            console.log('=== deleteEmployeeFolderFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `employeeFolders_${email}`;
                const folders = JSON.parse(localStorage.getItem(key) || '[]');
                const folderIndex = folders.findIndex(f => String(f.id) === String(folderData.id));
                
                if (folderIndex === -1) {
                    console.error('–ü–∞–ø–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', folderData.id);
                    return false;
                }
                
                // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ —ç—Ç–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ (—É–±–∏—Ä–∞–µ–º folderId)
                const employeesKey = `employees_${email}`;
                const employees = JSON.parse(localStorage.getItem(employeesKey) || '[]');
                employees.forEach(emp => {
                    if (String(emp.folderId) === String(folderData.id)) {
                        emp.folderId = null;
                    }
                });
                localStorage.setItem(employeesKey, JSON.stringify(employees));
                
                folders.splice(folderIndex, 1);
                localStorage.setItem(key, JSON.stringify(folders));
                
                window.dispatchEvent(new CustomEvent('employeesUpdated'));
                
                console.log('‚úÖ –ü–∞–ø–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∞');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞–ø–∫–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏:', error);
                return false;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        async function updateEmployeeFolderFromAI(folderData) {
            console.log('=== updateEmployeeFolderFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `employeeFolders_${email}`;
                const folders = JSON.parse(localStorage.getItem(key) || '[]');
                const folder = folders.find(f => String(f.id) === String(folderData.id));
                
                if (!folder) {
                    console.error('–ü–∞–ø–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', folderData.id);
                    return false;
                }
                
                if (folderData.name !== undefined && folderData.name !== null) {
                    folder.name = folderData.name;
                }
                
                localStorage.setItem(key, JSON.stringify(folders));
                window.dispatchEvent(new CustomEvent('employeesUpdated'));
                
                console.log('‚úÖ –ü–∞–ø–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞–ø–∫–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏:', error);
                return false;
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        async function createEmployeeFromAI(employeeData) {
            console.log('=== createEmployeeFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `employees_${email}`;
                const employees = JSON.parse(localStorage.getItem(key) || '[]');
                
                const newEmployee = {
                    id: Date.now() + Math.random(),
                    fio: employeeData.fio || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    phone: employeeData.phone || '',
                    email: employeeData.email || '',
                    salary: employeeData.salary !== undefined ? parseFloat(employeeData.salary) : 0,
                    folderId: employeeData.folderId || null,
                    lastPaymentDate: null
                };
                
                employees.push(newEmployee);
                localStorage.setItem(key, JSON.stringify(employees));
                
                window.dispatchEvent(new CustomEvent('employeesUpdated'));
                
                console.log('‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω:', newEmployee);
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', error);
                return false;
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        async function deleteEmployeeFromAI(employeeData) {
            console.log('=== deleteEmployeeFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `employees_${email}`;
                const employees = JSON.parse(localStorage.getItem(key) || '[]');
                const employeeIndex = employees.findIndex(e => String(e.id) === String(employeeData.id));
                
                if (employeeIndex === -1) {
                    console.error('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω:', employeeData.id);
                    return false;
                }
                
                employees.splice(employeeIndex, 1);
                localStorage.setItem(key, JSON.stringify(employees));
                
                window.dispatchEvent(new CustomEvent('employeesUpdated'));
                
                console.log('‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–¥–∞–ª–µ–Ω');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', error);
                return false;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        async function updateEmployeeFromAI(employeeData) {
            console.log('=== updateEmployeeFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `employees_${email}`;
                const employees = JSON.parse(localStorage.getItem(key) || '[]');
                const employee = employees.find(e => String(e.id) === String(employeeData.id));
                
                if (!employee) {
                    console.error('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω:', employeeData.id);
                    return false;
                }
                
                if (employeeData.fio !== undefined && employeeData.fio !== null) {
                    employee.fio = employeeData.fio;
                }
                if (employeeData.phone !== undefined && employeeData.phone !== null) {
                    employee.phone = employeeData.phone;
                }
                if (employeeData.email !== undefined && employeeData.email !== null) {
                    employee.email = employeeData.email;
                }
                if (employeeData.salary !== undefined && employeeData.salary !== null) {
                    employee.salary = parseFloat(employeeData.salary);
                }
                if (employeeData.folderId !== undefined) {
                    employee.folderId = employeeData.folderId || null;
                }
                
                localStorage.setItem(key, JSON.stringify(employees));
                window.dispatchEvent(new CustomEvent('employeesUpdated'));
                
                console.log('‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', error);
                return false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
        function getUserDataForAI() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) return {};
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–ø–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è ID —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
            const inventoryFolders = JSON.parse(localStorage.getItem(`inventoryFolders_${email}`) || '[]');
            const folderMap = {}; // –ú–∞–ø–ø–∏–Ω–≥ folderId -> folderName
            inventoryFolders.forEach(folder => {
                folderMap[folder.id] = folder.name;
            });
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é: –∑–∞–º–µ–Ω—è–µ–º folderId –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏
            const inventory = JSON.parse(localStorage.getItem(`inventory_${email}`) || '[]');
            const processedInventory = inventory.map(item => {
                const folderId = item.folderId || item.folder;
                const folderName = folderId ? (folderMap[folderId] || folderId) : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                return {
                    ...item,
                    folderName: folderName, // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏
                    folder: folderName // –ó–∞–º–µ–Ω—è–µ–º ID –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ
                };
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–ø–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è ID —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
            const employeeFolders = JSON.parse(localStorage.getItem(`employeeFolders_${email}`) || '[]');
            const employeeFolderMap = {};
            employeeFolders.forEach(folder => {
                employeeFolderMap[folder.id] = folder.name;
            });
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: –∑–∞–º–µ–Ω—è–µ–º folderId –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏
            const employees = JSON.parse(localStorage.getItem(`employees_${email}`) || '[]');
            const processedEmployees = employees.map(emp => {
                const folderId = emp.folderId || emp.folder;
                const folderName = folderId ? (employeeFolderMap[folderId] || folderId) : '–ë–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏';
                return {
                    ...emp,
                    folderName: folderName,
                    folder: folderName
                };
            });
            
            return {
                receipts: JSON.parse(localStorage.getItem(`receipts_${email}`) || '[]'),
                inventory: processedInventory, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–∞–ø–æ–∫
                inventoryFolders: inventoryFolders, // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–ø–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                employees: processedEmployees, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π
                employeeFolders: employeeFolders, // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–ø–∫–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                calendarEvents: JSON.parse(localStorage.getItem(`calendarEvents_${email}`) || '[]'),
                taxesData: JSON.parse(localStorage.getItem('taxesData') || '{}'),
                utilitiesData: JSON.parse(localStorage.getItem('utilitiesData') || '{}'),
                documents: JSON.parse(localStorage.getItem(`documents_${email}`) || '[]'),
                accountBalance: parseFloat(localStorage.getItem('accountBalance') || '0'),
                accountBalance2: parseFloat(localStorage.getItem('accountBalance2') || '0')
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        async function createCalendarEventFromAI(eventData) {
            console.log('=== createCalendarEventFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            console.log('–î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:', eventData);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (!eventData.title || !eventData.date) {
                console.error('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', eventData);
                console.error('title:', eventData.title, 'date:', eventData.date);
                return false;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('‚ùå Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `calendarEvents_${email}`;
                const events = JSON.parse(localStorage.getItem(key) || '[]');
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ ISO —Ñ–æ—Ä–º–∞—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                let eventDate = eventData.date;
                console.log('–ò—Å—Ö–æ–¥–Ω–∞—è –¥–∞—Ç–∞:', eventDate);
                
                if (eventDate) {
                    // –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ –≤ ISO —Ñ–æ—Ä–º–∞—Ç–µ —Å T
                    if (eventDate.includes('T')) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—Ä–µ–º—è
                        if (eventDate.match(/T\d{2}:\d{2}/)) {
                            // –ï—Å—Ç—å –≤—Ä–µ–º—è, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø–æ–ª–Ω—ã–π ISO
                            try {
                                const dateObj = new Date(eventDate);
                                if (!isNaN(dateObj.getTime())) {
                                    eventDate = dateObj.toISOString();
                                }
                            } catch (e) {
                                console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã —Å T:', e);
                            }
                        } else {
                            // –ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏, –¥–æ–±–∞–≤–ª—è–µ–º 12:00
                            eventDate = eventDate + 'T12:00:00';
                            const dateObj = new Date(eventDate);
                            if (!isNaN(dateObj.getTime())) {
                                eventDate = dateObj.toISOString();
                            }
                        }
                    } else if (eventDate.includes(' ')) {
                        // –î–∞—Ç–∞ —Å –ø—Ä–æ–±–µ–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2024-12-25 15:00")
                        eventDate = eventDate.replace(' ', 'T');
                        if (!eventDate.includes(':')) {
                            eventDate += ':00';
                        }
                        const dateObj = new Date(eventDate);
                        if (!isNaN(dateObj.getTime())) {
                            eventDate = dateObj.toISOString();
                        }
                    } else {
                        // –¢–æ–ª—å–∫–æ –¥–∞—Ç–∞ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
                        const dateObj = new Date(eventDate + 'T12:00:00');
                        if (!isNaN(dateObj.getTime())) {
                            eventDate = dateObj.toISOString();
                        }
                    }
                } else {
                    // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –≤ 12:00
                    const today = new Date();
                    today.setHours(12, 0, 0, 0);
                    eventDate = today.toISOString();
                }
                
                console.log('–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –¥–∞—Ç–∞:', eventDate);
                
                const newEvent = {
                    id: eventData.id || Date.now().toString(),
                    title: eventData.title || '–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                    date: eventDate,
                    description: eventData.description || '',
                    notified: false
                };
                
                console.log('–°–æ–∑–¥–∞–≤–∞–µ–º–æ–µ —Å–æ–±—ã—Ç–∏–µ:', newEvent);
                
                events.push(newEvent);
                localStorage.setItem(key, JSON.stringify(events));
                console.log('‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage:', newEvent);
                
                // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä storage —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
                const storageEvent = new StorageEvent('storage', {
                    key: key,
                    newValue: JSON.stringify(events),
                    url: window.location.href
                });
                window.dispatchEvent(storageEvent);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                window.dispatchEvent(new CustomEvent('calendarUpdated'));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ
                if (window.opener && typeof window.opener.loadNotifications === 'function') {
                    window.opener.loadNotifications();
                }
                if (window.opener && typeof window.opener.renderCalendar === 'function') {
                    window.opener.renderCalendar();
                }
                
                console.log('‚úÖ –°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è:', error);
                return false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        async function deleteCalendarEventFromAI(eventData) {
            console.log('=== deleteCalendarEventFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            console.log('–î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:', eventData);
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `calendarEvents_${email}`;
                const events = JSON.parse(localStorage.getItem(key) || '[]');
                console.log('–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ:', events.length);
                console.log('–ò—â–µ–º —Å–æ–±—ã—Ç–∏–µ —Å ID:', eventData.id);
                
                // –ò—â–µ–º —Å–æ–±—ã—Ç–∏–µ –ø–æ ID
                const eventIndex = events.findIndex(e => String(e.id) === String(eventData.id));
                if (eventIndex === -1) {
                    console.error('–°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ! –ò—Å–∫–æ–º—ã–π ID:', eventData.id);
                    console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:', events.map(e => ({ id: e.id, title: e.title })));
                    return false;
                }
                
                console.log('–°–æ–±—ã—Ç–∏–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏:', eventIndex);
                console.log('–£–¥–∞–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ:', events[eventIndex]);
                
                // –£–¥–∞–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
                events.splice(eventIndex, 1);
                localStorage.setItem(key, JSON.stringify(events));
                console.log('‚úÖ –°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ localStorage');
                
                // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä storage —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
                const storageEvent = new StorageEvent('storage', {
                    key: key,
                    newValue: JSON.stringify(events),
                    url: window.location.href
                });
                window.dispatchEvent(storageEvent);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                window.dispatchEvent(new CustomEvent('calendarUpdated'));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ
                if (window.opener && typeof window.opener.loadNotifications === 'function') {
                    window.opener.loadNotifications();
                }
                if (window.opener && typeof window.opener.renderCalendar === 'function') {
                    window.opener.renderCalendar();
                }
                
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è:', error);
                return false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        async function updateCalendarEventFromAI(eventData) {
            console.log('=== updateCalendarEventFromAI –≤—ã–∑–≤–∞–Ω–∞ ===');
            console.log('–î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', eventData);
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const email = currentUser.email || '';
            if (!email) {
                console.error('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const key = `calendarEvents_${email}`;
                const events = JSON.parse(localStorage.getItem(key) || '[]');
                console.log('–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ:', events.length);
                console.log('–ò—â–µ–º —Å–æ–±—ã—Ç–∏–µ —Å ID:', eventData.id);
                
                // –ò—â–µ–º —Å–æ–±—ã—Ç–∏–µ –ø–æ ID
                const event = events.find(e => String(e.id) === String(eventData.id));
                if (!event) {
                    console.error('–°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ! –ò—Å–∫–æ–º—ã–π ID:', eventData.id);
                    console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:', events.map(e => ({ id: e.id, title: e.title })));
                    return false;
                }
                
                console.log('–°–æ–±—ã—Ç–∏–µ –Ω–∞–π–¥–µ–Ω–æ:', event);
                console.log('–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:', {
                    title: event.title,
                    date: event.date,
                    description: event.description
                });
                
                console.log('–ü–æ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', {
                    title: eventData.title,
                    date: eventData.date,
                    description: eventData.description
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è (–ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ –≤ –æ–±—ä–µ–∫—Ç–µ)
                // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ eventData, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ (–¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
                let updated = false;
                
                if ('title' in eventData && eventData.title !== null && eventData.title !== undefined) {
                    const oldTitle = event.title || '';
                    const newTitle = String(eventData.title).trim();
                    event.title = newTitle;
                    updated = true;
                    console.log('=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ù–ê–ó–í–ê–ù–ò–Ø –°–û–ë–´–¢–ò–Ø ===');
                    console.log('  –°—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', oldTitle);
                    console.log('  –ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', newTitle);
                    console.log('‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
                } else {
                    console.log('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–ª—é—á –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ null)');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É, –µ—Å–ª–∏ –æ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞)
                if ('date' in eventData && eventData.date !== null && eventData.date !== undefined && eventData.date !== '') {
                    updated = true;
                    let eventDate = String(eventData.date).trim();
                    console.log('=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–¢–´ –°–û–ë–´–¢–ò–Ø ===');
                    console.log('–ü–æ–ª—É—á–µ–Ω–∞ –¥–∞—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', eventDate);
                    console.log('–¢–∏–ø –¥–∞—Ç—ã:', typeof eventData.date);
                    console.log('–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è:', event.date);
                    
                    try {
                        let parsedDate = null;
                        const oldDate = event.date;
                        
                        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
                        // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                        eventDate = eventDate.replace(/\s+/g, ' ').trim();
                        
                        // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DDTHH:mm (–±–µ–∑ —Å–µ–∫—É–Ω–¥ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã)
                        if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(eventDate)) {
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã –∏ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
                            parsedDate = new Date(eventDate + ':00');
                            console.log('–ü–∞—Ä—Å–∏–Ω–≥ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DDTHH:mm:', eventDate + ':00');
                        }
                        // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DDTHH:mm:ss
                        else if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(eventDate)) {
                            parsedDate = new Date(eventDate);
                            console.log('–ü–∞—Ä—Å–∏–Ω–≥ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DDTHH:mm:ss:', eventDate);
                        }
                        // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD HH:mm (—Å –ø—Ä–æ–±–µ–ª–æ–º)
                        else if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(eventDate)) {
                            eventDate = eventDate.replace(/\s+/, 'T') + ':00';
                            parsedDate = new Date(eventDate);
                            console.log('–ü–∞—Ä—Å–∏–Ω–≥ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DD HH:mm:', eventDate);
                        }
                        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞ YYYY-MM-DD, –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è 12:00
                        else if (/^\d{4}-\d{2}-\d{2}$/.test(eventDate)) {
                            parsedDate = new Date(eventDate + 'T12:00:00');
                            console.log('–ü–∞—Ä—Å–∏–Ω–≥ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DD (–¥–æ–±–∞–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è 12:00):', eventDate + 'T12:00:00');
                        }
                        // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–¥–ª—è –ø–æ–ª–Ω—ã—Ö ISO —Å—Ç—Ä–æ–∫)
                        else {
                            parsedDate = new Date(eventDate);
                            console.log('–ü–∞—Ä—Å–∏–Ω–≥ –∫–∞–∫ –µ—Å—Ç—å:', eventDate);
                        }
                        
                        if (parsedDate && !isNaN(parsedDate.getTime())) {
                            const newDateISO = parsedDate.toISOString();
                            event.date = newDateISO;
                            console.log('‚úÖ –î–ê–¢–ê –£–°–ü–ï–®–ù–û –û–ë–ù–û–í–õ–ï–ù–ê!');
                            console.log('  –°—Ç–∞—Ä–∞—è –¥–∞—Ç–∞:', oldDate);
                            console.log('  –ù–æ–≤–∞—è –¥–∞—Ç–∞ (ISO):', newDateISO);
                            console.log('  –ù–æ–≤–∞—è –¥–∞—Ç–∞ (—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç):', parsedDate.toLocaleString('ru-RU', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }));
                        } else {
                            console.error('‚ùå –ù–ï–í–ê–õ–ò–î–ù–ê–Ø –î–ê–¢–ê - –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å:', eventDate);
                            console.error('  –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤–µ—Ä–Ω—É–ª–∞:', parsedDate);
                        }
                    } catch (e) {
                        console.error('‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞—Ç—ã:', e);
                        console.error('  –ò—Å—Ö–æ–¥–Ω–∞—è –¥–∞—Ç–∞:', eventDate);
                        console.error('  –°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', e.stack);
                    }
                } else {
                    console.log('–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–ª—é—á –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ)');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ —É–∫–∞–∑–∞–Ω–æ (–≤–∫–ª—é—á–∞—è –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—á–∏—Å—Ç–∫–∏)
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞, —á—Ç–æ–±—ã –æ—Ç–ª–∏—á–∏—Ç—å "–Ω–µ —É–∫–∞–∑–∞–Ω–æ" –æ—Ç "–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞"
                if ('description' in eventData && eventData.description !== null && eventData.description !== undefined) {
                    updated = true;
                    const oldDescription = event.description || '';
                    // –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π (–¥–ª—è –æ—á–∏—Å—Ç–∫–∏), –ø–æ—ç—Ç–æ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º trim() –µ—Å–ª–∏ —ç—Ç–æ –≤–∞–∂–Ω–æ
                    // –ù–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º trim() —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                    let newDescription = String(eventData.description);
                    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –æ–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
                    if (newDescription.trim() !== '') {
                        newDescription = newDescription.trim();
                    }
                    event.description = newDescription;
                    console.log('=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–ü–ò–°–ê–ù–ò–Ø –°–û–ë–´–¢–ò–Ø ===');
                    console.log('  –°—Ç–∞—Ä–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:', oldDescription);
                    console.log('  –ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:', newDescription);
                    console.log('  –î–ª–∏–Ω–∞ –Ω–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è:', newDescription.length);
                    console.log('‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
                } else {
                    console.log('–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–ª—é—á –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ null/undefined)');
                    console.log('  eventData.description:', eventData.description);
                    console.log('  "description" in eventData:', 'description' in eventData);
                }
                event.notified = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                
                if (!updated) {
                    console.warn('‚ö†Ô∏è –ù–∏ –æ–¥–Ω–æ –ø–æ–ª–µ –Ω–µ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ:', eventData);
                    console.warn('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π:', {
                        hasTitle: 'title' in eventData,
                        titleValue: eventData.title,
                        titleType: typeof eventData.title,
                        hasDate: 'date' in eventData,
                        dateValue: eventData.date,
                        hasDescription: 'description' in eventData,
                        descriptionValue: eventData.description
                    });
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                console.log('=== –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–ë–´–¢–ò–Ø ===');
                console.log('–û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º:', JSON.stringify(event, null, 2));
                localStorage.setItem(key, JSON.stringify(events));
                console.log('‚úÖ –°–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage');
                
                // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä storage —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
                const storageEvent = new StorageEvent('storage', {
                    key: key,
                    newValue: JSON.stringify(events),
                    url: window.location.href
                });
                window.dispatchEvent(storageEvent);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
                const savedEvents = JSON.parse(localStorage.getItem(key) || '[]');
                const savedEvent = savedEvents.find(e => String(e.id) === String(eventData.id));
                if (savedEvent) {
                    console.log('=== –ü–†–û–í–ï–†–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–û–ì–û –°–û–ë–´–¢–ò–Ø ===');
                    console.log('  ID:', savedEvent.id);
                    console.log('  –ù–∞–∑–≤–∞–Ω–∏–µ:', savedEvent.title);
                    console.log('  –î–∞—Ç–∞:', savedEvent.date);
                    console.log('  –û–ø–∏—Å–∞–Ω–∏–µ:', savedEvent.description);
                } else {
                    console.error('‚ùå –û–®–ò–ë–ö–ê: –°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!');
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                window.dispatchEvent(new CustomEvent('calendarUpdated'));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ
                if (window.opener && typeof window.opener.loadNotifications === 'function') {
                    window.opener.loadNotifications();
                }
                if (window.opener && typeof window.opener.renderCalendar === 'function') {
                    window.opener.renderCalendar();
                }
                
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è:', error);
                return false;
            }
        }

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
        const activeRequests = new Map();
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø—Ä–æ—Å–∞
        // –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤
        const statusCheckAttempts = new Map();
        const MAX_STATUS_CHECK_ATTEMPTS = 150; // –ú–∞–∫—Å–∏–º—É–º 5 –º–∏–Ω—É—Ç (150 * 2 —Å–µ–∫—É–Ω–¥—ã)
        const MAX_REQUEST_TIME = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        
        async function checkRequestStatus(requestId, chatId) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
                const attempts = statusCheckAttempts.get(requestId) || 0;
                const requestInfo = activeRequests.get(requestId);
                
                if (requestInfo) {
                    const elapsedTime = Date.now() - requestInfo.startTime;
                    if (elapsedTime > MAX_REQUEST_TIME) {
                        console.error(`‚ö†Ô∏è –ó–∞–ø—Ä–æ—Å ${requestId} –ø—Ä–µ–≤—ã—Å–∏–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (${MAX_REQUEST_TIME}ms)`);
                        const chat = chats.find(c => c.id === chatId);
                        if (chat && chat.messages.length > 0) {
                            const lastMessage = chat.messages[chat.messages.length - 1];
                            if (!lastMessage.isUser) {
                                lastMessage.text = '–û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                                saveChats();
                                renderChatHistory();
                                const messageIndex = chat.messages.length - 1;
                                updateMessageText(messageIndex, lastMessage.text, true);
                            }
                        }
                        activeRequests.delete(requestId);
                        statusCheckAttempts.delete(requestId);
                        return;
                    }
                }
                
                if (attempts >= MAX_STATUS_CHECK_ATTEMPTS) {
                    console.error(`‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ ${requestId}`);
                    const chat = chats.find(c => c.id === chatId);
                    if (chat && chat.messages.length > 0) {
                        const lastMessage = chat.messages[chat.messages.length - 1];
                        if (!lastMessage.isUser) {
                            lastMessage.text = '–û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                            saveChats();
                            renderChatHistory();
                            const messageIndex = chat.messages.length - 1;
                            updateMessageText(messageIndex, lastMessage.text, true);
                        }
                    }
                    activeRequests.delete(requestId);
                    statusCheckAttempts.delete(requestId);
                    return;
                }
                
                statusCheckAttempts.set(requestId, attempts + 1);
                
                console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø—Ä–æ—Å–∞ ${requestId} (–ø–æ–ø—ã—Ç–∫–∞ ${attempts + 1}/${MAX_STATUS_CHECK_ATTEMPTS})`);
                
                const response = await fetch(`/api/chat-status/${requestId}/`);
                
                if (!response.ok) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞: ${response.status} ${response.statusText}`);
                    if (response.status === 404) {
                        // –ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω
                        const chat = chats.find(c => c.id === chatId);
                        if (chat && chat.messages.length > 0) {
                            const lastMessage = chat.messages[chat.messages.length - 1];
                            if (!lastMessage.isUser) {
                                lastMessage.text = '–û—à–∏–±–∫–∞: –ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                                saveChats();
                                renderChatHistory();
                                const messageIndex = chat.messages.length - 1;
                                updateMessageText(messageIndex, lastMessage.text, true);
                            }
                        }
                        activeRequests.delete(requestId);
                        statusCheckAttempts.delete(requestId);
                        return;
                    }
                    // –ü—Ä–∏ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–∫–∞—Ö –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
                    setTimeout(() => checkRequestStatus(requestId, chatId), 5000);
                    return;
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞:', data.error);
                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –µ—â–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
                    if (attempts < 10) {
                        setTimeout(() => checkRequestStatus(requestId, chatId), 5000);
                    } else {
                        const chat = chats.find(c => c.id === chatId);
                        if (chat && chat.messages.length > 0) {
                            const lastMessage = chat.messages[chat.messages.length - 1];
                            if (!lastMessage.isUser) {
                                lastMessage.text = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞');
                                saveChats();
                                renderChatHistory();
                                const messageIndex = chat.messages.length - 1;
                                updateMessageText(messageIndex, lastMessage.text, true);
                            }
                        }
                        activeRequests.delete(requestId);
                        statusCheckAttempts.delete(requestId);
                    }
                    return;
                }
                
                const chat = chats.find(c => c.id === chatId);
                if (!chat || chat.messages.length === 0) {
                    console.warn(`‚ö†Ô∏è –ß–∞—Ç ${chatId} –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç`);
                    activeRequests.delete(requestId);
                    statusCheckAttempts.delete(requestId);
                    return;
                }
                
                const lastMessage = chat.messages[chat.messages.length - 1];
                if (!lastMessage || lastMessage.isUser) {
                    console.warn(`‚ö†Ô∏è –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ —è–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`);
                    activeRequests.delete(requestId);
                    statusCheckAttempts.delete(requestId);
                    return;
                }
                
                console.log(`üìä –°—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ ${requestId}: ${data.status}`);
                
                if (data.status === 'processing' || data.status === 'pending') {
                    // –ó–∞–ø—Ä–æ—Å –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
                    lastMessage.text = '–î—É–º–∞—é...';
                    saveChats();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–≥–æ —á–∞—Ç–∞
                    const messageIndex = chat.messages.length - 1;
                    updateMessageText(messageIndex, '–î—É–º–∞—é...', false); // –ù–µ —Å–∫—Ä–æ–ª–ª–∏–º –ø—Ä–∏ "–î—É–º–∞—é..."
                    
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => checkRequestStatus(requestId, chatId), 2000);
                    return;
                }
                
                if (data.status === 'completed') {
                    // –ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω
                    console.log('‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞', requestId);
                    console.log('üìù –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞:', data.response ? data.response.length : 0);
                    console.log('üéØ –î–µ–π—Å—Ç–≤–∏–µ –≤ –æ—Ç–≤–µ—Ç–µ:', data.action);
                    
                    statusCheckAttempts.delete(requestId);
                    
                    lastMessage.text = data.response || '–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω';
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è)
                    if (data.action && Object.keys(data.action).length > 0) {
                        console.log('‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É:', data.action);
                        
                        // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ AI
                        if (typeof logAIAction === 'function') {
                            logAIAction(data.action.action, data.action);
                        }
                        
                        if (data.action.action === 'create_event') {
                            console.log('–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:', data.action);
                            const eventCreated = await createCalendarEventFromAI(data.action);
                            if (eventCreated) {
                                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è —á–∏—Ç–∞–µ–º–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                let dateStr = data.action.date || '';
                                try {
                                    const dateObj = new Date(data.action.date);
                                    if (!isNaN(dateObj.getTime())) {
                                        dateStr = dateObj.toLocaleDateString('ru-RU', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                    }
                                } catch (e) {
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –¥–∞—Ç—É, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
                                }
                                lastMessage.text += '\n\n‚úÖ –°–æ–±—ã—Ç–∏–µ "' + data.action.title + '" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ ' + dateStr + '!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å.';
                            }
                        } else if (data.action.action === 'update_event') {
                            const eventUpdated = await updateCalendarEventFromAI(data.action);
                            if (eventUpdated) {
                                const updates = [];
                                if ('title' in data.action && data.action.title !== null && data.action.title !== undefined) {
                                    updates.push('–Ω–∞–∑–≤–∞–Ω–∏–µ');
                                }
                                if ('date' in data.action && data.action.date !== null && data.action.date !== undefined && data.action.date !== '') {
                                    updates.push('–¥–∞—Ç—É');
                                }
                                if ('description' in data.action && data.action.description !== null && data.action.description !== undefined) {
                                    updates.push('–æ–ø–∏—Å–∞–Ω–∏–µ');
                                }
                                
                                if (updates.length > 0) {
                                    let updateMessage = '‚úÖ –°–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!';
                                    if (updates.length === 1) {
                                        updateMessage += ' –ò–∑–º–µ–Ω–µ–Ω–æ: ' + updates[0] + '.';
                                    } else if (updates.length === 2) {
                                        updateMessage += ' –ò–∑–º–µ–Ω–µ–Ω–æ: ' + updates.join(' –∏ ') + '.';
                                    } else {
                                        updateMessage += ' –ò–∑–º–µ–Ω–µ–Ω–æ: ' + updates.slice(0, -1).join(', ') + ' –∏ ' + updates[updates.length - 1] + '.';
                                    }
                                    lastMessage.text += '\n\n' + updateMessage;
                                }
                            }
                        } else if (data.action.action === 'delete_event') {
                            console.log('–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:', data.action);
                            const eventDeleted = await deleteCalendarEventFromAI(data.action);
                            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', eventDeleted);
                            if (eventDeleted) {
                                lastMessage.text += '\n\n‚úÖ –°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ. –í–æ–∑–º–æ–∂–Ω–æ, —Å–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
                            }
                        } else if (data.action.action === 'delete_document') {
                            const docDeleted = await deleteDocumentFromAI(data.action);
                            if (docDeleted) {
                                lastMessage.text += '\n\n‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω!';
                            }
                        } else if (data.action.action === 'rename_document') {
                            const docRenamed = await renameDocumentFromAI(data.action);
                            if (docRenamed) {
                                lastMessage.text += '\n\n‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω!';
                            }
                        } else if (data.action.action === 'send_support_message') {
                            const messageSent = await sendSupportMessageFromAI(data.action);
                            if (messageSent) {
                                lastMessage.text += '\n\n‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É!';
                            }
                        } else if (data.action.action === 'create_folder') {
                            const folderCreated = await createInventoryFolderFromAI(data.action);
                            if (folderCreated) {
                                lastMessage.text += '\n\n‚úÖ –ü–∞–ø–∫–∞ "' + data.action.name + '" —Å–æ–∑–¥–∞–Ω–∞!';
                            }
                        } else if (data.action.action === 'delete_folder') {
                            const folderDeleted = await deleteInventoryFolderFromAI(data.action);
                            if (folderDeleted) {
                                lastMessage.text += '\n\n‚úÖ –ü–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É. –í–æ–∑–º–æ–∂–Ω–æ, –ø–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
                            }
                        } else if (data.action.action === 'update_folder') {
                            const folderUpdated = await updateInventoryFolderFromAI(data.action);
                            if (folderUpdated) {
                                lastMessage.text += '\n\n‚úÖ –ü–∞–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–ø–∫—É.';
                            }
                        } else if (data.action.action === 'create_inventory_item') {
                            const itemCreated = await createInventoryItemFromAI(data.action);
                            if (itemCreated) {
                                let message = '\n\n‚úÖ –¢–æ–≤–∞—Ä "' + data.action.name + '" –¥–æ–±–∞–≤–ª–µ–Ω!';
                                if (data.action.quantity !== undefined) {
                                    message += ' –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ' + data.action.quantity;
                                }
                                if (data.action.price !== undefined) {
                                    message += ', —Ü–µ–Ω–∞: ' + data.action.price + ' ‚ÇΩ';
                                }
                                lastMessage.text += message;
                            }
                        } else if (data.action.action === 'delete_inventory_item') {
                            const itemDeleted = await deleteInventoryItemFromAI(data.action);
                            if (itemDeleted) {
                                lastMessage.text += '\n\n‚úÖ –¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä. –í–æ–∑–º–æ–∂–Ω–æ, —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.';
                            }
                        } else if (data.action.action === 'update_inventory_item') {
                            const itemUpdated = await updateInventoryItemFromAI(data.action);
                            if (itemUpdated) {
                                lastMessage.text += '\n\n‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.';
                            }
                        } else if (data.action.action === 'create_employee_folder') {
                            const folderCreated = await createEmployeeFolderFromAI(data.action);
                            if (folderCreated) {
                                lastMessage.text += '\n\n‚úÖ –î–æ–ª–∂–Ω–æ—Å—Ç—å "' + data.action.name + '" —Å–æ–∑–¥–∞–Ω–∞!';
                            }
                        } else if (data.action.action === 'delete_employee_folder') {
                            const folderDeleted = await deleteEmployeeFolderFromAI(data.action);
                            if (folderDeleted) {
                                lastMessage.text += '\n\n‚úÖ –î–æ–ª–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å. –í–æ–∑–º–æ–∂–Ω–æ, –¥–æ–ª–∂–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
                            }
                        } else if (data.action.action === 'update_employee_folder') {
                            const folderUpdated = await updateEmployeeFolderFromAI(data.action);
                            if (folderUpdated) {
                                lastMessage.text += '\n\n‚úÖ –î–æ–ª–∂–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å.';
                            }
                        } else if (data.action.action === 'create_employee') {
                            const employeeCreated = await createEmployeeFromAI(data.action);
                            if (employeeCreated) {
                                let message = '\n\n‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ "' + data.action.fio + '" –¥–æ–±–∞–≤–ª–µ–Ω!';
                                if (data.action.phone) {
                                    message += ' –¢–µ–ª–µ—Ñ–æ–Ω: ' + data.action.phone;
                                }
                                if (data.action.email) {
                                    message += ', –ø–æ—á—Ç–∞: ' + data.action.email;
                                }
                                if (data.action.salary !== undefined) {
                                    message += ', –∑–∞—Ä–ø–ª–∞—Ç–∞: ' + data.action.salary + ' ‚ÇΩ';
                                }
                                lastMessage.text += message;
                            }
                        } else if (data.action.action === 'delete_employee') {
                            const employeeDeleted = await deleteEmployeeFromAI(data.action);
                            if (employeeDeleted) {
                                lastMessage.text += '\n\n‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–¥–∞–ª–µ–Ω!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.';
                            }
                        } else if (data.action.action === 'update_employee') {
                            const employeeUpdated = await updateEmployeeFromAI(data.action);
                            if (employeeUpdated) {
                                lastMessage.text += '\n\n‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω!';
                            } else {
                                lastMessage.text += '\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.';
                            }
                        }
                    } else {
                        console.warn('‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–µ –≤ –æ—Ç–≤–µ—Ç–µ');
                    }
                    
                    saveChats();
                    renderChatHistory();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–≥–æ —á–∞—Ç–∞
                    const messageIndex = chat.messages.length - 1;
                    updateMessageText(messageIndex, lastMessage.text, true);
                    
                    activeRequests.delete(requestId);
                    return;
                }
                
                if (data.status === 'failed') {
                    // –ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π
                    console.error('‚ùå –ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π:', data.error);
                    statusCheckAttempts.delete(requestId);
                    
                    lastMessage.text = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    saveChats();
                    renderChatHistory();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–≥–æ —á–∞—Ç–∞
                    const messageIndex = chat.messages.length - 1;
                    updateMessageText(messageIndex, lastMessage.text, true);
                    
                    activeRequests.delete(requestId);
                    return;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                const attempts = statusCheckAttempts.get(requestId) || 0;
                
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫
                if (attempts < MAX_STATUS_CHECK_ATTEMPTS) {
                    setTimeout(() => checkRequestStatus(requestId, chatId), 5000);
                } else {
                    console.error(`‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ ${requestId}`);
                    const chat = chats.find(c => c.id === chatId);
                    if (chat && chat.messages.length > 0) {
                        const lastMessage = chat.messages[chat.messages.length - 1];
                        if (!lastMessage.isUser) {
                            lastMessage.text = '–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                            saveChats();
                            renderChatHistory();
                            const messageIndex = chat.messages.length - 1;
                            updateMessageText(messageIndex, lastMessage.text, true);
                        }
                    }
                    activeRequests.delete(requestId);
                    statusCheckAttempts.delete(requestId);
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ AI —á–µ—Ä–µ–∑ API
        async function sendMessageToAI(message, chatHistory, chatId, attachedFilesData = []) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userData = getUserDataForAI();
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ - —Å–µ—Ä–≤–µ—Ä —Å–∞–º –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã
                const filesToSend = attachedFilesData.map(file => ({
                    name: file.name || '',
                    type: file.type || '',
                    size: file.size || 0,
                    data: file.data || '' // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
                }));
                
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory,
                        userData: userData,
                        files: filesToSend
                    })
                });

                const data = await response.json();
                
                // –ù–∞—Ö–æ–¥–∏–º —á–∞—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ AI
                const chat = chats.find(c => c.id === chatId);
                if (chat && chat.messages.length > 0) {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    if (!lastMessage.isUser) {
                        if (data.success && data.request_id) {
                            // –ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
                            const requestId = data.request_id;
                            activeRequests.set(requestId, { chatId, startTime: Date.now() });
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º request_id –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                            lastMessage.requestId = requestId;
                            lastMessage.text = '–î—É–º–∞—é...';
                            saveChats();
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–≥–æ —á–∞—Ç–∞
                            const messageIndex = chat.messages.length - 1;
                            updateMessageText(messageIndex, '–î—É–º–∞—é...', false); // –ù–µ —Å–∫—Ä–æ–ª–ª–∏–º –ø—Ä–∏ "–î—É–º–∞—é..."
                            
                            // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
                            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É (—á–µ—Ä–µ–∑ 500–º—Å), —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –≥–æ—Ç–æ–≤
                            setTimeout(() => checkRequestStatus(requestId, chatId), 500);
                        } else if (data.success && data.response) {
                            // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç) - –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                            lastMessage.text = data.response;
                            
                            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è)
                            if (data.action) {
                                // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ AI
                                if (typeof logAIAction === 'function') {
                                    logAIAction(data.action.action, data.action);
                                }
                                
                                if (data.action.action === 'create_event') {
                                    const eventCreated = await createCalendarEventFromAI(data.action);
                                    if (eventCreated) {
                                        lastMessage.text += '\n\n‚úÖ –°–æ–±—ã—Ç–∏–µ "' + data.action.title + '" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å!';
                                    }
                                } else if (data.action.action === 'update_event') {
                                    console.log('=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–û–ë–´–¢–ò–Ø ===');
                                    console.log('–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:', JSON.stringify(data.action, null, 2));
                                    console.log('ID —Å–æ–±—ã—Ç–∏—è:', data.action.id);
                                    console.log('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', data.action.title, '(–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç:', 'title' in data.action, ')');
                                    console.log('–ù–æ–≤–∞—è –¥–∞—Ç–∞:', data.action.date, '(–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç:', 'date' in data.action, ')');
                                    console.log('–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:', data.action.description, '(–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç:', 'description' in data.action, ')');
                                    
                                    const eventUpdated = await updateCalendarEventFromAI(data.action);
                                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', eventUpdated);
                                    
                                    if (eventUpdated) {
                                        const updates = [];
                                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–π, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π
                                        // –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π (–¥–ª—è –æ—á–∏—Å—Ç–∫–∏)
                                        if ('title' in data.action && data.action.title !== null && data.action.title !== undefined) {
                                            updates.push('–Ω–∞–∑–≤–∞–Ω–∏–µ');
                                        }
                                        if ('date' in data.action && data.action.date !== null && data.action.date !== undefined && data.action.date !== '') {
                                            updates.push('–¥–∞—Ç—É');
                                        }
                                        // –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π (–¥–ª—è –æ—á–∏—Å—Ç–∫–∏)
                                        if ('description' in data.action && data.action.description !== null && data.action.description !== undefined) {
                                            updates.push('–æ–ø–∏—Å–∞–Ω–∏–µ');
                                        }
                                        console.log('–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', updates);
                                        
                                        if (updates.length > 0) {
                                            let updateMessage = '‚úÖ –°–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!';
                                            if (updates.length === 1) {
                                                updateMessage += ' –ò–∑–º–µ–Ω–µ–Ω–æ: ' + updates[0] + '.';
                                            } else if (updates.length === 2) {
                                                updateMessage += ' –ò–∑–º–µ–Ω–µ–Ω–æ: ' + updates.join(' –∏ ') + '.';
                                            } else {
                                                updateMessage += ' –ò–∑–º–µ–Ω–µ–Ω–æ: ' + updates.slice(0, -1).join(', ') + ' –∏ ' + updates[updates.length - 1] + '.';
                                            }
                                            lastMessage.text += '\n\n' + updateMessage;
                                        } else {
                                            lastMessage.text += '\n\n‚ö†Ô∏è –°–æ–±—ã—Ç–∏–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ –Ω–µ –±—ã–ª–æ —É–∫–∞–∑–∞–Ω–æ —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.';
                                        }
                                    } else {
                                        lastMessage.text += '\n\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ. –í–æ–∑–º–æ–∂–Ω–æ, —Å–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
                                    }
                                }
                            }
                        } else {
                            lastMessage.text = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                        }
                        lastMessage.timestamp = new Date().toISOString();
                        saveChats();
                        renderChatHistory();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–≥–æ —á–∞—Ç–∞
                        const messageIndex = chat.messages.length - 1;
                        updateMessageText(messageIndex, lastMessage.text, true); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–æ–ª–ª–∏—Ç –≤–Ω–∏–∑
                    }
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                const sendButton = document.getElementById('chatSendBtn');
                if (sendButton && typeof hideButtonLoading === 'function') {
                    hideButtonLoading(sendButton);
                }
            } catch (error) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
                if (typeof handleError === 'function') {
                    handleError(error, {
                        function: 'sendMessageToAI',
                        chatId: chatId,
                        message: message
                    }, {
                        showModal: false,
                        silent: false
                    });
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                const chat = chats.find(c => c.id === chatId);
                if (chat && chat.messages.length > 0) {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    if (!lastMessage.isUser) {
                        const errorMessage = typeof handleError === 'function' 
                            ? handleError(error, {}, { silent: true }).userMessage
                            : '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OpenRouter API –∫–ª—é—á–∞.';
                        lastMessage.text = errorMessage;
                        lastMessage.timestamp = new Date().toISOString();
                        saveChats();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–≥–æ —á–∞—Ç–∞
                        const messageIndex = chat.messages.length - 1;
                        updateMessageText(messageIndex, lastMessage.text, true); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–æ–ª–ª–∏—Ç –≤–Ω–∏–∑
                    }
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                const sendButton = document.getElementById('chatSendBtn');
                if (sendButton && typeof hideButtonLoading === 'function') {
                    hideButtonLoading(sendButton);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è markdown –≤ HTML
        function markdownToHTML(text) {
            if (!text) return '';
            
            let html = text;
            
            // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∫–æ–¥ (—á—Ç–æ–±—ã –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ)
            const codeBlocks = [];
            html = html.replace(/```([\s\S]*?)```/g, (match, code) => {
                const id = `CODEBLOCK_${codeBlocks.length}`;
                const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                codeBlocks.push(`<pre class="markdown-code-block"><code>${escapedCode}</code></pre>`);
                return id;
            });
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–Ω–ª–∞–π–Ω –∫–æ–¥
            const inlineCodes = [];
            html = html.replace(/`([^`\n]+)`/g, (match, code) => {
                const id = `INLINECODE_${inlineCodes.length}`;
                const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                inlineCodes.push(`<code class="markdown-inline-code">${escapedCode}</code>`);
                return id;
            });
            
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML-—Ç–µ–≥–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–ª–∞–π–Ω –∫–æ–¥
            inlineCodes.forEach((code, index) => {
                html = html.replace(`INLINECODE_${index}`, code);
            });
            
            // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç: **—Ç–µ–∫—Å—Ç** –∏–ª–∏ __—Ç–µ–∫—Å—Ç__
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            
            // –ö—É—Ä—Å–∏–≤: *—Ç–µ–∫—Å—Ç* –∏–ª–∏ _—Ç–µ–∫—Å—Ç_ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ lookbehind –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
            html = html.replace(/(^|[^*])\*([^*\n]+?)\*([^*]|$)/g, '$1<em>$2</em>$3');
            html = html.replace(/(^|[^_])_([^_\n]+?)_([^_]|$)/g, '$1<em>$2</em>$3');
            
            // –ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç: ~~—Ç–µ–∫—Å—Ç~~
            html = html.replace(/~~([^~]+)~~/g, '<del>$1</del>');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞
            codeBlocks.forEach((code, index) => {
                html = html.replace(`CODEBLOCK_${index}`, code);
            });
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏: # –ó–∞–≥–æ–ª–æ–≤–æ–∫, ## –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç.–¥.
            html = html.replace(/^### (.+)$/gm, '<h3 class="markdown-h3">$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2 class="markdown-h2">$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1 class="markdown-h1">$1</h1>');
            
            // –°–ø–∏—Å–∫–∏: - —ç–ª–µ–º–µ–Ω—Ç –∏–ª–∏ * —ç–ª–µ–º–µ–Ω—Ç
            const lines = html.split('\n');
            let inList = false;
            const processedLines = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const listMatch = line.match(/^[\*\-\+]\s+(.+)$/);
                if (listMatch) {
                    if (!inList) {
                        inList = true;
                        processedLines.push('<ul class="markdown-list"><li>' + listMatch[1] + '</li>');
                    } else {
                        processedLines.push('<li>' + listMatch[1] + '</li>');
                    }
                } else {
                    if (inList) {
                        inList = false;
                        processedLines.push('</ul>');
                    }
                    processedLines.push(line);
                }
            }
            if (inList) {
                processedLines.push('</ul>');
            }
            html = processedLines.join('\n');
            
            // –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏: 1. —ç–ª–µ–º–µ–Ω—Ç
            inList = false;
            const processedLines2 = [];
            const lines2 = html.split('\n');
            for (let i = 0; i < lines2.length; i++) {
                const line = lines2[i];
                const listMatch = line.match(/^\d+\.\s+(.+)$/);
                if (listMatch) {
                    if (!inList) {
                        inList = true;
                        processedLines2.push('<ol class="markdown-list"><li>' + listMatch[1] + '</li>');
                    } else {
                        processedLines2.push('<li>' + listMatch[1] + '</li>');
                    }
                } else {
                    if (inList) {
                        inList = false;
                        processedLines2.push('</ol>');
                    }
                    processedLines2.push(line);
                }
            }
            if (inList) {
                processedLines2.push('</ol>');
            }
            html = processedLines2.join('\n');
            
            // –°—Å—ã–ª–∫–∏: [—Ç–µ–∫—Å—Ç](url)
            html = html.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" class="markdown-link">$1</a>');
            
            // –ì—Ä–∞—Ñ–∏–∫–∏: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
            // –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥: –ø—Ä–æ—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã [CHART_RECEIPTS:—Ç–∏–ø], [CHART_INVENTORY:—Ç–∏–ø] –∏ —Ç.–¥.
            // –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥: [CHART:—Ç–∏–ø:–¥–∞–Ω–Ω—ã–µ_json] - –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            const chartBlocks = [];
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            function createChartFromUserData(dataType, chartType) {
                const userData = getUserDataForAI();
                let chartData = null;
                
                try {
                    switch(dataType.toUpperCase()) {
                        case 'RECEIPTS':
                        case '–ß–ï–ö–ò':
                            if (!userData.receipts || userData.receipts.length === 0) {
                                return null;
                            }
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ chartType
                            const isLineChart = chartType && (chartType.toLowerCase() === 'line');
                            
                            if (isLineChart) {
                                // –î–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º
                                const operationsByDate = {};
                                userData.receipts.forEach(receipt => {
                                    let dateKey = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                                    if (receipt.date) {
                                        try {
                                            const date = new Date(receipt.date);
                                            dateKey = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                                        } catch (e) {
                                            dateKey = receipt.date.split('T')[0] || receipt.date.split(' ')[0] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                                        }
                                    }
                                    const amount = receipt.amount || 0;
                                    if (!operationsByDate[dateKey]) {
                                        operationsByDate[dateKey] = 0;
                                    }
                                    operationsByDate[dateKey] += Math.abs(amount);
                                });
                                
                                const dates = Object.keys(operationsByDate).sort();
                                const amounts = dates.map(date => operationsByDate[date]);
                                
                                if (dates.length === 0) return null;
                                
                                chartData = {
                                    labels: dates,
                                    data: amounts,
                                    label: '–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–π'
                                };
                            } else {
                                // –î–ª—è –¥—Ä—É–≥–∏—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º –æ–ø–µ—Ä–∞—Ü–∏–π
                                const operationsByType = {};
                                userData.receipts.forEach(receipt => {
                                    const opType = receipt.operationType || '–û–ø–µ—Ä–∞—Ü–∏—è';
                                    const amount = receipt.amount || 0;
                                    if (!operationsByType[opType]) {
                                        operationsByType[opType] = 0;
                                    }
                                    operationsByType[opType] += Math.abs(amount);
                                });
                                
                                const opLabels = Object.keys(operationsByType);
                                const opData = opLabels.map(label => operationsByType[label]);
                                
                                if (opLabels.length === 0) return null;
                                
                                chartData = {
                                    labels: opLabels,
                                    data: opData,
                                    label: '–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–π'
                                };
                            }
                            break;
                            
                        case 'INVENTORY':
                        case '–ò–ù–í–ï–ù–¢–ê–†–ò–ó–ê–¶–ò–Ø':
                            if (!userData.inventory || userData.inventory.length === 0) {
                                return null;
                            }
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞
                            const isInventoryPie = chartType && (chartType.toLowerCase() === 'pie' || chartType.toLowerCase() === 'doughnut');
                            
                            if (isInventoryPie) {
                                // –î–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–ø–∞–ø–∫–∞–º)
                                const categories = {};
                                userData.inventory.forEach(item => {
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º folderName –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ folder, –∏–Ω–∞—á–µ '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
                                    const cat = item.folderName || item.folder || (item.folderId ? '–ü–∞–ø–∫–∞ ' + item.folderId : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                                    const quantity = item.quantity || 0;
                                    const price = item.price || 0;
                                    const value = quantity * price;
                                    
                                    if (!categories[cat]) {
                                        categories[cat] = 0;
                                    }
                                    categories[cat] += value;
                                });
                                
                                const catLabels = Object.keys(categories);
                                const catData = catLabels.map(label => categories[label]);
                                
                                if (catLabels.length === 0) return null;
                                
                                chartData = {
                                    labels: catLabels,
                                    data: catData,
                                    label: '–°—Ç–æ–∏–º–æ—Å—Ç—å'
                                };
                            } else {
                                // –î–ª—è –¥—Ä—É–≥–∏—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ (bar, horizontal) –∏—Å–ø–æ–ª—å–∑—É–µ–º –ù–ê–ó–í–ê–ù–ò–Ø –¢–û–í–ê–†–û–í
                                const itemsData = [];
                                userData.inventory.forEach(item => {
                                    const itemName = item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                                    const quantity = item.quantity || 0;
                                    const price = item.price || 0;
                                    const value = quantity * price;
                                    
                                    if (itemName && value > 0) {
                                        itemsData.push({
                                            name: itemName,
                                            value: value,
                                            category: item.folderName || item.folder || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
                                        });
                                    }
                                });
                                
                                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
                                itemsData.sort((a, b) => b.value - a.value);
                                
                                // –ë–µ—Ä–µ–º —Ç–æ–ø-10 —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                                const topItems = itemsData.slice(0, 10);
                                
                                if (topItems.length === 0) return null;
                                
                                chartData = {
                                    labels: topItems.map(item => item.name), // –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–ê–ó–í–ê–ù–ò–Ø –¢–û–í–ê–†–û–í
                                    data: topItems.map(item => item.value),
                                    label: '–°—Ç–æ–∏–º–æ—Å—Ç—å'
                                };
                            }
                            break;
                            
                        case 'EMPLOYEES':
                        case '–°–û–¢–†–£–î–ù–ò–ö–ò':
                            if (!userData.employees || userData.employees.length === 0) {
                                return null;
                            }
                            
                            const empLabels = userData.employees.map(emp => emp.fio || '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
                            const empData = userData.employees.map(emp => emp.salary || 0);
                            
                            chartData = {
                                labels: empLabels,
                                data: empData,
                                label: '–ó–∞—Ä–ø–ª–∞—Ç–∞'
                            };
                            break;
                            
                        case 'TAXES':
                        case '–ù–ê–õ–û–ì–ò':
                            if (!userData.taxesData || Object.keys(userData.taxesData).length === 0) {
                                return null;
                            }
                            
                            const taxNames = {
                                profit: '–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–∏–±—ã–ª—å',
                                vat: '–ù–î–°',
                                property: '–ù–∞–ª–æ–≥ –Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ',
                                insurance: '–°—Ç—Ä–∞—Ö–æ–≤—ã–µ –≤–∑–Ω–æ—Å—ã'
                            };
                            
                            const taxLabels = [];
                            const taxData = [];
                            
                            Object.keys(userData.taxesData).forEach(key => {
                                const debt = userData.taxesData[key]?.debt || 0;
                                if (debt > 0) {
                                    taxLabels.push(taxNames[key] || key);
                                    taxData.push(debt);
                                }
                            });
                            
                            if (taxLabels.length === 0) return null;
                            
                            chartData = {
                                labels: taxLabels,
                                data: taxData,
                                label: '–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å'
                            };
                            break;
                            
                        case 'UTILITIES':
                        case '–ö–û–ú–ú–£–ù–ê–õ–¨–ù–´–ï':
                            if (!userData.utilitiesData || Object.keys(userData.utilitiesData).length === 0) {
                                return null;
                            }
                            
                            const utilNames = {
                                electricity: '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ',
                                water: '–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ',
                                heating: '–û—Ç–æ–ø–ª–µ–Ω–∏–µ',
                                waste: '–í—ã–≤–æ–∑ –¢–ö–û',
                                security: '–û—Ö—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏',
                                internet: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç'
                            };
                            
                            const utilLabels = [];
                            const utilData = [];
                            
                            Object.keys(userData.utilitiesData).forEach(key => {
                                const debt = userData.utilitiesData[key]?.debt || 0;
                                if (debt > 0) {
                                    utilLabels.push(utilNames[key] || key);
                                    utilData.push(debt);
                                }
                            });
                            
                            if (utilLabels.length === 0) return null;
                            
                            chartData = {
                                labels: utilLabels,
                                data: utilData,
                                label: '–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å'
                            };
                            break;
                            
                        case 'BALANCE':
                        case '–ë–ê–õ–ê–ù–°':
                            chartData = {
                                labels: ['–°—á–µ—Ç 1', '–°—á–µ—Ç 2', '–û–±—â–∏–π –±–∞–ª–∞–Ω—Å'],
                                data: [
                                    userData.accountBalance || 0,
                                    userData.accountBalance2 || 0,
                                    (userData.accountBalance || 0) + (userData.accountBalance2 || 0)
                                ],
                                label: '–ë–∞–ª–∞–Ω—Å'
                            };
                            break;
                            
                        default:
                            return null;
                    }
                    
                    return chartData;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö:', error);
                    return null;
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Å—Ç—ã—Ö –∫–æ–º–∞–Ω–¥ [CHART_–¢–ò–ü_–î–ê–ù–ù–´–•:—Ç–∏–ø_–≥—Ä–∞—Ñ–∏–∫–∞]
            // –≠—Ç–æ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô –ø–æ–¥—Ö–æ–¥ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
            const simpleChartRegex = /\[CHART_(RECEIPTS|INVENTORY|EMPLOYEES|TAXES|UTILITIES|BALANCE|–ß–ï–ö–ò|–ò–ù–í–ï–ù–¢–ê–†–ò–ó–ê–¶–ò–Ø|–°–û–¢–†–£–î–ù–ò–ö–ò|–ù–ê–õ–û–ì–ò|–ö–û–ú–ú–£–ù–ê–õ–¨–ù–´–ï|–ë–ê–õ–ê–ù–°):(\w+)\]/gi;
            html = html.replace(simpleChartRegex, (match, dataType, chartType) => {
                const id = `CHART_${chartBlocks.length}_${Date.now()}`;
                
                try {
                    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const chartData = createChartFromUserData(dataType, chartType);
                    
                    if (!chartData) {
                        const dataTypeName = {
                            'RECEIPTS': '—á–µ–∫–∏',
                            'INVENTORY': '–∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è',
                            'EMPLOYEES': '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
                            'TAXES': '–Ω–∞–ª–æ–≥–∏',
                            'UTILITIES': '–∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏',
                            'BALANCE': '–±–∞–ª–∞–Ω—Å—ã'
                        }[dataType.toUpperCase()] || dataType;
                        return `<div class="chart-container error">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ (${dataTypeName})</div>`;
                    }
                    
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                    if (!chartData.labels || !Array.isArray(chartData.labels) || chartData.labels.length === 0) {
                        return `<div class="chart-container error">–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</div>`;
                    }
                    
                    if (!chartData.data || !Array.isArray(chartData.data) || chartData.data.length === 0) {
                        return `<div class="chart-container error">–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</div>`;
                    }
                    
                    // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–ª–∏–Ω—ã –º–∞—Å—Å–∏–≤–æ–≤
                    const minLength = Math.min(chartData.labels.length, chartData.data.length);
                    chartData.labels = chartData.labels.slice(0, minLength);
                    chartData.data = chartData.data.slice(0, minLength);
                    
                    chartBlocks.push({ id, type: chartType.toLowerCase(), data: chartData });
                    return `<div id="chart_container_${id}" class="chart-container loading"></div>`;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö:', error);
                    return `<div class="chart-container error">–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞: ${error.message}</div>`;
                }
            });
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è JSON (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
            function cleanAndParseJSON(jsonString) {
                if (!jsonString) return null;
                
                // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                let cleaned = jsonString.trim();
                
                // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–ø—è—Ç—ã–µ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
                while (cleaned.startsWith(',')) {
                    cleaned = cleaned.substring(1).trim();
                }
                
                // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Å–∫–æ–±–∫–∏ –≤ –∫–æ–Ω—Ü–µ (–µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç—å—é JSON)
                // –°—á–∏—Ç–∞–µ–º –±–∞–ª–∞–Ω—Å —Å–∫–æ–±–æ–∫
                let openBraces = (cleaned.match(/\{/g) || []).length;
                let closeBraces = (cleaned.match(/\}/g) || []).length;
                let openBrackets = (cleaned.match(/\[/g) || []).length;
                let closeBrackets = (cleaned.match(/\]/g) || []).length;
                
                // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Å–∫–æ–±–∫–∏
                while (closeBrackets > openBrackets && cleaned.endsWith(']')) {
                    cleaned = cleaned.slice(0, -1).trim();
                    closeBrackets--;
                }
                while (closeBraces > openBraces && cleaned.endsWith('}')) {
                    cleaned = cleaned.slice(0, -1).trim();
                    closeBraces--;
                }
                
                // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ JSON –æ–±—ä–µ–∫—Ç –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
                const jsonObjectMatch = cleaned.match(/\{[\s\S]*\}/);
                if (jsonObjectMatch) {
                    cleaned = jsonObjectMatch[0];
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–∞, –∏—â–µ–º –º–∞—Å—Å–∏–≤
                    const jsonArrayMatch = cleaned.match(/\[[\s\S]*\]/);
                    if (jsonArrayMatch) {
                        cleaned = jsonArrayMatch[0];
                    }
                }
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
                // –£–±–∏—Ä–∞–µ–º –∑–∞–ø—è—Ç—ã–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º–∏ —Å–∫–æ–±–∫–∞–º–∏
                cleaned = cleaned.replace(/,(\s*[}\]])/g, '$1');
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –¥–≤–æ–π–Ω—ã–µ –∑–∞–ø—è—Ç—ã–µ
                cleaned = cleaned.replace(/,+/g, ',');
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—è—Ç—ã–µ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö —Å–∫–æ–±–æ–∫
                cleaned = cleaned.replace(/([{\[])\s*,/g, '$1');
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (–¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                // –ù–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª—é—á–µ–π, –Ω–µ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π
                cleaned = cleaned.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                
                // –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å
                try {
                    const parsed = JSON.parse(cleaned);
                    return parsed;
                } catch (e1) {
                    // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –æ–±–µ—Ä–Ω—É—Ç—å –≤ —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏
                    if (!cleaned.startsWith('{') && !cleaned.startsWith('[')) {
                        try {
                            return JSON.parse('{' + cleaned + '}');
                        } catch (e2) {
                            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –º–∞—Å—Å–∏–≤ –∏ —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç
                            const arrayMatch = cleaned.match(/\[[\s\S]*\]/);
                            if (arrayMatch) {
                                try {
                                    const arr = JSON.parse(arrayMatch[0]);
                                    // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤, —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å data
                                    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ labels –≤ –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                                    const labelsMatch = jsonString.match(/"labels"\s*:\s*\[([^\]]+)\]/);
                                    if (labelsMatch) {
                                        try {
                                            const labelsStr = labelsMatch[1];
                                            // –ü–∞—Ä—Å–∏–º labels –≤—Ä—É—á–Ω—É—é
                                            const labels = labelsStr.split(',').map(s => {
                                                s = s.trim().replace(/^["']|["']$/g, '');
                                                return s;
                                            });
                                            return { labels: labels, data: arr };
                                        } catch (e4) {
                                            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, —Å–æ–∑–¥–∞–µ–º labels –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                                            return { labels: arr.map((_, i) => `–≠–ª–µ–º–µ–Ω—Ç ${i + 1}`), data: arr };
                                        }
                                    }
                                    return { data: arr };
                                } catch (e3) {
                                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –º–∞—Å—Å–∏–≤:', cleaned);
                                }
                            }
                        }
                    }
                    
                    // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤—ã labels –∏ data –≤—Ä—É—á–Ω—É—é
                    try {
                        // –ò—â–µ–º "labels":[...] –∏ "data":[...]
                        const labelsPattern = /"labels"\s*:\s*\[([^\]]+)\]/;
                        const dataPattern = /"data"\s*:\s*\[([^\]]+)\]/;
                        
                        const labelsMatch = cleaned.match(labelsPattern) || jsonString.match(labelsPattern);
                        const dataMatch = cleaned.match(dataPattern) || jsonString.match(dataPattern);
                        
                        if (labelsMatch && dataMatch) {
                            // –ü–∞—Ä—Å–∏–º –º–∞—Å—Å–∏–≤—ã –≤—Ä—É—á–Ω—É—é
                            const parseArray = (str) => {
                                return str.split(',').map(s => {
                                    s = s.trim();
                                    // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏
                                    s = s.replace(/^["']|["']$/g, '');
                                    // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ —á–∏—Å–ª–æ
                                    const num = parseFloat(s);
                                    return isNaN(num) ? s : num;
                                });
                            };
                            
                            const labels = parseArray(labelsMatch[1]);
                            const data = parseArray(dataMatch[1]);
                            
                            if (labels.length > 0 && data.length > 0) {
                                return { labels: labels, data: data };
                            }
                        }
                    } catch (e5) {
                        console.error('–ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:', e5);
                    }
                    
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e1, '–°—Ç—Ä–æ–∫–∞:', cleaned.substring(0, 200));
                    return null;
                }
            }
            
            // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–æ–º–∞–Ω–¥ –≥—Ä–∞—Ñ–∏–∫–æ–≤
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –≥–∏–±–∫–∏–π –ø–æ–¥—Ö–æ–¥: —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –ø–æ—Ç–æ–º –±–æ–ª–µ–µ –æ–±—â–µ–µ
            const chartRegex = /\[CHART:(\w+):([^\]]+)\]/g;
            html = html.replace(chartRegex, (match, chartType, chartDataJson) => {
                const id = `CHART_${chartBlocks.length}_${Date.now()}`;
                
                // –û—á–∏—â–∞–µ–º –∏ –ø–∞—Ä—Å–∏–º JSON
                const chartData = cleanAndParseJSON(chartDataJson);
                
                if (!chartData) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞:', chartDataJson);
                    return `<div class="chart-container error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö<br><small>${chartDataJson.substring(0, 100)}</small></div>`;
                }
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                if (!chartData.labels && !chartData.data) {
                    console.error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è labels –∏–ª–∏ data:', chartData);
                    return `<div class="chart-container error">–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (labels –∏–ª–∏ data)</div>`;
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å data –Ω–æ –Ω–µ—Ç labels, —Å–æ–∑–¥–∞–µ–º labels
                if (chartData.data && !chartData.labels) {
                    chartData.labels = chartData.data.map((_, i) => `–≠–ª–µ–º–µ–Ω—Ç ${i + 1}`);
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å labels –Ω–æ –Ω–µ—Ç data, —Å–æ–∑–¥–∞–µ–º data –∏–∑ labels
                if (chartData.labels && !chartData.data) {
                    chartData.data = chartData.labels.map(() => 0);
                }
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ data - —ç—Ç–æ –º–∞—Å—Å–∏–≤
                if (!Array.isArray(chartData.data)) {
                    chartData.data = [chartData.data];
                }
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ labels - —ç—Ç–æ –º–∞—Å—Å–∏–≤
                if (!Array.isArray(chartData.labels)) {
                    chartData.labels = [chartData.labels];
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª–∏–Ω
                if (chartData.labels.length !== chartData.data.length) {
                    const minLength = Math.min(chartData.labels.length, chartData.data.length);
                    chartData.labels = chartData.labels.slice(0, minLength);
                    chartData.data = chartData.data.slice(0, minLength);
                }
                
                chartBlocks.push({ id, type: chartType, data: chartData });
                html = html.replace(full, `<div id="chart_container_${id}" class="chart-container loading"></div>`);
            });
            
            // –¢–∞–±–ª–∏—Ü—ã: –æ–±—Ä–∞–±–æ—Ç–∫–∞ Markdown —Ç–∞–±–ª–∏—Ü (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ –∑–∞–º–µ–Ω—ã –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫)
            const tableBlocks = [];
            // –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—ã: —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, —Å—Ç—Ä–æ–∫–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º, —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            const tableRegex = /(\|[^\n]+\|\n\|[-\s|:]+\|\n(?:\|[^\n]+\|\n?)+)/g;
            html = html.replace(tableRegex, (match) => {
                const id = `TABLE_${tableBlocks.length}`;
                
                // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —Å—Ç—Ä–æ–∫–∏
                const lines = match.trim().split('\n');
                if (lines.length < 2) {
                    return match; // –ù–µ —Ç–∞–±–ª–∏—Ü–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
                }
                
                // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const headerCells = lines[0].split('|').map(cell => cell.trim()).filter(cell => cell);
                
                // –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ - —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–∏
                const separatorLine = lines[1];
                const separatorCells = separatorLine.split('|').map(cell => cell.trim()).filter(cell => cell);
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –∏–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
                const getAlignment = (separator) => {
                    if (!separator) return 'left';
                    separator = separator.trim();
                    if (separator.startsWith(':') && separator.endsWith(':')) {
                        return 'center';
                    } else if (separator.endsWith(':')) {
                        return 'right';
                    } else {
                        return 'left';
                    }
                };
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏
                const alignments = separatorCells.map(sep => getAlignment(sep));
                
                let headerHTML = '<thead><tr>';
                headerCells.forEach((cell, index) => {
                    const align = alignments[index] || 'left';
                    const style = align === 'right' ? 'text-align: right;' : align === 'center' ? 'text-align: center;' : 'text-align: left;';
                    headerHTML += `<th class="markdown-table-th" style="${style}">${cell}</th>`;
                });
                headerHTML += '</tr></thead>';
                
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–Ω–∞—á–∏–Ω–∞—è —Å 3-–π, —Ç–∞–∫ –∫–∞–∫ 2-—è - —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
                let bodyHTML = '<tbody>';
                for (let i = 2; i < lines.length; i++) {
                    const cells = lines[i].split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.length > 0) {
                        bodyHTML += '<tr>';
                        cells.forEach((cell, index) => {
                            const align = alignments[index] || 'left';
                            const style = align === 'right' ? 'text-align: right;' : align === 'center' ? 'text-align: center;' : 'text-align: left;';
                            bodyHTML += `<td class="markdown-table-td" style="${style}">${cell}</td>`;
                        });
                        bodyHTML += '</tr>';
                    }
                }
                bodyHTML += '</tbody>';
                
                tableBlocks.push(`<table class="markdown-table">${headerHTML}${bodyHTML}</table>`);
                return id;
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
            tableBlocks.forEach((table, index) => {
                html = html.replace(`TABLE_${index}`, table);
            });
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTML
            if (chartBlocks.length > 0) {
                setTimeout(() => {
                    chartBlocks.forEach((chartBlock) => {
                        const containerId = `chart_container_${chartBlock.id}`;
                        const container = document.getElementById(containerId);
                        if (container) {
                            container.classList.remove('loading');
                            
                            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
                            if (!chartBlock.data || !chartBlock.data.labels || !chartBlock.data.data) {
                                container.classList.add('error');
                                container.innerHTML = '–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞';
                                return;
                            }
                            
                            if (chartBlock.data.labels.length === 0 || chartBlock.data.data.length === 0) {
                                container.classList.add('error');
                                container.innerHTML = '–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                                return;
                            }
                            
                            renderChart(chartBlock.type, chartBlock.data, containerId).catch(error => {
                                console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                                container.classList.add('error');
                                container.innerHTML = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ${error.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                            });
                        }
                    });
                }, 100);
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
            const hasTable = html.includes('<table');
            
            if (hasTable) {
                // –†–∞–∑–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ —á–∞—Å—Ç–∏: –¥–æ —Ç–∞–±–ª–∏—Ü—ã, —Ç–∞–±–ª–∏—Ü—ã, –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã
                const parts = [];
                let currentText = '';
                let inTable = false;
                let tableContent = '';
                let tableDepth = 0;
                
                // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ —Ç–∞–±–ª–∏—Ü
                const lines = html.split(/(<table[^>]*>[\s\S]*?<\/table>)/g);
                const result = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.trim().startsWith('<table')) {
                        // –≠—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ –æ–±–µ—Ä—Ç–∫–∏
                        result.push(line);
                    } else if (line.trim()) {
                        // –≠—Ç–æ —Ç–µ–∫—Å—Ç - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                        const processedText = line.replace(/\n/g, '<br>');
                        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø—É—Å—Ç–æ
                        if (processedText.trim()) {
                            result.push('<p class="markdown-paragraph">' + processedText + '</p>');
                        }
                    }
                }
                
                html = result.join('');
            } else {
                // –ù–µ—Ç —Ç–∞–±–ª–∏—Ü - –æ–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
                html = html.replace(/\n/g, '<br>');
                if (!html.match(/^<(h[1-6]|ul|ol|pre|p|table)/)) {
                    html = '<p class="markdown-paragraph">' + html + '</p>';
                }
            }
            
            return html;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
        function addMessageToUI(text, isUser, files = null, filesData = null, autoScroll = true, messageIndex = -1) {
            const messagesArea = document.getElementById('chatMessages');
            const welcomeDiv = document.getElementById('chatWelcome');
            const capabilityMessages = document.getElementById('chatCapabilityMessages');
            
            if (welcomeDiv) {
                welcomeDiv.remove();
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (capabilityMessages) {
                capabilityMessages.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'chat-message-user' : 'chat-message-ai'}`;
            if (messageIndex >= 0) {
                messageDiv.setAttribute('data-message-index', messageIndex);
            }
            
            let filesHTML = '';
            if (files && files.length > 0) {
                filesHTML = '<div class="chat-message-files">';
                files.forEach((file, index) => {
                    const fileData = filesData && filesData[index] ? filesData[index] : null;
                    if (fileData && fileData.data) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏)
                        if (file.type.startsWith('image/')) {
                            filesHTML += `<div class="chat-message-file"><img src="${fileData.data}" alt="${file.name}" class="chat-message-file-image"></div>`;
                        } else {
                            filesHTML += `<div class="chat-message-file"><a href="${fileData.data}" download="${file.name}" class="chat-message-file-link">üìé ${file.name} (${formatFileSize(file.size)})</a></div>`;
                        }
                    } else {
                        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                        if (file.type.startsWith('image/')) {
                            filesHTML += `<div class="chat-message-file"><div class="chat-message-file-placeholder">üñºÔ∏è ${file.name} (${formatFileSize(file.size)})</div></div>`;
                        } else {
                            filesHTML += `<div class="chat-message-file"><div class="chat-message-file-placeholder">üìé ${file.name} (${formatFileSize(file.size)})</div></div>`;
                        }
                    }
                });
                filesHTML += '</div>';
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º markdown –≤ HTML —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π AI
            const formattedText = isUser ? text : markdownToHTML(text);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (Markdown) –∏ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω—ã–π HTML
            const hasTableInText = hasTable(text);
            const hasTableInHTML = formattedText && (formattedText.includes('<table') || formattedText.includes('markdown-table'));
            const messageHasTable = hasTableInText || hasTableInHTML;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
            const hasChartInText = text && (text.includes('[CHART_') || text.includes('[CHART:'));
            const hasChartInHTML = formattedText && formattedText.includes('chart-container');
            const messageHasChart = hasChartInText || hasChartInHTML;
            
            // –ö–Ω–æ–ø–∫–∞ CSV –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ –ò–õ–ò –≥—Ä–∞—Ñ–∏–∫
            const canExportCSV = messageHasTable || messageHasChart;
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
            if (messageHasTable || messageHasChart) {
                console.log('–ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è CSV —ç–∫—Å–ø–æ—Ä—Ç–∞:', { 
                    messageIndex, 
                    hasTable: messageHasTable,
                    hasChart: messageHasChart,
                    hasTableInText, 
                    hasTableInHTML,
                    hasChartInText,
                    hasChartInHTML
                });
            }
            
            // –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π AI, –Ω–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let exportButtons = '';
            if (!isUser) {
                // –ö–Ω–æ–ø–∫–∞ CSV –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫
                const csvButton = canExportCSV ? 
                    `<button onclick="exportMessageCSV(${messageIndex})" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV" style="padding: 4px 8px; background: #d3d3d3; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px;"><img src="{% static 'images/csv.png' %}" alt="CSV" style="width: 16px; height: 16px;"> CSV</button>` : 
                    '';
                
                // –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–¥ –∫–∞–∂–¥—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                exportButtons = `
                    <div class="chat-message-actions" style="display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; opacity: 0; transition: opacity 0.2s;">
                        <button onclick="exportMessageDOCX(${messageIndex})" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ DOCX" style="padding: 4px 8px; background: #d3d3d3; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px;"><img src="{% static 'images/txt.png' %}" alt="DOCX" style="width: 16px; height: 16px;"> DOCX</button>
                        ${csvButton}
                        <button onclick="exportMessagePNG(${messageIndex})" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ PNG" style="padding: 4px 8px; background: #d3d3d3; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px;"><img src="{% static 'images/png.png' %}" alt="PNG" style="width: 16px; height: 16px;"> PNG</button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="chat-message-content" style="position: relative;">
                    ${formattedText ? `<div class="chat-message-text">${formattedText}</div>` : ''}
                    ${filesHTML}
                    ${exportButtons}
                </div>
            `;
            
            // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤–æ–∫—Ä—É–≥ —Ç–∞–±–ª–∏—Ü –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            setTimeout(() => {
                const messageTextDiv = messageDiv.querySelector('.chat-message-text');
                if (messageTextDiv) {
                    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
                    const tables = messageTextDiv.querySelectorAll('table.markdown-table, table');
                    tables.forEach(table => {
                        // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (p, div –∏ —Ç.–¥.)
                        let parent = table.parentElement;
                        const originalParent = parent;
                        
                        // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –æ–±–µ—Ä–Ω—É—Ç–∞ –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ –∏–ª–∏ div, –ø–æ–¥–Ω–∏–º–∞–µ–º –µ—ë –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ
                        if (parent && (parent.tagName === 'P' || (parent.tagName === 'DIV' && parent.classList.contains('markdown-paragraph')))) {
                            const grandParent = parent.parentElement;
                            if (grandParent) {
                                // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–µ—Ä–µ–¥ —Ä–æ–¥–∏—Ç–µ–ª–µ–º
                                grandParent.insertBefore(table, parent);
                                // –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ–ø–µ—Ä—å –ø—É—Å—Ç, —É–¥–∞–ª—è–µ–º –µ–≥–æ
                                if (originalParent && (!originalParent.textContent || originalParent.textContent.trim() === '')) {
                                    originalParent.remove();
                                }
                            }
                        }
                    });
                }
            }, 10);
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞)
            if (!canExportCSV && messageIndex >= 0 && !isUser) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω–æ–º HTML
                setTimeout(() => {
                    const messageTextDiv = messageDiv.querySelector('.chat-message-text');
                    let foundTable = false;
                    let foundChart = false;
                    
                    if (messageTextDiv) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã
                        const tables = messageTextDiv.querySelectorAll('table.markdown-table, table');
                        if (tables.length > 0) {
                            foundTable = true;
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                    const chartContainers = messageDiv.querySelectorAll('.chart-container');
                    if (chartContainers.length > 0) {
                        foundChart = true;
                    }
                    
                    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É CSV
                    if (foundTable || foundChart) {
                            const actionsDiv = messageDiv.querySelector('.chat-message-actions');
                            if (actionsDiv && !actionsDiv.querySelector('button[onclick*="exportMessageCSV"]')) {
                                const csvBtn = document.createElement('button');
                                csvBtn.onclick = () => exportMessageCSV(messageIndex);
                                csvBtn.title = '–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV';
                                csvBtn.style.cssText = 'padding: 4px 8px; background: #d3d3d3; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px;';
                                const csvImg = document.createElement('img');
                                csvImg.src = IMAGE_PATHS.csv;
                                csvImg.alt = 'CSV';
                                csvImg.style.cssText = 'width: 16px; height: 16px;';
                                csvBtn.appendChild(csvImg);
                                csvBtn.appendChild(document.createTextNode(' CSV'));
                                
                                // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π PNG
                                const pngBtn = actionsDiv.querySelector('button[onclick*="exportMessagePNG"]');
                                if (pngBtn) {
                                    actionsDiv.insertBefore(csvBtn, pngBtn);
                                } else {
                                    actionsDiv.appendChild(csvBtn);
                                }
                            }
                        }
                }, 500);
            }
            messagesArea.appendChild(messageDiv);
            
            // –£–¥–∞–ª—è–µ–º –Ω–∞–¥–ø–∏—Å—å "markdown" –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            setTimeout(() => {
                const messageTextDiv = messageDiv.querySelector('.chat-message-text');
                if (messageTextDiv) {
                    // –ò—â–µ–º –∏ —É–¥–∞–ª—è–µ–º –ª—é–±—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å —Ç–µ–∫—Å—Ç–æ–º "markdown"
                    const allElements = messageTextDiv.querySelectorAll('*');
                    allElements.forEach(el => {
                        if (el.textContent && el.textContent.trim().toLowerCase() === 'markdown') {
                            el.remove();
                        }
                    });
                    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —É–∑–ª—ã
                    const walker = document.createTreeWalker(
                        messageTextDiv,
                        NodeFilter.SHOW_TEXT,
                        null,
                        false
                    );
                    let node;
                    while (node = walker.nextNode()) {
                        if (node.textContent && node.textContent.trim().toLowerCase() === 'markdown') {
                            node.parentNode.removeChild(node);
                        }
                    }
                }
            }, 50);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            const actionsDiv = messageDiv.querySelector('.chat-message-actions');
            if (actionsDiv) {
                messageDiv.addEventListener('mouseenter', () => {
                    actionsDiv.style.opacity = '1';
                });
                messageDiv.addEventListener('mouseleave', () => {
                    actionsDiv.style.opacity = '0';
                });
            }
            
            // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (autoScroll) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º DOM
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        scrollToBottomMessages(true);
                    });
                });
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (50ms, 200ms)
                setTimeout(() => {
                    scrollToBottomMessages(true);
                }, 50);
                setTimeout(() => {
                    scrollToBottomMessages(true);
                }, 200);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
        function renderChatHistory() {
            const historySection = document.getElementById('chatHistorySection');
            if (!historySection) return;
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ–∫—Ü–∏–∏
            historySection.innerHTML = '';

            let filteredChats = chats;

            // –§–∏–ª—å—Ç—Ä –ø–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–º—É
            if (showFavoritesOnly) {
                filteredChats = chats.filter(chat => favorites.includes(chat.id) || pinnedChats.includes(chat.id));
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
            if (searchQuery.trim()) {
                filteredChats = filteredChats.filter(chat => 
                    chat.title.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }

            // –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            if (showFavoritesOnly) {
                if (filteredChats.length > 0) {
                    renderChatSection(historySection, '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', filteredChats);
                }
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —á–∞—Ç–æ–≤ –ø–æ –¥–∞—Ç–∞–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayChats = [];
            const yesterdayChats = [];
            const weekAgoChats = [];
            const monthAgoChats = [];

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞
            filteredChats.forEach(chat => {
                let chatDate;
                if (chat.messages && chat.messages.length > 0) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    chatDate = new Date(lastMessage.timestamp);
                } else {
                    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è
                    chatDate = new Date(chat.createdAt);
                }
                chatDate.setHours(0, 0, 0, 0);
                const diffDays = Math.floor((today - chatDate) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    todayChats.push(chat);
                } else if (diffDays === 1) {
                    yesterdayChats.push(chat);
                } else if (diffDays <= 7) {
                    weekAgoChats.push(chat);
                } else if (diffDays <= 30) {
                    monthAgoChats.push(chat);
                }
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —á–∞—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –¥–∞—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            const sortChatsByLastMessage = (chatsArray) => {
                return chatsArray.sort((a, b) => {
                    // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ
                    const aPinned = pinnedChats.includes(a.id);
                    const bPinned = pinnedChats.includes(b.id);
                    if (aPinned && !bPinned) return -1;
                    if (!aPinned && bPinned) return 1;
                    
                    // –ó–∞—Ç–µ–º –ø–æ –¥–∞—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    let aDate, bDate;
                    if (a.messages && a.messages.length > 0) {
                        aDate = new Date(a.messages[a.messages.length - 1].timestamp);
                    } else {
                        aDate = new Date(a.createdAt);
                    }
                    if (b.messages && b.messages.length > 0) {
                        bDate = new Date(b.messages[b.messages.length - 1].timestamp);
                    } else {
                        bDate = new Date(b.createdAt);
                    }
                    return bDate - aDate; // –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
                });
            };

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–µ–∫—Ü–∏–π –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
            if (todayChats.length > 0) {
                renderChatSection(historySection, '—Å–µ–≥–æ–¥–Ω—è', sortChatsByLastMessage(todayChats));
            }
            if (yesterdayChats.length > 0) {
                renderChatSection(historySection, '–≤—á–µ—Ä–∞', sortChatsByLastMessage(yesterdayChats));
            }
            if (weekAgoChats.length > 0) {
                renderChatSection(historySection, '7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥', sortChatsByLastMessage(weekAgoChats));
            }
            if (monthAgoChats.length > 0) {
                renderChatSection(historySection, '30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥', sortChatsByLastMessage(monthAgoChats));
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–µ–∫—Ü–∏–∏ —á–∞—Ç–æ–≤
        function renderChatSection(container, title, chats) {
            const section = document.createElement('div');
            section.className = 'chat-history-section';
            section.innerHTML = `
                <div class="chat-history-title">${title}</div>
                <div class="chat-history-items"></div>
            `;
            const itemsContainer = section.querySelector('.chat-history-items');
            
            // –ß–∞—Ç—ã —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ renderChatHistory, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
            const sortedChats = chats;
            
            sortedChats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'chat-history-item';
                item.dataset.chatId = chat.id;
                if (chat.id === currentChatId) {
                    item.classList.add('active');
                }
                // –£–±—Ä–∞–ª–∏ –∫–ª–∞—Å—Å pinned, —Ç–∞–∫ –∫–∞–∫ –∫—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
                
                const isPinned = pinnedChats.includes(chat.id);
                const isFavorite = favorites.includes(chat.id);
                
                item.innerHTML = `
                    <div class="chat-history-item-content">
                        <span class="chat-history-item-title">${chat.title}</span>
                        <div class="chat-history-item-actions">
                            <div class="chat-actions-menu-wrapper">
                                <button class="chat-actions-menu-btn" data-chat-id="${chat.id}" title="–î–µ–π—Å—Ç–≤–∏—è">
                                    <img src="${IMAGE_PATHS.red}" alt="–î–µ–π—Å—Ç–≤–∏—è" class="chat-action-icon">
                                </button>
                                <div class="chat-actions-menu-dropdown" data-chat-id="${chat.id}" style="display: none;">
                                    <button class="chat-action-menu-item" data-action="favorite" data-chat-id="${chat.id}" title="${isFavorite ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">
                                        <img src="${IMAGE_PATHS.iznr}" alt="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" class="chat-action-menu-icon">
                                        <span>${isFavorite ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}</span>
                                    </button>
                                    <button class="chat-action-menu-item" data-action="pin" data-chat-id="${chat.id}" title="${isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å'}">
                                        <img src="${IMAGE_PATHS.zakrep2}" alt="${isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å'}" class="chat-action-menu-icon">
                                        <span>${isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å'}</span>
                                    </button>
                                    <button class="chat-action-menu-item" data-action="edit" data-chat-id="${chat.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <img src="${IMAGE_PATHS.red}" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="chat-action-menu-icon">
                                        <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                                    </button>
                                    <button class="chat-action-menu-item" data-action="delete" data-chat-id="${chat.id}" title="–£–¥–∞–ª–∏—Ç—å">
                                        <img src="${IMAGE_PATHS.udalit}" alt="–£–¥–∞–ª–∏—Ç—å" class="chat-action-menu-icon">
                                        <span>–£–¥–∞–ª–∏—Ç—å</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.chat-actions-menu-wrapper')) {
                        loadChat(chat.id);
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
                const menuBtn = item.querySelector('.chat-actions-menu-btn');
                const dropdown = item.querySelector('.chat-actions-menu-dropdown');
                
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω—é
                    document.querySelectorAll('.chat-actions-menu-dropdown').forEach(menu => {
                        if (menu !== dropdown) {
                            menu.style.display = 'none';
                        }
                    });
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ–Ω—é
                    if (dropdown.style.display === 'none' || !dropdown.style.display) {
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.style.display = 'none';
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
                const menuItems = item.querySelectorAll('.chat-action-menu-item');
                menuItems.forEach(menuItem => {
                    menuItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = menuItem.dataset.action;
                        dropdown.style.display = 'none';
                        
                        if (action === 'favorite') {
                            toggleFavorite(chat.id);
                        } else if (action === 'pin') {
                            togglePin(chat.id);
                        } else if (action === 'edit') {
                            editChatTitle(chat.id);
                        } else if (action === 'delete') {
                            deleteChat(chat.id);
                        }
                    });
                });
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –æ–¥–∏–Ω —Ä–∞–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ)
                
                itemsContainer.appendChild(item);
            });
            
            container.appendChild(section);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
        function togglePin(chatId) {
            const index = pinnedChats.indexOf(chatId);
            if (index > -1) {
                pinnedChats.splice(index, 1);
                // –£–±–∏—Ä–∞–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–∏
                const favIndex = favorites.indexOf(chatId);
                if (favIndex > -1) {
                    favorites.splice(favIndex, 1);
                    saveUserFavorites(favorites);
                }
            } else {
                pinnedChats.push(chatId);
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–∏
                if (!favorites.includes(chatId)) {
                    favorites.push(chatId);
                    saveUserFavorites(favorites);
                }
            }
            saveUserPinnedChats(pinnedChats);
            renderChatHistory();
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞
        let editingChatId = null;

        function editChatTitle(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            editingChatId = chatId;
            document.getElementById('editChatTitleInput').value = chat.title;
            document.getElementById('editChatModal').style.display = 'flex';
        }

        function closeEditChatModal() {
            document.getElementById('editChatModal').style.display = 'none';
            editingChatId = null;
            document.getElementById('editChatTitleInput').value = '';
        }

        document.getElementById('saveEditChatBtn').addEventListener('click', () => {
            if (editingChatId) {
                const newTitle = document.getElementById('editChatTitleInput').value.trim();
                const chat = chats.find(c => c.id === editingChatId);
                if (chat && newTitle && newTitle !== chat.title) {
                    chat.title = newTitle;
                    saveChats();
                    renderChatHistory();
                    if (currentChatId === editingChatId) {
                        loadChat(editingChatId);
                    }
                }
                closeEditChatModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('editChatModal').addEventListener('click', (e) => {
            if (e.target.id === 'editChatModal') {
                closeEditChatModal();
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ Enter –≤ –ø–æ–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('editChatTitleInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('saveEditChatBtn').click();
            }
        });

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        let confirmCallback = null;

        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'flex';
            confirmCallback = callback;
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }

        document.getElementById('confirmBtn').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
                closeConfirmModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('confirmModal').addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') {
                closeConfirmModal();
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
        function deleteChat(chatId) {
            showConfirmModal('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?', () => {
                const chatIndex = chats.findIndex(c => c.id === chatId);
                if (chatIndex > -1) {
                    chats.splice(chatIndex, 1);
                    saveChats();

                    // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö
                    const favIndex = favorites.indexOf(chatId);
                    if (favIndex > -1) {
                        favorites.splice(favIndex, 1);
                        saveUserFavorites(favorites);
                    }
                    const pinIndex = pinnedChats.indexOf(chatId);
                    if (pinIndex > -1) {
                        pinnedChats.splice(pinIndex, 1);
                        saveUserPinnedChats(pinnedChats);
                    }

                    // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â–∏–π —á–∞—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–≥–æ–π –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                    if (currentChatId === chatId) {
                        if (chats.length > 0) {
                            loadChat(chats[0].id);
                        } else {
                            currentChatId = null;
                            renderCapabilityMessages();
                        }
                    }

                    renderChatHistory();
                }
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        function toggleFavorite(chatId) {
            const index = favorites.indexOf(chatId);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(chatId);
            }
            saveUserFavorites(favorites);
            renderChatHistory();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
        function updateActiveChat() {
            document.querySelectorAll('.chat-history-item').forEach(item => {
                item.classList.remove('active');
            });
            if (currentChatId) {
                const activeItem = document.querySelector(`[data-chat-id="${currentChatId}"]`)?.closest('.chat-history-item');
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
        function handleFileAttach() {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB –Ω–∞ —Ñ–∞–π–ª
                const MAX_TOTAL_SIZE = 40 * 1024 * 1024; // 40 MB –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä
                
                let totalSize = attachedFiles.reduce((sum, f) => sum + f.size, 0);
                const rejectedFiles = [];
                
                files.forEach(file => {
                    if (file.size > MAX_FILE_SIZE) {
                        rejectedFiles.push(`${file.name} (${formatFileSize(file.size)})`);
                    } else if (totalSize + file.size > MAX_TOTAL_SIZE) {
                        rejectedFiles.push(`${file.name} (–ø—Ä–µ–≤—ã—à–µ–Ω –æ–±—â–∏–π –ª–∏–º–∏—Ç)`);
                    } else {
                        attachedFiles.push({
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            file: file
                        });
                        totalSize += file.size;
                    }
                });
                
                if (rejectedFiles.length > 0) {
                    showWarning(`–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã:\n\n${rejectedFiles.join('\n')}\n\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${formatFileSize(MAX_FILE_SIZE)}\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä: ${formatFileSize(MAX_TOTAL_SIZE)}`);
                }
                
                renderAttachedFiles();
                // –°–±—Ä–æ—Å input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
                e.target.value = '';
            }
        });

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        function renderAttachedFiles() {
            const attachedFilesDiv = document.getElementById('attachedFiles');
            if (attachedFiles.length === 0) {
                attachedFilesDiv.style.display = 'none';
                return;
            }

            attachedFilesDiv.style.display = 'block';
            attachedFilesDiv.innerHTML = attachedFiles.map((file, index) => `
                <div class="attached-file-item">
                    <span class="attached-file-name">${file.name}</span>
                    <span class="attached-file-size">${formatFileSize(file.size)}</span>
                    <button type="button" class="attached-file-remove" onclick="removeAttachedFile(${index})">√ó</button>
                </div>
            `).join('');
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è onclick)
        window.removeAttachedFile = function(index) {
            if (attachedFiles && attachedFiles.length > index) {
                attachedFiles.splice(index, 1);
                renderAttachedFiles();
                // –°–±—Ä–æ—Å input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
                document.getElementById('fileInput').value = '';
            }
        };

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        function toggleFavoritesMode() {
            showFavoritesOnly = !showFavoritesOnly;
            const favoritesBtn = document.getElementById('favoritesBtn');
            if (showFavoritesOnly) {
                favoritesBtn.classList.add('active');
            } else {
                favoritesBtn.classList.remove('active');
            }
            renderChatHistory();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
        function handleSearch() {
            searchQuery = document.getElementById('chatSearchInput').value;
            renderChatHistory();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('attachBtn').addEventListener('click', handleFileAttach);
        document.getElementById('chatSendBtn').addEventListener('click', sendMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        document.querySelector('.chat-new-chat-btn').addEventListener('click', createNewChat);
        document.getElementById('favoritesBtn').addEventListener('click', toggleFavoritesMode);
        document.getElementById('chatSearchInput').addEventListener('input', handleSearch);

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã –≤ —á–∞—Ç–µ
        function toggleChatTheme() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è CSS –∫–ª–∞—Å—Å–æ–≤ body –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏–∫–æ–Ω–æ–∫
            setTimeout(() => {
                updateThemeButtonText();
            }, 50);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ —Ç–µ–º—ã –∏ –∏–∫–æ–Ω–æ–∫
        function updateThemeButtonText() {
            const theme = localStorage.getItem('theme') || 'light';
            const themeBtnText = document.getElementById('chatThemeBtnText');
            const themeIconLight = document.getElementById('chatThemeIconLight');
            const themeIconDark = document.getElementById('chatThemeIconDark');
            
            if (themeBtnText) {
                themeBtnText.textContent = theme === 'dark' ? '–¢–µ–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è';
            }
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏–∫–æ–Ω–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º !important –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è CSS –ø—Ä–∞–≤–∏–ª —Å–≤–µ—Ä–Ω—É—Ç–æ–π –ø–∞–Ω–µ–ª–∏
            if (themeIconLight && themeIconDark) {
                if (theme === 'dark') {
                    // –í —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –ª—É–Ω—ã (—Ç–µ–º–Ω–∞—è —Ç–µ–º–∞)
                    themeIconLight.style.setProperty('display', 'none', 'important');
                    themeIconDark.style.setProperty('display', 'block', 'important');
                } else {
                    // –í —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É —Å–æ–ª–Ω—Ü–∞ (—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞)
                    themeIconLight.style.setProperty('display', 'block', 'important');
                    themeIconDark.style.setProperty('display', 'none', 'important');
                }
            }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        }



        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        setInterval(() => {
            renderChatHistory();
        }, 60000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        cleanupOldFileData();
        initChat();
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.chat-actions-menu-wrapper')) {
                document.querySelectorAll('.chat-actions-menu-dropdown').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        updateThemeButtonText();
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ overlay (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –µ–≥–æ —É–¥–∞–ª–∏—Ç—å)
        let overlayClickHandler = null;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        function toggleChatSidebar() {
            const sidebar = document.getElementById('chatSidebar');
            const overlay = document.getElementById('chatSidebarOverlay');
            const burgerBtn = document.getElementById('chatBurgerBtn');
            
            if (sidebar && overlay && burgerBtn) {
                const isOpen = sidebar.classList.contains('chat-sidebar-open');
                if (isOpen) {
                    sidebar.classList.remove('chat-sidebar-open');
                    overlay.classList.remove('chat-sidebar-overlay-active');
                    burgerBtn.classList.remove('chat-burger-active');
                } else {
                    sidebar.classList.add('chat-sidebar-open');
                    overlay.classList.add('chat-sidebar-overlay-active');
                    burgerBtn.classList.add('chat-burger-active');
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∞–π–¥–±–∞—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π –∫—Ä–µ—Å—Ç–∏–∫–∞)
        function closeChatSidebar(event) {
            // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è
            if (event) {
                event.stopPropagation();
                event.preventDefault();
                event.stopImmediatePropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            }
            
            const sidebar = document.getElementById('chatSidebar');
            const overlay = document.getElementById('chatSidebarOverlay');
            const burgerBtn = document.getElementById('chatBurgerBtn');
            
            if (!sidebar || !overlay || !burgerBtn) {
                return;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            sidebar.classList.remove('chat-sidebar-open');
            overlay.classList.remove('chat-sidebar-overlay-active');
            burgerBtn.classList.remove('chat-burger-active');
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º pointer-events —É overlay, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –∫–ª–∏–∫–∏
            overlay.style.pointerEvents = 'none';
            setTimeout(() => {
                overlay.style.pointerEvents = '';
            }, 300);
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
        window.closeChatSidebar = closeChatSidebar;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ overlay —á–µ—Ä–µ–∑ addEventListener (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM)
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('chatSidebarOverlay');
            const sidebar = document.getElementById('chatSidebar');
            
            if (overlay && sidebar) {
                // –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–µ–≥–æ
                overlayClickHandler = function(event) {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –∏–º–µ–Ω–Ω–æ –ø–æ overlay (–Ω–µ –ø–æ sidebar)
                    const sidebar = document.getElementById('chatSidebar');
                    if (event.target === overlay && sidebar && sidebar.classList.contains('chat-sidebar-open')) {
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ sidebar –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–µ–ª—å –∫–ª–∏–∫–∞
                        if (!sidebar.contains(event.target)) {
                            toggleChatSidebar();
                        }
                    }
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                overlay.addEventListener('click', overlayClickHandler);
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ –∫–ª–∏–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ sidebar, –Ω–æ –ù–ï –Ω–∞ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è –∏ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π
                sidebar.addEventListener('click', function(event) {
                    // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ, –µ—Å–ª–∏ –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π
                    const closeBtn = event.target.closest('#chatSidebarCloseBtn');
                    const actionsMenuWrapper = event.target.closest('.chat-actions-menu-wrapper');
                    
                    if (!closeBtn && !actionsMenuWrapper) {
                        event.stopPropagation();
                    }
                });
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ—Ä–µ–∑ addEventListener
                const closeBtn = document.getElementById('chatSidebarCloseBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(event) {
                        event.stopPropagation();
                        event.preventDefault();
                        event.stopImmediatePropagation();
                        closeChatSidebar(event);
                    }, true); // useCapture: true –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –≤ —Ñ–∞–∑–µ –∑–∞—Ö–≤–∞—Ç–∞
                }
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞)
        function toggleSidebarCollapse() {
            // –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            if (window.innerWidth <= 768) {
                return;
            }
            
            const sidebar = document.getElementById('chatSidebar');
            if (!sidebar) return;
            
            const isCollapsed = sidebar.classList.contains('chat-sidebar-collapsed');
            
            if (isCollapsed) {
                // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                sidebar.classList.remove('chat-sidebar-collapsed');
                localStorage.setItem('chatSidebarCollapsed', 'false');
            } else {
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                sidebar.classList.add('chat-sidebar-collapsed');
                localStorage.setItem('chatSidebarCollapsed', 'true');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞ –æ–±–ª–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã—Å–æ—Ç—ã –ø–æ–ª—è –≤–≤–æ–¥–∞
        function updateMessagesAreaPadding() {
            const inputWrapper = document.querySelector('.chat-input-wrapper');
            const messagesArea = document.getElementById('chatMessages');
            
            if (!inputWrapper || !messagesArea) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–ª—è –≤–≤–æ–¥–∞
            const inputHeight = inputWrapper.offsetHeight;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø (20px) –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
            const paddingBottom = inputHeight + 20;
            
            messagesArea.style.paddingBottom = `${paddingBottom}px`;
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫—É –≤ —Å–∞–π–¥–±–∞—Ä–µ (–Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö)
        document.addEventListener('DOMContentLoaded', function() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–∞ –æ–±–ª–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            updateMessagesAreaPadding();
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            // –¢–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('chatSidebar');
                const savedState = localStorage.getItem('chatSidebarCollapsed');
                
                if (sidebar && savedState === 'true') {
                    sidebar.classList.add('chat-sidebar-collapsed');
                }
            }
            
            const sidebarLinks = document.querySelectorAll('.chat-sidebar a, .chat-sidebar button');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function() {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
                    setTimeout(() => {
                        if (window.innerWidth <= 768) {
                            toggleChatSidebar();
                        }
                    }, 100);
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                    updateMessagesAreaPadding();
                    
                    const sidebar = document.getElementById('chatSidebar');
                    const overlay = document.getElementById('chatSidebarOverlay');
                    const burgerBtn = document.getElementById('chatBurgerBtn');
                    
                    if (window.innerWidth > 768) {
                        // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ - —É–±–∏—Ä–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    if (sidebar && overlay && burgerBtn) {
                        sidebar.classList.remove('chat-sidebar-open');
                        overlay.classList.remove('chat-sidebar-overlay-active');
                        burgerBtn.classList.remove('chat-burger-active');
                    }
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ collapsed
                        const savedState = localStorage.getItem('chatSidebarCollapsed');
                        if (sidebar && savedState === 'true') {
                            sidebar.classList.add('chat-sidebar-collapsed');
                        } else if (sidebar) {
                            sidebar.classList.remove('chat-sidebar-collapsed');
                        }
                    } else {
                        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å collapsed
                        if (sidebar) {
                            sidebar.classList.remove('chat-sidebar-collapsed');
                        }
                    }
                }, 250);
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤)
            const inputWrapper = document.querySelector('.chat-input-wrapper');
            if (inputWrapper) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                const observer = new MutationObserver(function(mutations) {
                    updateMessagesAreaPadding();
                });
                
                observer.observe(inputWrapper, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['style', 'class']
                });
                
                // –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —á–µ—Ä–µ–∑ ResizeObserver
                if (window.ResizeObserver) {
                    const resizeObserver = new ResizeObserver(function(entries) {
                        updateMessagesAreaPadding();
                    });
                    
                    resizeObserver.observe(inputWrapper);
                }
            }
        });
    </script>
</body>
</html>

