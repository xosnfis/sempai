# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å threading –≤ Django

## –ü—Ä–æ–±–ª–µ–º–∞
AI –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–ª —Ç–æ–ª—å–∫–æ "–î—É–º–∞—é..." –∏ –Ω–µ –ø–æ–ª—É—á–∞–ª –æ—Ç–≤–µ—Ç—ã. –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ —Å–≤—è–∑–∞–Ω–∞ —Å —Ç–µ–º, –∫–∞–∫ Django –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫–∏ (threading) –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∫ –ë–î –≤ –ø–æ—Ç–æ–∫–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** Django connection pool –Ω–µ thread-safe. –ö–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ç–æ–∫–µ, –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ—à–∏–±–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `close_old_connections()` –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ –ë–î –≤ –ø–æ—Ç–æ–∫–µ:

```python
from django.db import close_old_connections

def process_chat_request_async(request_id):
    close_old_connections()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    # ... —Ä–∞–±–æ—Ç–∞ —Å –ë–î ...
    close_old_connections()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞—â–µ–Ω–∏–µ–º
    chat_request.save()
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Ç–æ–∫ –º–æ–≥ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è, –Ω–æ –æ—à–∏–±–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–ª–∞—Å—å.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ—Ç–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è:

```python
thread.start()
if thread.is_alive():
    logger.info("–ü–æ—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω")
else:
    # –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    ...
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å—ã –º–æ–≥–ª–∏ –∑–∞–≤–∏—Å–Ω—É—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ "processing" –Ω–∞–≤—Å–µ–≥–¥–∞.

**–†–µ—à–µ–Ω–∏–µ:** –í —Ñ—É–Ω–∫—Ü–∏–∏ `chat_status` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç) –∏ –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫:

```python
if time_elapsed > timedelta(minutes=5):
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
    thread = threading.Thread(target=process_chat_request_async, ...)
    thread.start()
```

### 4. –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ 500–º—Å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Django:**
   ```bash
   docker-compose logs -f web | grep -E "üöÄ|‚úÖ|‚ùå|üîÑ"
   ```
   
   –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
   - `üöÄ –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞` - –∑–∞–ø—Ä–æ—Å –Ω–∞—á–∞–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è
   - `‚úÖ –§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω` - –ø–æ—Ç–æ–∫ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
   - `‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ` - –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console
   - –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –ª–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
   - –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –æ—Ç–≤–µ—Ç –æ—Ç AI

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab:**
   - `POST /api/chat/` –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `request_id`
   - `GET /api/chat-status/{request_id}/` –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è
   - –í –∫–æ–Ω—Ü–µ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å `completed` —Å –æ—Ç–≤–µ—Ç–æ–º

## –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á OpenRouter:
```bash
# –í .env —Ñ–∞–π–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
OPENROUTER_API_KEY=your-key-here
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏:
```bash
docker-compose logs web | grep -i error
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≤–∏—Å—à–∏–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –ë–î:
```python
# –í Django shell
from main.models import ChatRequest
from django.utils import timezone
from datetime import timedelta

stuck = ChatRequest.objects.filter(
    status__in=['processing', 'pending'],
    created_at__lt=timezone.now() - timedelta(minutes=5)
)
print(f"–ó–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: {stuck.count()}")
```

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
```python
# –í Django shell
from main.models import ChatRequest
from main.views import process_chat_request_async

stuck = ChatRequest.objects.filter(status='processing')
for req in stuck:
    process_chat_request_async(req.id)
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É threading –Ω–µ —Ä–∞–±–æ—Ç–∞–ª?

1. **Django connection pool:** –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
2. **Daemon –ø–æ—Ç–æ–∫–∏:** –ú–æ–≥—É—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:** –ù–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ—Ç–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ?

1. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ —Å –ë–î –≤ –ø–æ—Ç–æ–∫–∞—Ö
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞
3. ‚úÖ –ú–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
5. ‚úÖ Fallback –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–º–∞–∫—Å–∏–º—É–º 5 –º–∏–Ω—É—Ç)
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

