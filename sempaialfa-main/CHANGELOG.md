# CHANGELOG: Обновление от AlfaAI 1.0 к AlfaAI 2.0

## Версия 2.0 - Обновление на основе комментариев жюри

### Обзор изменений

Данное обновление было выполнено с учетом всех комментариев жюри и направлено на улучшение продукта как AI-ассистента для бизнеса, а не просто интернет-банка.

---

## Критические изменения

### 1. Замена LM Studio на Ollama
**Проблема:** LM Studio в community-версии имеет ограничение «Free for personal and work use», что делает её непригодной для масштабирования в корпоративной среде.

**Решение:**
- Заменен LM Studio на **Ollama** с моделью **deepseek-r1**
- Ollama - полностью открытое решение без лицензионных ограничений
- Поддержка OpenAI-совместимого API для легкой миграции
- Обновлен URL в настройках: `OLLAMA_URL = 'http://host.docker.internal:9117/v1/chat/completions'`
- Добавлена обратная совместимость через `LM_STUDIO_URL = OLLAMA_URL`

**Файлы:**
- `aichat/aichat/settings.py` - обновлены настройки LLM
- `README.md` - обновлена документация по установке Ollama

---

### 2. Усиление контроля над ролевым контекстом
**Проблема:** Помощник выходил из роли, если его об этом просили. Необходимо усилить контроль над ролевым контекстом.

**Решение:**
- Улучшен системный промпт с более жесткими инструкциями
- Добавлена модерация контента для блокировки попыток выхода из роли
- Реализован модуль `content_moderator.py` для фильтрации нежелательных запросов
- Усилены инструкции в системном промпте о сохранении роли AI-ассистента для бизнеса
- Добавлена проверка ответов AI на соответствие роли

**Новые файлы:**
- `aichat/main/content_moderator.py` - модуль модерации контента

**Изменения:**
- `aichat/main/views.py` - улучшен системный промпт, добавлена модерация запросов и ответов

---

### 3. Добавление сценариев использования
**Проблема:** Отсутствуют чётко выделенные сценарии, которые помогали бы бизнесу понять, что именно можно спрашивать у LLM.

**Решение:**
- Создана страница `/scenarios/` с подробными примерами использования
- Добавлен файл `VALUE_DEMO_PROMPT.md` с демосценариями для презентации
- На главной странице добавлены подсказки с примерами запросов
- Реализованы детальные сценарии:
  - Управление складом и инвентаризация
  - Финансовый анализ и планирование
  - Работа с документами
  - Управление календарем
  - Анализ расходов и оптимизация

**Новые файлы:**
- `aichat/templates/main/scenarios.html` - страница сценариев
- `VALUE_DEMO_PROMPT.md` - демосценарии для презентации

**Изменения:**
- `aichat/main/views.py` - добавлена функция `scenarios()`
- `aichat/main/urls.py` - добавлен маршрут `/scenarios/`
- `aichat/templates/main/index.html` - добавлены примеры использования на главной странице
- `aichat/static/css/style.css` - стили для страницы сценариев

---

### 4. Внедрение системы тестирования
**Проблема:** Отсутствуют тесты — их необходимо внедрить для повышения надежности и стабильности системы.

**Решение:**
- Создан полный набор тестов (81 тест)
- Покрытие тестами:
  - Модели данных (ChatRequest, ChatHistory, Metric, ChatRequestMetrics, UserActivity)
  - API endpoints
  - Обработка файлов (PDF, DOCX, XLSX, TXT, изображения)
  - Модерация контента
  - Расчет метрик
  - Утилитарные функции
  - Интеграционные тесты
  - Тесты безопасности и производительности

**Новые файлы:**
- `aichat/main/tests.py` - полный набор тестов (1164+ строк)

**Документация:**
- `TESTING.md` - подробные инструкции по запуску тестов

---

## Новые функции

### 5. Система метрик качества работы AI
**Цель:** Оценка качества, производительности и надежности работы AI-ассистента.

**Реализация:**
- Создана модель `Metric` для хранения агрегированных метрик
- Создана модель `ChatRequestMetrics` для метрик конкретных запросов
- Реализован модуль `metrics_calculator.py` для автоматического расчета метрик
- Категории метрик:
  - Качество ответов (точность, релевантность, полнота)
  - Производительность (время обработки, пропускная способность)
  - Надежность (успешность запросов, частота ошибок)
  - Безопасность (обнаружение вредоносного контента)
  - Пользовательский опыт (удовлетворенность, вовлеченность)
  - Активность пользователей (активность, удержание)

**Новые файлы:**
- `aichat/main/metrics_calculator.py` - расчет метрик
- `METRICS_SETUP.md` - документация по метрикам
- `METRICS.md` - подробное описание метрик

**API endpoints:**
- `GET /api/metrics/` - получение всех метрик за период
- `GET /api/metrics/summary/` - получение сводки метрик
- `POST /api/metrics/calculate/` - принудительный расчет метрик

---

### 6. Расширенная админ-панель
**Цель:** Улучшенное управление системой и мониторинг работы AI.

**Реализация:**
- Кастомный дизайн админ-панели (темная тема с красными акцентами)
- Управление пользователями через Django User модель
- Просмотр метрик в удобном интерфейсе
- Управление запросами к AI с детальной информацией
- История чатов пользователей
- Отслеживание активности пользователей
- Вход администраторов через сайт (`/login/`)

**Новые файлы:**
- `aichat/main/admin.py` - расширенная конфигурация админ-панели
- `aichat/static/admin/css/custom_admin.css` - кастомные стили
- `aichat/templates/admin/` - кастомные шаблоны админ-панели
- `ADMIN_PANEL.md` - документация по админ-панели
- `ADMIN_QUICKSTART.md` - быстрый старт для админ-панели

---

### 7. Асинхронная обработка запросов
**Цель:** Улучшение производительности и пользовательского опыта.

**Реализация:**
- Запросы к AI обрабатываются асинхронно
- Создана модель `ChatRequest` для отслеживания статусов запросов
- API endpoint `/api/chat-status/<request_id>/` для проверки статуса
- Статусы: pending, processing, completed, failed

**Изменения:**
- `aichat/main/views.py` - добавлена функция `process_chat_request_async()`
- `aichat/main/views.py` - добавлена функция `chat_status()`
- `aichat/main/urls.py` - добавлен маршрут для проверки статуса

---

### 8. История чатов и экспорт
**Цель:** Сохранение и управление историей взаимодействий с AI.

**Реализация:**
- Создана модель `ChatHistory` для хранения истории чатов
- Сохранение всех сообщений с метаданными
- Логирование действий AI (создание событий, удаление и т.д.)
- Экспорт истории в форматах: JSON, TXT, DOCX
- Редактирование сообщений в истории

**API endpoints:**
- `GET /api/chat-history/` - получение списка истории чатов
- `GET /api/chat-history/<chat_id>/` - получение детальной истории
- `GET /api/chat-history/<chat_id>/export/<format>/` - экспорт истории
- `POST /api/chat-history/<chat_id>/edit/` - редактирование сообщения
- `POST /api/export-chat-docx/` - прямой экспорт чата в DOCX

---

### 9. Отслеживание активности пользователей
**Цель:** Анализ использования системы и поведения пользователей.

**Реализация:**
- Создана модель `UserActivity` для отслеживания всех действий
- Типы активности: регистрация, вход, запрос в чат, просмотр страницы, использование функций и т.д.
- Сохранение IP-адреса и User-Agent для аналитики

---

### 10. Поддержка PostgreSQL
**Цель:** Готовность к масштабированию и production-использованию.

**Реализация:**
- Добавлена поддержка PostgreSQL через переменные окружения
- Настройка базы данных в `settings.py` с поддержкой SQLite и PostgreSQL
- Docker Compose конфигурация с PostgreSQL
- Документация по настройке базы данных

**Новые файлы:**
- `DOCKER_DATABASE.md` - документация по настройке базы данных
- `docker-compose.yml` - обновлен для поддержки PostgreSQL
- `env.example` - пример переменных окружения

**Изменения:**
- `aichat/aichat/settings.py` - добавлена поддержка PostgreSQL
- `requirements.txt` - добавлен `psycopg2-binary>=2.9.0`

---

## Улучшения существующего функционала

### 11. Улучшенная обработка файлов
- Улучшена обработка PDF, DOCX, XLSX файлов
- Добавлена поддержка большего количества форматов
- Улучшена обработка изображений для vision-моделей

### 12. Улучшенный системный промпт
- Более детальные инструкции для AI
- Улучшенная работа с календарем (JSON формат для UPDATE_EVENT)
- Более четкие инструкции по анализу данных
- Усиленный контроль над ролевым контекстом

### 13. Улучшенная авторизация
- Регистрация и вход через Django User модель
- Автоматическое перенаправление администраторов в админ-панель
- API endpoints для регистрации и входа

**API endpoints:**
- `POST /api/register/` - регистрация нового пользователя
- `POST /api/login/` - авторизация пользователя

### 14. Улучшенное управление календарем
- API endpoint `/api/manage-calendar/` для универсального управления событиями
- Поддержка создания, обновления и удаления событий
- Улучшенный поиск событий по ID или названию

---

## Документация

### Новые документы:
- `METRICS_SETUP.md` - настройка системы метрик
- `METRICS.md` - подробное описание метрик
- `ADMIN_PANEL.md` - документация по админ-панели
- `ADMIN_QUICKSTART.md` - быстрый старт для админ-панели
- `DOCKER_DATABASE.md` - настройка базы данных
- `TESTING.md` - инструкции по тестированию
- `OPENAPI.md` - OpenAPI спецификация
- `OPENAPI_QUICKSTART.md` - быстрый старт по API
- `VALUE_DEMO_PROMPT.md` - демосценарии для презентации
- `POWERSHELL_API.md` - работа с API через PowerShell

### Обновленные документы:
- `README.md` - полностью переработан с учетом всех изменений
- Добавлены примеры использования Ollama
- Добавлена информация о метриках и админ-панели
- Добавлена информация о тестах

---

## Изменения в базе данных

### Новые модели:
1. **ChatRequest** - запросы к AI с отслеживанием статусов
2. **ChatHistory** - история чатов с метаданными
3. **Metric** - агрегированные метрики качества
4. **ChatRequestMetrics** - метрики конкретных запросов
5. **UserActivity** - отслеживание активности пользователей

### Миграции:
- `0001_initial.py` - начальная миграция
- `0002_account_calendarevent_chathistory_document_employee_and_more.py` - базовые модели
- `0003_remove_account_user_remove_calendarevent_user_and_more.py` - очистка моделей
- `0004_metric_chatrequestmetrics.py` - метрики
- `0005_rename_main_chatreq_chat_re_idx_main_chatre_chat_re_525bb1_idx_and_more.py` - индексы
- `0006_alter_metric_category.py` - категории метрик
- `0007_alter_metric_category.py` - обновление категорий
- `0008_useractivity.py` - активность пользователей

---

## Безопасность

### Новые функции безопасности:
- Модерация контента для блокировки нежелательных запросов
- Фильтрация запрещенных слов и паттернов
- Проверка ответов AI на соответствие роли
- Защита от спама
- Ограничение длины сообщений

---

## Статистика изменений

### Новые файлы:
- `aichat/main/content_moderator.py` - модерация контента
- `aichat/main/metrics_calculator.py` - расчет метрик
- `aichat/main/admin.py` - расширенная админ-панель
- `aichat/main/tests.py` - полный набор тестов (1164+ строк)
- `aichat/templates/main/scenarios.html` - страница сценариев
- `aichat/templates/admin/` - кастомные шаблоны админ-панели
- Множество новых документов (см. раздел "Документация")

### Измененные файлы:
- `aichat/aichat/settings.py` - поддержка Ollama и PostgreSQL
- `aichat/main/views.py` - асинхронная обработка, модерация, метрики
- `aichat/main/models.py` - новые модели данных
- `aichat/main/urls.py` - новые API endpoints
- `requirements.txt` - добавлен psycopg2-binary
- `README.md` - полностью переработан

### Новые API endpoints:
- `/api/chat-status/<request_id>/` - проверка статуса запроса
- `/api/register/` - регистрация пользователя
- `/api/login/` - авторизация
- `/api/manage-calendar/` - управление календарем
- `/api/chat-history/` - история чатов
- `/api/metrics/` - метрики
- `/api/metrics/summary/` - сводка метрик
- `/api/metrics/calculate/` - расчет метрик
- `/api/error-log/` - логирование ошибок

### Новые страницы:
- `/scenarios/` - страница сценариев использования

---

## Решение проблем жюри

### Комментарий 1: Смещение акцента на AI-ассистента
- Добавлена страница сценариев использования
- Улучшен системный промпт с фокусом на бизнес-задачи
- Добавлены подсказки и примеры на главной странице
- Создан документ с демосценариями для презентации

### Комментарий 2: Замена LM Studio
- Полностью заменен на Ollama (открытое решение)
- Обновлена документация
- Сохранена обратная совместимость

### Комментарий 3: Усиление контроля над ролевым контекстом
- Реализован модуль модерации контента
- Улучшен системный промпт
- Добавлена проверка ответов AI на соответствие роли

### Комментарий 4: Добавление сценариев использования
- Создана страница `/scenarios/` с детальными примерами
- Добавлены подсказки на главной странице
- Создан документ с демосценариями

### Комментарий 5: Внедрение тестов
- Создан полный набор тестов (81 тест)
- Покрытие всех основных компонентов
- Документация по тестированию

---

## Миграция с AlfaAI 1.0 на AlfaAI 2.0

### Шаги миграции:

1. **Обновление зависимостей:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Установка Ollama:**
   ```bash
   # Скачать Ollama с https://ollama.ai/
   ollama pull deepseek-r1
   ollama serve
   ```

3. **Применение миграций:**
   ```bash
   python manage.py migrate
   ```

4. **Обновление настроек:**
   - Изменить `OLLAMA_URL` в `settings.py` (если необходимо)
   - Настроить PostgreSQL (опционально)

5. **Создание суперпользователя:**
   ```bash
   python manage.py createsuperuser
   ```

6. **Сборка статических файлов:**
   ```bash
   python manage.py collectstatic
   ```

---

## Примечания

- Все изменения обратно совместимы с существующими данными (при использовании SQLite)
- При миграции на PostgreSQL потребуется перенос данных
- Рекомендуется протестировать все функции после обновления
- Документация обновлена для всех новых функций

---

## Авторы

- Тасуев Абдуллах (Продуктовый аналитик)
- Скоринов Антон (UX/UI-дизайнер)
- Николаева Анастасия (Fullstack разработчик)

---

**Дата обновления:** 3.12.2024  
**Версия:** 2.0

